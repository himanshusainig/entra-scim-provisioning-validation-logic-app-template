{
    "definition": {
        "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
        "contentVersion": "1.0.0.0",
        "triggers": {
            "Manual_Recurrence": {
                "recurrence": {
                    "frequency": "Month",
                    "interval": 1
                },
                "evaluatedRecurrence": {
                    "frequency": "Month",
                    "interval": 1
                },
                "type": "Recurrence"
            }
        },
        "actions": {
            "Initialize_Tests": {
                "actions": {
                    "Get_Templates": {
                        "type": "Http",
                        "inputs": {
                            "uri": "https://graph.microsoft.com/beta/servicePrincipals/@{parameters('servicePrincipalId')}/synchronization/templates",
                            "method": "GET",
                            "authentication": {
                                "type": "ManagedServiceIdentity",
                                "audience": "https://graph.microsoft.com/"
                            }
                        }
                    },
                    "List_Existing_Jobs": {
                        "runAfter": {
                            "Get_Templates": [
                                "Succeeded"
                            ]
                        },
                        "type": "Http",
                        "inputs": {
                            "uri": "https://graph.microsoft.com/beta/servicePrincipals/@{parameters('servicePrincipalId')}/synchronization/jobs",
                            "method": "GET",
                            "authentication": {
                                "type": "ManagedServiceIdentity",
                                "audience": "https://graph.microsoft.com/"
                            }
                        }
                    },
                    "Compose_SyncJobId": {
                        "runAfter": {
                            "List_Existing_Jobs": [
                                "Succeeded",
                                "Skipped"
                            ]
                        },
                        "type": "Compose",
                        "inputs": "@{coalesce(first(body('List_Existing_Jobs')?['value'])?['id'])}"
                    },
                    "Get_App_Roles": {
                        "runAfter": {
                            "Compose_SyncJobId": [
                                "Succeeded"
                            ]
                        },
                        "type": "Http",
                        "inputs": {
                            "uri": "https://graph.microsoft.com/beta/servicePrincipals/@{parameters('servicePrincipalId')}?$select=appRoles",
                            "method": "GET",
                            "authentication": {
                                "type": "ManagedServiceIdentity",
                                "audience": "https://graph.microsoft.com/"
                            }
                        }
                    },
                    "Generate_TestNames": {
                        "actions": {
                            "Generate_Test_UserNames": {
                                "type": "Compose",
                                "inputs": {
                                    "createUser": "@{concat('lacreate', substring(guid(),0,8), '@', parameters('testUserDomain'))}",
                                    "updateUser": "@{concat('laupdate', substring(guid(),0,8), '@', parameters('testUserDomain'))}",
                                    "disableUser": "@{concat('ladis', substring(guid(),0,8), '@', parameters('testUserDomain'))}",
                                    "deleteUser": "@{concat('ladel', substring(guid(),0,8), '@', parameters('testUserDomain'))}",
                                    "managerUser": "@{concat('lamgr', substring(guid(),0,8), '@', parameters('testUserDomain'))}",
                                    "managerUserNew": "@{concat('lamgrnew', substring(guid(),0,8), '@', parameters('testUserDomain'))}",
                                    "memberUser1": "@{concat('lamem1', substring(guid(),0,8), '@', parameters('testUserDomain'))}",
                                    "memberUser2": "@{concat('lamem2', substring(guid(),0,8), '@', parameters('testUserDomain'))}",
                                    "index": "@rand(0, sub(length(parameters('defaultUserProperties')), 1))",
                                    "managerUserInitial": "@{concat('lamgrinit', substring(guid(),0,8), '@', parameters('testUserDomain'))}"
                                }
                            },
                            "Generate_Test_GroupNames": {
                                "runAfter": {
                                    "Generate_Test_UserNames": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "Compose",
                                "inputs": {
                                    "createGroup": "@{concat('LACreateGroup-', substring(guid(),0,8))}",
                                    "deleteGroup": "@{concat('LADeleteGroup-', substring(guid(),0,8))}",
                                    "memberGroup": "@{concat('LAMemberGroup-', substring(guid(),0,8))}"
                                }
                            }
                        },
                        "runAfter": {
                            "Get_App_Roles": [
                                "Succeeded"
                            ]
                        },
                        "type": "Scope"
                    }
                },
                "runAfter": {},
                "type": "Scope"
            },
            "Check_Enabled_Tests": {
                "runAfter": {
                    "Initialize_Tests": [
                        "Succeeded"
                    ]
                },
                "type": "Compose",
                "inputs": {
                    "enabledTests": "@parameters('EnabledTests')",
                    "isCreateUserEnabled": "@or(equals(parameters('EnabledTests'), 'All'), equals(parameters('EnabledTests'), 'UserTests'), equals(parameters('EnabledTests'), 'Create_User_Test'))",
                    "isUpdateUserEnabled": "@or(equals(parameters('EnabledTests'), 'All'), equals(parameters('EnabledTests'), 'UserTests'), equals(parameters('EnabledTests'), 'Update_User_Test'))",
                    "isCreateGroupEnabled": "@or(equals(parameters('EnabledTests'), 'All'), equals(parameters('EnabledTests'), 'GroupTests'), equals(parameters('EnabledTests'), 'Create_Group_Test'))"
                }
            },
            "Evaluate_Test_Results": {
                "runAfter": {
                    "UserTests_Scope": [
                        "Succeeded",
                        "Failed",
                        "Skipped",
                        "TimedOut"
                    ],
                    "GroupTests_Scope": [
                        "Succeeded",
                        "Failed",
                        "Skipped",
                        "TimedOut"
                    ]
                },
                "type": "Compose",
                "inputs": {
                    "enabledTestsEvaluation": {
                        "createUserTestEnabled": "@or(equals(parameters('EnabledTests'), 'All'), equals(parameters('EnabledTests'), 'UserTests'), equals(parameters('EnabledTests'), 'Create_User_Test'))",
                        "createGroupTestEnabled": "@or(equals(parameters('EnabledTests'), 'All'), equals(parameters('EnabledTests'), 'GroupTests'), equals(parameters('EnabledTests'), 'Create_Group_Test'))",
                        "updateUserTestEnabled": "@or(equals(parameters('EnabledTests'), 'All'), equals(parameters('EnabledTests'), 'UserTests'), equals(parameters('EnabledTests'), 'Update_User_Test'))",
                        "disableUserTestEnabled": "@or(equals(parameters('EnabledTests'), 'All'), equals(parameters('EnabledTests'), 'UserTests'), equals(parameters('EnabledTests'), 'Disable_User_Test'))",
                        "deleteUserTestEnabled": "@or(equals(parameters('EnabledTests'), 'All'), equals(parameters('EnabledTests'), 'UserTests'), equals(parameters('EnabledTests'), 'Delete_User_Test'))",
                        "managerTestEnabled": "@or(or(equals(parameters('EnabledTests'), 'All'), equals(parameters('EnabledTests'), 'UserTests')), equals(parameters('EnabledTests'), 'User_Update_Manager_Test'))",
                        "updateGroupTestEnabled": "@or(equals(parameters('EnabledTests'), 'All'), equals(parameters('EnabledTests'), 'GroupTests'), equals(parameters('EnabledTests'), 'Update_Group_Test'))",
                        "deleteGroupTestEnabled": "@or(equals(parameters('EnabledTests'), 'All'), equals(parameters('EnabledTests'), 'GroupTests'), equals(parameters('EnabledTests'), 'Delete_Group_Test'))",
                        "addMemberTestEnabled": "@or(or(equals(parameters('EnabledTests'), 'All'), equals(parameters('EnabledTests'), 'GroupTests')), equals(parameters('EnabledTests'), 'Group_Update_Add_Member_Test'))",
                        "removeMemberTestEnabled": "@or(or(equals(parameters('EnabledTests'), 'All'), equals(parameters('EnabledTests'), 'GroupTests')), equals(parameters('EnabledTests'), 'Group_Update_Remove_Member_Test'))"
                    }
                }
            },
            "Compose_Final_Results": {
                "runAfter": {
                    "Evaluate_Test_Results": [
                        "Succeeded"
                    ]
                },
                "type": "Compose",
                "inputs": "@union(if(outputs('Evaluate_Test_Results')?['enabledTestsEvaluation']?['createUserTestEnabled'], if(equals(variables('CreateUserTestOutputs')['overallResult'], 'PASSED'), json(concat('[{\"testName\":\"Create_User_Test\",\"testResult\":\"', variables('CreateUserTestOutputs')['result'], '\",\"provisioningErrorDetails\":null,\"recommendationUrl\":\"\"}]')), json(concat('[{\"testName\":\"Create_User_Test\",\"testResult\":\"', variables('CreateUserTestOutputs')['result'], '\",\"provisioningErrorDetails\":', string(variables('CreateUserTestOutputs')['errorDetails']), ',\"recommendationUrl\":\"https://learn.microsoft.com/en-us/azure/active-directory/app-provisioning/known-issues\"}]'))), json('[{\"testName\":\"Create_User_Test\",\"testResult\":\"SKIPPED\",\"provisioningErrorDetails\":\"\",\"recommendationUrl\":\"\"}]')), if(outputs('Evaluate_Test_Results')?['enabledTestsEvaluation']?['updateUserTestEnabled'], if(equals(variables('UpdateUserTestOutputs')['overallResult'], 'PASSED'), json(concat('[{\"testName\":\"Update_User_Test\",\"testResult\":\"', variables('UpdateUserTestOutputs')['result'], '\",\"provisioningErrorDetails\":null,\"recommendationUrl\":\"\"}]')), json(concat('[{\"testName\":\"Update_User_Test\",\"testResult\":\"', variables('UpdateUserTestOutputs')['result'], '\",\"provisioningErrorDetails\":', string(variables('UpdateUserTestOutputs')['errorDetails']), ',\"recommendationUrl\":\"https://learn.microsoft.com/en-us/azure/active-directory/app-provisioning/known-issues\"}]'))), json('[{\"testName\":\"Update_User_Test\",\"testResult\":\"SKIPPED\",\"provisioningErrorDetails\":\"\",\"recommendationUrl\":\"\"}]')), if(outputs('Evaluate_Test_Results')?['enabledTestsEvaluation']?['disableUserTestEnabled'], if(equals(variables('DisableUserTestOutputs')['overallResult'], 'PASSED'), json(concat('[{\"testName\":\"Disable_User_Test\",\"testResult\":\"', variables('DisableUserTestOutputs')['result'], '\",\"provisioningErrorDetails\":null,\"recommendationUrl\":\"\"}]')), json(concat('[{\"testName\":\"Disable_User_Test\",\"testResult\":\"', variables('DisableUserTestOutputs')['result'], '\",\"provisioningErrorDetails\":', string(variables('DisableUserTestOutputs')['errorDetails']), ',\"recommendationUrl\":\"https://learn.microsoft.com/en-us/azure/active-directory/app-provisioning/known-issues\"}]'))), json('[{\"testName\":\"Disable_User_Test\",\"testResult\":\"SKIPPED\",\"provisioningErrorDetails\":\"\",\"recommendationUrl\":\"\"}]')), if(outputs('Evaluate_Test_Results')?['enabledTestsEvaluation']?['deleteUserTestEnabled'], if(equals(variables('DeleteUserTestOutputs')['overallResult'], 'PASSED'), json(concat('[{\"testName\":\"Delete_User_Test\",\"testResult\":\"', variables('DeleteUserTestOutputs')['result'], '\",\"provisioningErrorDetails\":null,\"recommendationUrl\":\"\"}]')), json(concat('[{\"testName\":\"Delete_User_Test\",\"testResult\":\"', variables('DeleteUserTestOutputs')['result'], '\",\"provisioningErrorDetails\":', string(variables('DeleteUserTestOutputs')['errorDetails']), ',\"recommendationUrl\":\"https://learn.microsoft.com/en-us/azure/active-directory/app-provisioning/known-issues\"}]'))), json('[{\"testName\":\"Delete_User_Test\",\"testResult\":\"SKIPPED\",\"provisioningErrorDetails\":\"\",\"recommendationUrl\":\"\"}]')), if(outputs('Evaluate_Test_Results')?['enabledTestsEvaluation']?['managerTestEnabled'], if(equals(variables('ManagerTestOutputs')['overallResult'], 'PASSED'), json(concat('[{\"testName\":\"User_Update_Manager_Test\",\"testResult\":\"', variables('ManagerTestOutputs')['result'], '\",\"provisioningErrorDetails\":null,\"recommendationUrl\":\"\"}]')), json(concat('[{\"testName\":\"User_Update_Manager_Test\",\"testResult\":\"', variables('ManagerTestOutputs')['result'], '\",\"provisioningErrorDetails\":', string(variables('ManagerTestOutputs')['errorDetails']), ',\"recommendationUrl\":\"https://learn.microsoft.com/en-us/azure/active-directory/app-provisioning/known-issues\"}]'))), json('[{\"testName\":\"User_Update_Manager_Test\",\"testResult\":\"SKIPPED\",\"provisioningErrorDetails\":\"\",\"recommendationUrl\":\"\"}]')), if(outputs('Evaluate_Test_Results')?['enabledTestsEvaluation']?['createGroupTestEnabled'], if(equals(variables('CreateGroupTestOutputs')['overallResult'], 'PASSED'), json(concat('[{\"testName\":\"Create_Group_Test\",\"testResult\":\"', variables('CreateGroupTestOutputs')['result'], '\",\"provisioningErrorDetails\":null,\"recommendationUrl\":\"\"}]')), json(concat('[{\"testName\":\"Create_Group_Test\",\"testResult\":\"', variables('CreateGroupTestOutputs')['result'], '\",\"provisioningErrorDetails\":', string(variables('CreateGroupTestOutputs')['errorDetails']), ',\"recommendationUrl\":\"https://learn.microsoft.com/en-us/azure/active-directory/app-provisioning/known-issues\"}]'))), json('[{\"testName\":\"Create_Group_Test\",\"testResult\":\"SKIPPED\",\"provisioningErrorDetails\":\"\",\"recommendationUrl\":\"\"}]')), if(outputs('Evaluate_Test_Results')?['enabledTestsEvaluation']?['updateGroupTestEnabled'], if(equals(variables('UpdateGroupTestOutputs')['overallResult'], 'PASSED'), json(concat('[{\"testName\":\"Update_Group_Test\",\"testResult\":\"', variables('UpdateGroupTestOutputs')['result'], '\",\"provisioningErrorDetails\":null,\"recommendationUrl\":\"\"}]')), json(concat('[{\"testName\":\"Update_Group_Test\",\"testResult\":\"', variables('UpdateGroupTestOutputs')['result'], '\",\"provisioningErrorDetails\":', string(variables('UpdateGroupTestOutputs')['errorDetails']), ',\"recommendationUrl\":\"https://learn.microsoft.com/en-us/azure/active-directory/app-provisioning/known-issues\"}]'))), json('[{\"testName\":\"Update_Group_Test\",\"testResult\":\"SKIPPED\",\"provisioningErrorDetails\":\"\",\"recommendationUrl\":\"\"}]')), if(outputs('Evaluate_Test_Results')?['enabledTestsEvaluation']?['deleteGroupTestEnabled'], if(equals(variables('DeleteGroupTestOutputs')['overallResult'], 'PASSED'), json(concat('[{\"testName\":\"Delete_Group_Test\",\"testResult\":\"', variables('DeleteGroupTestOutputs')['result'], '\",\"provisioningErrorDetails\":null,\"recommendationUrl\":\"\"}]')), json(concat('[{\"testName\":\"Delete_Group_Test\",\"testResult\":\"', variables('DeleteGroupTestOutputs')['result'], '\",\"provisioningErrorDetails\":', string(variables('DeleteGroupTestOutputs')['errorDetails']), ',\"recommendationUrl\":\"https://learn.microsoft.com/en-us/azure/active-directory/app-provisioning/known-issues\"}]'))), json('[{\"testName\":\"Delete_Group_Test\",\"testResult\":\"SKIPPED\",\"provisioningErrorDetails\":\"\",\"recommendationUrl\":\"\"}]')), if(outputs('Evaluate_Test_Results')?['enabledTestsEvaluation']?['addMemberTestEnabled'], if(equals(variables('AddMemberTestOutputs')['overallResult'], 'PASSED'), json(concat('[{\"testName\":\"Group_Update_Add_Member_Test\",\"testResult\":\"', variables('AddMemberTestOutputs')['result'], '\",\"provisioningErrorDetails\":null,\"recommendationUrl\":\"\"}]')), json(concat('[{\"testName\":\"Group_Update_Add_Member_Test\",\"testResult\":\"', variables('AddMemberTestOutputs')['result'], '\",\"provisioningErrorDetails\":', string(variables('AddMemberTestOutputs')['errorDetails']), ',\"recommendationUrl\":\"https://learn.microsoft.com/en-us/azure/active-directory/app-provisioning/known-issues\"}]'))), json('[{\"testName\":\"Group_Update_Add_Member_Test\",\"testResult\":\"SKIPPED\",\"provisioningErrorDetails\":\"\",\"recommendationUrl\":\"\"}]')), if(outputs('Evaluate_Test_Results')?['enabledTestsEvaluation']?['removeMemberTestEnabled'], if(equals(variables('RemoveMemberTestOutputs')['overallResult'], 'PASSED'), json(concat('[{\"testName\":\"Group_Update_Remove_Member_Test\",\"testResult\":\"', variables('RemoveMemberTestOutputs')['result'], '\",\"provisioningErrorDetails\":null,\"recommendationUrl\":\"\"}]')), json(concat('[{\"testName\":\"Group_Update_Remove_Member_Test\",\"testResult\":\"', variables('RemoveMemberTestOutputs')['result'], '\",\"provisioningErrorDetails\":', string(variables('RemoveMemberTestOutputs')['errorDetails']), ',\"recommendationUrl\":\"https://learn.microsoft.com/en-us/azure/active-directory/app-provisioning/known-issues\"}]'))), json('[{\"testName\":\"Group_Update_Remove_Member_Test\",\"testResult\":\"SKIPPED\",\"provisioningErrorDetails\":\"\",\"recommendationUrl\":\"\"}]')))"
            },
            "UserTests_Scope": {
                "actions": {
                    "Create_User_Test": {
                        "actions": {
                            "Create_User_Test_Actions": {
                                "actions": {
                                    "Create_User_Initial_Verify_User_Exists": {
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['createUser'], ''), '%22')}",
                                            "method": "GET",
                                            "headers": {
                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                "Accept": "@{parameters('scimContentType')}"
                                            }
                                        }
                                    },
                                    "Create_User_Graph": {
                                        "runAfter": {
                                            "Create_User_Initial_Verify_User_Exists": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "https://graph.microsoft.com/beta/users",
                                            "method": "POST",
                                            "headers": {
                                                "Content-Type": "application/json"
                                            },
                                            "body": {
                                                "accountEnabled": true,
                                                "displayName": "@{outputs('Generate_Test_UserNames')['createUser']}",
                                                "mailNickname": "@{replace(first(split(outputs('Generate_Test_UserNames')['createUser'],'@')),'.','')}",
                                                "userPrincipalName": "@{outputs('Generate_Test_UserNames')['createUser']}",
                                                "givenName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName']), concat('Given', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName'])}",
                                                "surname": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname']), concat('Sur', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname'])}",
                                                "jobTitle": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle']), concat('Title', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle'])}",
                                                "department": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department']), concat('Dept', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department'])}",
                                                "companyName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName']), concat('Company', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName'])}",
                                                "businessPhones": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['businessPhones'], json(concat('[\"+ 1-555-', substring(guid(),0,4), '\"]')))",
                                                "mobilePhone": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone'])}",
                                                "officeLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation']), concat('Office', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation'])}",
                                                "preferredLanguage": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage']), 'en-US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage'])}",
                                                "employeeId": "@{substring(guid(), 0, 8)}",
                                                "employeeType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType']), 'Employee', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType'])}",
                                                "streetAddress": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress']), concat('Street', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress'])}",
                                                "city": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city']), concat('City', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city'])}",
                                                "state": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state']), 'WA', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state'])}",
                                                "country": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country'])}",
                                                "postalCode": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode'])}",
                                                "usageLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation'])}",
                                                "otherMails": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['otherMails'], json(concat('[\"', substring(guid(),0,8), '@example.com\"]')))",
                                                "mail": "@{outputs('Generate_Test_UserNames')['createUser']}",
                                                "faxNumber": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber'])}",
                                                "userType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType']), 'Member', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType'])}",
                                                "employeeOrgData": "@if(or(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'])), json(concat('{\"division\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), concat('Div', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), '\",\"costCenter\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), '\"}')), json(concat('{\"division\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division'], '\",\"costCenter\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'], '\"}')))",
                                                "passwordProfile": {
                                                    "forceChangePasswordNextSignIn": "@{coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['forceChangePasswordNextSignIn'], true)}",
                                                    "password": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['password']), concat('Tmp!', substring(guid(),0,8), '@', substring(guid(),24,8)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['password'])}"
                                                }
                                            },
                                            "authentication": {
                                                "type": "ManagedServiceIdentity",
                                                "audience": "https://graph.microsoft.com/"
                                            }
                                        }
                                    },
                                    "Assign_User_To_App": {
                                        "runAfter": {
                                            "Create_User_Graph": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "https://graph.microsoft.com/beta/users/@{body('Create_User_Graph')?['id']}/appRoleAssignments",
                                            "method": "POST",
                                            "headers": {
                                                "Content-Type": "application/json"
                                            },
                                            "body": {
                                                "principalId": "@{body('Create_User_Graph')?['id']}",
                                                "resourceId": "@{parameters('servicePrincipalId')}",
                                                "appRoleId": "@{first(body('Get_App_Roles')?['appRoles'])?['id']}"
                                            },
                                            "authentication": {
                                                "type": "ManagedServiceIdentity",
                                                "audience": "https://graph.microsoft.com/"
                                            }
                                        }
                                    },
                                    "DoUntil_Poll_Create_User": {
                                        "actions": {
                                            "SCIM_Query_Created_User": {
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['createUser'], ''), '%22')}",
                                                    "method": "GET",
                                                    "headers": {
                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                        "Accept": "@{parameters('scimContentType')}"
                                                    }
                                                }
                                            },
                                            "Delay_Create_User_15s": {
                                                "runAfter": {
                                                    "SCIM_Query_Created_User": [
                                                        "Succeeded",
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Wait",
                                                "inputs": {
                                                    "interval": {
                                                        "count": 15,
                                                        "unit": "Second"
                                                    }
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Assign_User_To_App": [
                                                "Succeeded"
                                            ]
                                        },
                                        "expression": "@greater(length(coalesce(body('SCIM_Query_Created_User')?['Resources'], json('[]'))), 0)",
                                        "limit": {
                                            "count": 150,
                                            "timeout": "PT40M"
                                        },
                                        "type": "Until"
                                    },
                                    "DoUntil_Poll_Provisioning_Logs": {
                                        "actions": {
                                            "Verify_Provisioning_Logs": {
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Create_User_Graph')?['id'], '%27%20and%20provisioningAction%20eq%20%27Create%27')}",
                                                    "method": "GET",
                                                    "headers": {
                                                        "Accept": "application/json"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Delay_Provisioning_Logs_15s": {
                                                "runAfter": {
                                                    "Verify_Provisioning_Logs": [
                                                        "Succeeded",
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Wait",
                                                "inputs": {
                                                    "interval": {
                                                        "count": 15,
                                                        "unit": "Second"
                                                    }
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "DoUntil_Poll_Create_User": [
                                                "Succeeded",
                                                "Failed",
                                                "TimedOut"
                                            ]
                                        },
                                        "expression": "@greater(length(coalesce(body('Verify_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                        "limit": {
                                            "count": 150,
                                            "timeout": "PT15M"
                                        },
                                        "type": "Until"
                                    }
                                },
                                "type": "Scope"
                            },
                            "Capture_Failed_Action_Details": {
                                "actions": {
                                    "Get_Actions_Results": {
                                        "type": "Compose",
                                        "inputs": "@result('Create_User_Test_Actions')"
                                    },
                                    "Filter_Failed_Actions": {
                                        "runAfter": {
                                            "Get_Actions_Results": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "Query",
                                        "inputs": {
                                            "from": "@outputs('Get_Actions_Results')",
                                            "where": "@equals(item()?['status'], 'Failed')"
                                        }
                                    },
                                    "Set_Failed_Action_Name": {
                                        "runAfter": {
                                            "Filter_Failed_Actions": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "CreateUserFailedActionName",
                                            "value": "@{if(greater(length(body('Filter_Failed_Actions')), 0), first(body('Filter_Failed_Actions'))?['name'], 'Unknown_Action')}"
                                        }
                                    },
                                    "Set_Failed_Action_Response": {
                                        "runAfter": {
                                            "Set_Failed_Action_Name": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "CreateUserFailedActionResponse",
                                            "value": "@if(greater(length(body('Filter_Failed_Actions')), 0), coalesce(first(body('Filter_Failed_Actions'))?['outputs'], json('{}')), json('{}'))"
                                        }
                                    },
                                    "Set_Create_User_Test_Status_Failed": {
                                        "runAfter": {
                                            "Set_Failed_Action_Response": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "CreateUserScopeExecutionStatus",
                                            "value": "Failed"
                                        }
                                    }
                                },
                                "runAfter": {
                                    "Create_User_Test_Actions": [
                                        "Failed"
                                    ]
                                },
                                "type": "Scope"
                            },
                            "Set_Create_User_Test_Status_Success": {
                                "runAfter": {
                                    "Create_User_Test_Actions": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "SetVariable",
                                "inputs": {
                                    "name": "CreateUserScopeExecutionStatus",
                                    "value": "Succeeded"
                                }
                            },
                            "Create_User_Test_Analyze_Provisioning_Results": {
                                "runAfter": {
                                    "Create_User_Test_Actions": [
                                        "Succeeded",
                                        "Failed",
                                        "TimedOut"
                                    ],
                                    "Capture_Failed_Action_Details": [
                                        "Succeeded",
                                        "Skipped"
                                    ],
                                    "Set_Create_User_Test_Status_Success": [
                                        "Succeeded",
                                        "Skipped"
                                    ]
                                },
                                "type": "Compose",
                                "inputs": {
                                    "provisioningLogsCount": "@length(coalesce(body('Verify_Provisioning_Logs')?['value'], json('[]')))",
                                    "hasProvisioningLogs": "@greater(length(coalesce(body('Verify_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                    "provisioningStatus": "@if(greater(length(coalesce(body('Verify_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Verify_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                    "provisioningResult": "@if(equals(variables('CreateUserScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('Verify_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Verify_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('CreateUserFailedActionName')))",
                                    "provisioningErrorDetails": "@if(equals(variables('CreateUserScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Verify_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Verify_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('Verify_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('CreateUserFailedActionResponse'))",
                                    "overallResult": "@if(equals(variables('CreateUserScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Verify_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('Verify_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                }
                            },
                            "Set_CreateUser_Output_Variables": {
                                "actions": {
                                    "Set_CreateUserTestOutputs": {
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "CreateUserTestOutputs",
                                            "value": {
                                                "overallResult": "@outputs('Create_User_Test_Analyze_Provisioning_Results')?['overallResult']",
                                                "result": "@outputs('Create_User_Test_Analyze_Provisioning_Results')?['provisioningResult']",
                                                "errorDetails": "@outputs('Create_User_Test_Analyze_Provisioning_Results')?['provisioningErrorDetails']"
                                            }
                                        }
                                    }
                                },
                                "runAfter": {
                                    "Create_User_Test_Analyze_Provisioning_Results": [
                                        "Succeeded",
                                        "Failed"
                                    ]
                                },
                                "type": "Scope"
                            },
                            "Delete_Created_User": {
                                "runAfter": {
                                    "Set_CreateUser_Output_Variables": [
                                        "Succeeded",
                                        "Failed",
                                        "Skipped"
                                    ]
                                },
                                "type": "Http",
                                "inputs": {
                                    "uri": "https://graph.microsoft.com/beta/users/@{body('Create_User_Graph')?['id']}",
                                    "method": "DELETE",
                                    "authentication": {
                                        "type": "ManagedServiceIdentity",
                                        "audience": "https://graph.microsoft.com/"
                                    }
                                }
                            }
                        },
                        "else": {
                            "actions": {}
                        },
                        "expression": {
                            "or": [
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "All"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "UserTests"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "Create_User_Test"
                                    ]
                                }
                            ]
                        },
                        "type": "If"
                    },
                    "Update_User_Test": {
                        "actions": {
                            "Update_User_Test_-_Actions": {
                                "actions": {
                                    "Update_User_Verify_Creation_And_Provisioning": {
                                        "actions": {
                                            "Update_User_-_Initial_Verify_User_Exists": {
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['updateUser'], ''), '%22')}",
                                                    "method": "GET",
                                                    "headers": {
                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                        "Accept": "@{parameters('scimContentType')}"
                                                    }
                                                }
                                            },
                                            "Update_User_-_Create_User_Graph": {
                                                "runAfter": {
                                                    "Compose_Final_User_Body": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": "@outputs('Compose_Final_User_Body')",
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Update_User_-_Assign_User_To_App": {
                                                "runAfter": {
                                                    "Update_User_-_Create_User_Graph": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users/@{body('Update_User_-_Create_User_Graph')?['id']}/appRoleAssignments",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "principalId": "@{body('Update_User_-_Create_User_Graph')?['id']}",
                                                        "resourceId": "@{parameters('servicePrincipalId')}",
                                                        "appRoleId": "@{first(body('Get_App_Roles')?['appRoles'])?['id']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Update_DoUntil_Wait_For_User_Creation": {
                                                "actions": {
                                                    "Update_User_Verify_User_Created": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['updateUser'], ''), '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}",
                                                                "Content-Type": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "Update_Delay_Creation_15s": {
                                                        "runAfter": {
                                                            "Update_User_Verify_User_Created": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Update_User_-_Assign_User_To_App": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "expression": "@greater(length(coalesce(body('Update_User_Verify_User_Created')?['Resources'], json('[]'))), 0)",
                                                "limit": {
                                                    "count": 150,
                                                    "timeout": "PT40M"
                                                },
                                                "type": "Until"
                                            },
                                            "Update_DoUntil_Poll_Create_Provisioning_Logs": {
                                                "actions": {
                                                    "Update_Verify_Create_Provisioning_Logs": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Update_User_-_Create_User_Graph')?['id'], '%27%20and%20provisioningAction%20eq%20%27Create%27')",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Accept": "application/json"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "Update_Delay_Create_Provisioning_Logs_15s": {
                                                        "runAfter": {
                                                            "Update_Verify_Create_Provisioning_Logs": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Update_DoUntil_Wait_For_User_Creation": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "expression": "@greater(length(coalesce(body('Update_Verify_Create_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                "limit": {
                                                    "count": 150,
                                                    "timeout": "PT15M"
                                                },
                                                "type": "Until"
                                            },
                                            "Compose_User_Body_With_Nulls": {
                                                "runAfter": {
                                                    "Update_User_-_Initial_Verify_User_Exists": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Compose",
                                                "inputs": {
                                                    "accountEnabled": true,
                                                    "displayName": "@{outputs('Generate_Test_UserNames')['updateUser']}",
                                                    "mailNickname": "@{replace(first(split(outputs('Generate_Test_UserNames')['updateUser'],'@')),'.','')}",
                                                    "userPrincipalName": "@{outputs('Generate_Test_UserNames')['updateUser']}",
                                                    "mail": "@{outputs('Generate_Test_UserNames')['updateUser']}",
                                                    "passwordProfile": {
                                                        "forceChangePasswordNextSignIn": "@parameters('forcePasswordChange')",
                                                        "password": "@parameters('defaultPassword')"
                                                    },
                                                    "givenName": "@{if(contains(body('Select_Graph_Property_Names'), 'givenName'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName'], concat('Given', substring(guid(),0,6))), null)}",
                                                    "surname": "@{if(contains(body('Select_Graph_Property_Names'), 'surname'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname'], concat('Sur', substring(guid(),0,6))), null)}",
                                                    "jobTitle": "@{if(contains(body('Select_Graph_Property_Names'), 'jobTitle'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle'], concat('Title', substring(guid(),0,6))), null)}",
                                                    "department": "@{if(contains(body('Select_Graph_Property_Names'), 'department'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department'], concat('Dept', substring(guid(),0,6))), null)}",
                                                    "companyName": "@{if(contains(body('Select_Graph_Property_Names'), 'companyName'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName'], concat('Company', substring(guid(),0,6))), null)}",
                                                    "businessPhones": "@{if(contains(body('Select_Graph_Property_Names'), 'businessPhones'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['businessPhones'], json(concat('[\"+ 1-555-', substring(guid(),0,4), '\"]'))), null)}",
                                                    "mobilePhone": "@{if(contains(body('Select_Graph_Property_Names'), 'mobilePhone'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone'], concat('+1-555-', substring(guid(),0,4))), null)}",
                                                    "officeLocation": "@{if(contains(body('Select_Graph_Property_Names'), 'officeLocation'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation'], concat('Office', substring(guid(),0,4))), null)}",
                                                    "preferredLanguage": "@{if(contains(body('Select_Graph_Property_Names'), 'preferredLanguage'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage'], 'en-US'), null)}",
                                                    "employeeId": "@{if(contains(body('Select_Graph_Property_Names'), 'employeeId'), substring(guid(), 0, 8), null)}",
                                                    "employeeType": "@{if(contains(body('Select_Graph_Property_Names'), 'employeeType'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType'], 'Employee'), null)}",
                                                    "streetAddress": "@{if(contains(body('Select_Graph_Property_Names'), 'streetAddress'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress'], concat('Street', substring(guid(),0,4))), null)}",
                                                    "city": "@{if(contains(body('Select_Graph_Property_Names'), 'city'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city'], concat('City', substring(guid(),0,4))), null)}",
                                                    "state": "@{if(contains(body('Select_Graph_Property_Names'), 'state'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state'], 'WA'), null)}",
                                                    "country": "@{if(contains(body('Select_Graph_Property_Names'), 'country'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country'], 'US'), null)}",
                                                    "postalCode": "@{if(contains(body('Select_Graph_Property_Names'), 'postalCode'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode'], substring(guid(),0,5)), null)}",
                                                    "usageLocation": "@{if(contains(body('Select_Graph_Property_Names'), 'usageLocation'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation'], 'US'), null)}",
                                                    "otherMails": "@{if(contains(body('Select_Graph_Property_Names'), 'otherMails'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['otherMails'], json(concat('[\"', substring(guid(),0,8), '@example.com\"]'))), null)}",
                                                    "faxNumber": "@{if(contains(body('Select_Graph_Property_Names'), 'faxNumber'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber'], concat('+1-555-', substring(guid(),0,4))), null)}",
                                                    "userType": "@{if(contains(body('Select_Graph_Property_Names'), 'userType'), coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType'], 'Member'), null)}",
                                                    "employeeOrgData": "@{if(or(contains(body('Select_Graph_Property_Names'), 'division'), contains(body('Select_Graph_Property_Names'), 'costCenter')), if(or(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'])), json(concat('{\"division\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), concat('Div', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), '\",\"costCenter\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), '\"}')), json(concat('{\"division\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division'], '\",\"costCenter\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'], '\"}'))), null)}"
                                                }
                                            },
                                            "Compose_Final_User_Body": {
                                                "runAfter": {
                                                    "Compose_User_Body_With_Nulls": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Compose",
                                                "inputs": "@union(if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['givenName'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['givenName'], ''))), json(concat('{\"givenName\":\"', outputs('Compose_User_Body_With_Nulls')['givenName'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['surname'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['surname'], ''))), json(concat('{\"surname\":\"', outputs('Compose_User_Body_With_Nulls')['surname'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['jobTitle'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['jobTitle'], ''))), json(concat('{\"jobTitle\":\"', outputs('Compose_User_Body_With_Nulls')['jobTitle'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['department'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['department'], ''))), json(concat('{\"department\":\"', outputs('Compose_User_Body_With_Nulls')['department'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['companyName'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['companyName'], ''))), json(concat('{\"companyName\":\"', outputs('Compose_User_Body_With_Nulls')['companyName'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['mobilePhone'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['mobilePhone'], ''))), json(concat('{\"mobilePhone\":\"', outputs('Compose_User_Body_With_Nulls')['mobilePhone'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['officeLocation'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['officeLocation'], ''))), json(concat('{\"officeLocation\":\"', outputs('Compose_User_Body_With_Nulls')['officeLocation'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['preferredLanguage'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['preferredLanguage'], ''))), json(concat('{\"preferredLanguage\":\"', outputs('Compose_User_Body_With_Nulls')['preferredLanguage'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['employeeId'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['employeeId'], ''))), json(concat('{\"employeeId\":\"', outputs('Compose_User_Body_With_Nulls')['employeeId'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['employeeType'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['employeeType'], ''))), json(concat('{\"employeeType\":\"', outputs('Compose_User_Body_With_Nulls')['employeeType'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['streetAddress'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['streetAddress'], ''))), json(concat('{\"streetAddress\":\"', outputs('Compose_User_Body_With_Nulls')['streetAddress'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['city'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['city'], ''))), json(concat('{\"city\":\"', outputs('Compose_User_Body_With_Nulls')['city'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['state'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['state'], ''))), json(concat('{\"state\":\"', outputs('Compose_User_Body_With_Nulls')['state'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['country'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['country'], ''))), json(concat('{\"country\":\"', outputs('Compose_User_Body_With_Nulls')['country'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['postalCode'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['postalCode'], ''))), json(concat('{\"postalCode\":\"', outputs('Compose_User_Body_With_Nulls')['postalCode'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['usageLocation'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['usageLocation'], ''))), json(concat('{\"usageLocation\":\"', outputs('Compose_User_Body_With_Nulls')['usageLocation'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['faxNumber'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['faxNumber'], ''))), json(concat('{\"faxNumber\":\"', outputs('Compose_User_Body_With_Nulls')['faxNumber'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['userType'], null)), not(equals(outputs('Compose_User_Body_With_Nulls')['userType'], ''))), json(concat('{\"userType\":\"', outputs('Compose_User_Body_With_Nulls')['userType'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['businessPhones'], null)), greater(length(coalesce(outputs('Compose_User_Body_With_Nulls')['businessPhones'], json('[]'))), 0)), json(concat('{\"businessPhones\":', string(outputs('Compose_User_Body_With_Nulls')['businessPhones']), '}')), json('{}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['otherMails'], null)), greater(length(coalesce(outputs('Compose_User_Body_With_Nulls')['otherMails'], json('[]'))), 0)), json(concat('{\"otherMails\":', string(outputs('Compose_User_Body_With_Nulls')['otherMails']), '}')), json('{}')), json(concat('{\"accountEnabled\":', toLower(string(outputs('Compose_User_Body_With_Nulls')['accountEnabled'])), ',\"displayName\":\"', outputs('Compose_User_Body_With_Nulls')['displayName'], '\",\"mailNickname\":\"', outputs('Compose_User_Body_With_Nulls')['mailNickname'], '\",\"userPrincipalName\":\"', outputs('Compose_User_Body_With_Nulls')['userPrincipalName'], '\",\"mail\":\"', outputs('Compose_User_Body_With_Nulls')['mail'], '\",\"passwordProfile\":{\"forceChangePasswordNextSignIn\":', toLower(string(outputs('Compose_User_Body_With_Nulls')['passwordProfile']['forceChangePasswordNextSignIn'])), ',\"password\":\"', outputs('Compose_User_Body_With_Nulls')['passwordProfile']['password'], '\"}}')), if(and(not(equals(outputs('Compose_User_Body_With_Nulls')['employeeOrgData'], null)), not(empty(string(outputs('Compose_User_Body_With_Nulls')['employeeOrgData'])))), json(concat('{\"employeeOrgData\":', string(outputs('Compose_User_Body_With_Nulls')['employeeOrgData']), '}')), json('{}')))"
                                            }
                                        },
                                        "type": "Scope"
                                    },
                                    "Update_User_Analyze_Create_Provisioning_Results": {
                                        "runAfter": {
                                            "Update_User_Verify_Creation_And_Provisioning": [
                                                "Succeeded",
                                                "Failed",
                                                "TimedOut"
                                            ],
                                            "Capture_Update_CreatePhase_Failed_Actions": [
                                                "Succeeded",
                                                "Skipped"
                                            ],
                                            "Set_UpdateUser_CreatePhase_Status_Success": [
                                                "Succeeded",
                                                "Skipped"
                                            ]
                                        },
                                        "type": "Compose",
                                        "inputs": {
                                            "provisioningLogsCount": "@length(coalesce(body('Update_Verify_Create_Provisioning_Logs')?['value'], json('[]')))",
                                            "hasProvisioningLogs": "@greater(length(coalesce(body('Update_Verify_Create_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                            "provisioningStatus": "@if(greater(length(coalesce(body('Update_Verify_Create_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Update_Verify_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                            "provisioningResult": "@if(equals(variables('UpdateUserScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('Update_Verify_Create_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Update_Verify_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('UpdateUserFailedActionName')))",
                                            "provisioningErrorDetails": "@if(equals(variables('UpdateUserScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Update_Verify_Create_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Update_Verify_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('Update_Verify_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('UpdateUserFailedActionResponse'))",
                                            "overallResult": "@if(equals(variables('UpdateUserScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Update_Verify_Create_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('Update_Verify_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                        }
                                    },
                                    "Update_User_Check_Create_Phase_Status": {
                                        "actions": {
                                            "Update_User_Verify_Update_And_Provisioning": {
                                                "actions": {
                                                    "Update_User_Query_User_By_Id": {
                                                        "runAfter": {
                                                            "Compose_Final_Update_User_Body": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['updateUser'], ''), '%22')",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "Update_User_Update_User_Attributes": {
                                                        "runAfter": {
                                                            "Update_User_Query_User_By_Id": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "https://graph.microsoft.com/beta/users/@{body('Update_User_-_Create_User_Graph')?['id']}",
                                                            "method": "PATCH",
                                                            "headers": {
                                                                "Content-Type": "application/json"
                                                            },
                                                            "body": "@outputs('Compose_Final_Update_User_Body')",
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "Update_DoUntil_Wait_For_Attribute_Updates": {
                                                        "actions": {
                                                            "Update_User_-_Query_User_By_Id_After_Attributes_Update": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['updateUser'], ''), '%22')",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                        "Accept": "@{parameters('scimContentType')}"
                                                                    }
                                                                }
                                                            },
                                                            "Update_Delay_Final_15s": {
                                                                "runAfter": {
                                                                    "Update_User_-_Query_User_By_Id_After_Attributes_Update": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Update_User_Update_User_Attributes": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "expression": "@and(greater(length(coalesce(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'], json('[]'))), 0), contains(string(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')), string(coalesce(outputs('Compose_Final_Update_User_Body')['givenName'], ''))))",
                                                        "limit": {
                                                            "count": 150,
                                                            "timeout": "PT40M"
                                                        },
                                                        "type": "Until"
                                                    },
                                                    "Update_User_-_Match_Expected_Attributes_After_Attributes_Update": {
                                                        "runAfter": {
                                                            "Update_DoUntil_Wait_For_Attribute_Updates": [
                                                                "Succeeded",
                                                                "TimedOut",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Compose",
                                                        "inputs": {
                                                            "expectedDisplayName": "@coalesce(outputs('Compose_Final_Update_User_Body')?['displayName'], '')",
                                                            "actualDisplayName": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['displayName'], '')",
                                                            "expectedGivenName": "@coalesce(outputs('Compose_Final_Update_User_Body')?['givenName'], '')",
                                                            "actualGivenName": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['name']?['givenName'], '')",
                                                            "expectedSurname": "@coalesce(outputs('Compose_Final_Update_User_Body')?['surname'], '')",
                                                            "actualSurname": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['name']?['familyName'], '')",
                                                            "expectedJobTitle": "@coalesce(outputs('Compose_Final_Update_User_Body')?['jobTitle'], '')",
                                                            "actualJobTitle": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['title'], '')",
                                                            "expectedDepartment": "@coalesce(outputs('Compose_Final_Update_User_Body')?['department'], '')",
                                                            "actualDepartment": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['department'], '')",
                                                            "expectedCompanyName": "@coalesce(outputs('Compose_Final_Update_User_Body')?['companyName'], '')",
                                                            "actualCompanyName": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['organization'], '')",
                                                            "expectedOfficeLocation": "@coalesce(outputs('Compose_Final_Update_User_Body')?['officeLocation'], '')",
                                                            "actualOfficeLocation": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['officeLocation'], '')",
                                                            "expectedPreferredLanguage": "@coalesce(outputs('Compose_Final_Update_User_Body')?['preferredLanguage'], '')",
                                                            "actualPreferredLanguage": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['preferredLanguage'], '')",
                                                            "expectedEmployeeType": "@coalesce(outputs('Compose_Final_Update_User_Body')?['employeeType'], '')",
                                                            "actualEmployeeType": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['employeeType'], '')",
                                                            "expectedUsageLocation": "@coalesce(outputs('Compose_Final_Update_User_Body')?['usageLocation'], '')",
                                                            "actualUsageLocation": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['usageLocation'], '')",
                                                            "expectedCountry": "@coalesce(outputs('Compose_Final_Update_User_Body')?['country'], '')",
                                                            "actualCountry": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['country'], '')",
                                                            "expectedStreetAddress": "@coalesce(outputs('Compose_Final_Update_User_Body')?['streetAddress'], '')",
                                                            "actualStreetAddress": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['streetAddress'], '')",
                                                            "expectedCity": "@coalesce(outputs('Compose_Final_Update_User_Body')?['city'], '')",
                                                            "actualCity": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['locality'], '')",
                                                            "expectedState": "@coalesce(outputs('Compose_Final_Update_User_Body')?['state'], '')",
                                                            "actualState": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['region'], '')",
                                                            "expectedPostalCode": "@coalesce(outputs('Compose_Final_Update_User_Body')?['postalCode'], '')",
                                                            "actualPostalCode": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['postalCode'], '')",
                                                            "expectedDivision": "@coalesce(outputs('Compose_Final_Update_User_Body')?['employeeOrgData']?['division'], '')",
                                                            "actualDivision": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['division'], '')",
                                                            "expectedCostCenter": "@coalesce(outputs('Compose_Final_Update_User_Body')?['employeeOrgData']?['costCenter'], '')",
                                                            "actualCostCenter": "@coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['costCenter'], '')",
                                                            "displayNameMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['displayName'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['displayName'], ''))",
                                                            "givenNameMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['givenName'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['name']?['givenName'], ''))",
                                                            "surnameMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['surname'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['name']?['familyName'], ''))",
                                                            "jobTitleMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['jobTitle'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['title'], ''))",
                                                            "departmentMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['department'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['department'], ''))",
                                                            "companyNameMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['companyName'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['organization'], ''))",
                                                            "officeLocationMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['officeLocation'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['officeLocation'], ''))",
                                                            "preferredLanguageMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['preferredLanguage'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['preferredLanguage'], ''))",
                                                            "employeeTypeMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['employeeType'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['employeeType'], ''))",
                                                            "usageLocationMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['usageLocation'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['usageLocation'], ''))",
                                                            "countryMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['country'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['country'], ''))",
                                                            "streetAddressMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['streetAddress'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['streetAddress'], ''))",
                                                            "cityMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['city'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['locality'], ''))",
                                                            "stateMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['state'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['region'], ''))",
                                                            "postalCodeMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['postalCode'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['postalCode'], ''))",
                                                            "divisionMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['employeeOrgData']?['division'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['division'], ''))",
                                                            "costCenterMatches": "@equals(coalesce(outputs('Compose_Final_Update_User_Body')?['employeeOrgData']?['costCenter'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['costCenter'], ''))",
                                                            "attributesMatch": "@and(and(and(and(and(equals(coalesce(outputs('Compose_Final_Update_User_Body')?['displayName'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['displayName'], '')), equals(coalesce(outputs('Compose_Final_Update_User_Body')?['givenName'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['name']?['givenName'], ''))), and(equals(coalesce(outputs('Compose_Final_Update_User_Body')?['surname'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['name']?['familyName'], '')), equals(coalesce(outputs('Compose_Final_Update_User_Body')?['jobTitle'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['title'], '')))), and(and(equals(coalesce(outputs('Compose_Final_Update_User_Body')?['department'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['department'], '')), equals(coalesce(outputs('Compose_Final_Update_User_Body')?['companyName'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['organization'], ''))), and(equals(coalesce(outputs('Compose_Final_Update_User_Body')?['officeLocation'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['officeLocation'], '')), equals(coalesce(outputs('Compose_Final_Update_User_Body')?['preferredLanguage'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['preferredLanguage'], ''))))), and(and(and(equals(coalesce(outputs('Compose_Final_Update_User_Body')?['employeeType'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['employeeType'], '')), equals(coalesce(outputs('Compose_Final_Update_User_Body')?['usageLocation'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['usageLocation'], ''))), and(equals(coalesce(outputs('Compose_Final_Update_User_Body')?['country'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['country'], '')), equals(coalesce(outputs('Compose_Final_Update_User_Body')?['streetAddress'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['streetAddress'], '')))), and(and(equals(coalesce(outputs('Compose_Final_Update_User_Body')?['city'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['locality'], '')), equals(coalesce(outputs('Compose_Final_Update_User_Body')?['state'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['region'], ''))), and(equals(coalesce(outputs('Compose_Final_Update_User_Body')?['postalCode'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['addresses']?[0]?['postalCode'], '')), and(equals(coalesce(outputs('Compose_Final_Update_User_Body')?['employeeOrgData']?['division'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['division'], '')), equals(coalesce(outputs('Compose_Final_Update_User_Body')?['employeeOrgData']?['costCenter'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['costCenter'], ''))))))), and(and(equals(coalesce(outputs('Compose_Final_Update_User_Body')?['employeeOrgData']?['division'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['division'], '')), equals(coalesce(outputs('Compose_Final_Update_User_Body')?['employeeOrgData']?['costCenter'], ''), coalesce(first(body('Update_User_-_Query_User_By_Id_After_Attributes_Update')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['costCenter'], ''))), true))"
                                                        }
                                                    },
                                                    "Update_DoUntil_Poll_Update_Provisioning_Logs": {
                                                        "actions": {
                                                            "Update_Verify_Update_Provisioning_Logs": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Update_User_-_Create_User_Graph')?['id'], '%27%20and%20provisioningAction%20eq%20%27Update%27&$top=1&$orderby=activityDateTime%20desc')",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Accept": "application/json"
                                                                    },
                                                                    "authentication": {
                                                                        "type": "ManagedServiceIdentity",
                                                                        "audience": "https://graph.microsoft.com/"
                                                                    }
                                                                }
                                                            },
                                                            "Update_Delay_Update_Provisioning_Logs_15s": {
                                                                "runAfter": {
                                                                    "Update_Verify_Update_Provisioning_Logs": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Update_User_-_Match_Expected_Attributes_After_Attributes_Update": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "expression": "@greater(length(coalesce(body('Update_Verify_Update_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                        "limit": {
                                                            "count": 150,
                                                            "timeout": "PT15M"
                                                        },
                                                        "type": "Until"
                                                    },
                                                    "Compose_Update_User_Body_With_Nulls": {
                                                        "type": "Compose",
                                                        "inputs": {
                                                            "displayName": "@{concat(outputs('Generate_Test_UserNames')['updateUser'], ' - Updated')}",
                                                            "givenName": "@{if(contains(body('Select_Graph_Property_Names'), 'givenName'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['givenName'], 'UpdatedGiven'), null)}",
                                                            "surname": "@{if(contains(body('Select_Graph_Property_Names'), 'surname'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['surname'], 'UpdatedSurname'), null)}",
                                                            "jobTitle": "@{if(contains(body('Select_Graph_Property_Names'), 'jobTitle'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['jobTitle'], 'Updated Senior Test Position'), null)}",
                                                            "department": "@{if(contains(body('Select_Graph_Property_Names'), 'department'), parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['department'], null)}",
                                                            "companyName": "@{if(contains(body('Select_Graph_Property_Names'), 'companyName'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['companyName'], 'Updated Test Company'), null)}",
                                                            "businessPhones": "@{if(contains(body('Select_Graph_Property_Names'), 'businessPhones'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['businessPhones'], json(concat('[\"+ 1-555-', substring(guid(),0,4), '\"]'))), null)}",
                                                            "mobilePhone": "@{if(contains(body('Select_Graph_Property_Names'), 'mobilePhone'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['mobilePhone'], '+1-555-8888'), null)}",
                                                            "officeLocation": "@{if(contains(body('Select_Graph_Property_Names'), 'officeLocation'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['officeLocation'], 'Updated Building B, Floor 5'), null)}",
                                                            "preferredLanguage": "@{if(contains(body('Select_Graph_Property_Names'), 'preferredLanguage'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['preferredLanguage'], 'es-ES'), null)}",
                                                            "employeeType": "@{if(contains(body('Select_Graph_Property_Names'), 'employeeType'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['employeeType'], 'Contractor'), null)}",
                                                            "streetAddress": "@{if(contains(body('Select_Graph_Property_Names'), 'streetAddress'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['streetAddress'], '456 Updated Street'), null)}",
                                                            "city": "@{if(contains(body('Select_Graph_Property_Names'), 'city'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['city'], 'Updated Seattle'), null)}",
                                                            "state": "@{if(contains(body('Select_Graph_Property_Names'), 'state'), parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['state'], null)}",
                                                            "country": "@{if(contains(body('Select_Graph_Property_Names'), 'country'), parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['country'], null)}",
                                                            "postalCode": "@{if(contains(body('Select_Graph_Property_Names'), 'postalCode'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['postalCode'], '90210'), null)}",
                                                            "usageLocation": "@{if(contains(body('Select_Graph_Property_Names'), 'usageLocation'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['usageLocation'], 'IN'), null)}",
                                                            "otherMails": "@{if(contains(body('Select_Graph_Property_Names'), 'otherMails'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['otherMails'], json(concat('[\"', substring(guid(),0,8), '@example.com\"]'))), null)}",
                                                            "faxNumber": "@{if(contains(body('Select_Graph_Property_Names'), 'faxNumber'), coalesce(parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['faxNumber'], '+1-555-7777'), null)}",
                                                            "employeeOrgData": "@{if(or(contains(body('Select_Graph_Property_Names'), 'division'), contains(body('Select_Graph_Property_Names'), 'costCenter')), json(concat('{\"division\":\"', parameters('defaultUserProperties')[mod(add(outputs('Generate_Test_UserNames')['index'], 1), length(parameters('defaultUserProperties')))]['employeeOrgData']['division'], '\",\"costCenter\":\"99999\"}')), null)}"
                                                        }
                                                    },
                                                    "Compose_Final_Update_User_Body": {
                                                        "runAfter": {
                                                            "Compose_Update_User_Body_With_Nulls": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Compose",
                                                        "inputs": "@union(if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['givenName'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['givenName'], ''))), json(concat('{\"givenName\":\"', outputs('Compose_Update_User_Body_With_Nulls')['givenName'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['surname'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['surname'], ''))), json(concat('{\"surname\":\"', outputs('Compose_Update_User_Body_With_Nulls')['surname'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['jobTitle'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['jobTitle'], ''))), json(concat('{\"jobTitle\":\"', outputs('Compose_Update_User_Body_With_Nulls')['jobTitle'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['department'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['department'], ''))), json(concat('{\"department\":\"', outputs('Compose_Update_User_Body_With_Nulls')['department'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['companyName'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['companyName'], ''))), json(concat('{\"companyName\":\"', outputs('Compose_Update_User_Body_With_Nulls')['companyName'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['mobilePhone'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['mobilePhone'], ''))), json(concat('{\"mobilePhone\":\"', outputs('Compose_Update_User_Body_With_Nulls')['mobilePhone'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['officeLocation'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['officeLocation'], ''))), json(concat('{\"officeLocation\":\"', outputs('Compose_Update_User_Body_With_Nulls')['officeLocation'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['preferredLanguage'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['preferredLanguage'], ''))), json(concat('{\"preferredLanguage\":\"', outputs('Compose_Update_User_Body_With_Nulls')['preferredLanguage'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['employeeType'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['employeeType'], ''))), json(concat('{\"employeeType\":\"', outputs('Compose_Update_User_Body_With_Nulls')['employeeType'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['streetAddress'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['streetAddress'], ''))), json(concat('{\"streetAddress\":\"', outputs('Compose_Update_User_Body_With_Nulls')['streetAddress'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['city'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['city'], ''))), json(concat('{\"city\":\"', outputs('Compose_Update_User_Body_With_Nulls')['city'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['state'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['state'], ''))), json(concat('{\"state\":\"', outputs('Compose_Update_User_Body_With_Nulls')['state'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['country'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['country'], ''))), json(concat('{\"country\":\"', outputs('Compose_Update_User_Body_With_Nulls')['country'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['postalCode'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['postalCode'], ''))), json(concat('{\"postalCode\":\"', outputs('Compose_Update_User_Body_With_Nulls')['postalCode'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['usageLocation'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['usageLocation'], ''))), json(concat('{\"usageLocation\":\"', outputs('Compose_Update_User_Body_With_Nulls')['usageLocation'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['faxNumber'], null)), not(equals(outputs('Compose_Update_User_Body_With_Nulls')['faxNumber'], ''))), json(concat('{\"faxNumber\":\"', outputs('Compose_Update_User_Body_With_Nulls')['faxNumber'], '\"}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['businessPhones'], null)), greater(length(coalesce(outputs('Compose_Update_User_Body_With_Nulls')['businessPhones'], json('[]'))), 0)), json(concat('{\"businessPhones\":', string(outputs('Compose_Update_User_Body_With_Nulls')['businessPhones']), '}')), json('{}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['otherMails'], null)), greater(length(coalesce(outputs('Compose_Update_User_Body_With_Nulls')['otherMails'], json('[]'))), 0)), json(concat('{\"otherMails\":', string(outputs('Compose_Update_User_Body_With_Nulls')['otherMails']), '}')), json('{}')), json(concat('{\"displayName\":\"', outputs('Compose_Update_User_Body_With_Nulls')['displayName'], '\"}')), if(and(not(equals(outputs('Compose_Update_User_Body_With_Nulls')['employeeOrgData'], null)), not(empty(string(outputs('Compose_Update_User_Body_With_Nulls')['employeeOrgData'])))), json(concat('{\"employeeOrgData\":', string(outputs('Compose_Update_User_Body_With_Nulls')['employeeOrgData']), '}')), json('{}')))"
                                                    }
                                                },
                                                "type": "Scope"
                                            },
                                            "Capture_Update_UpdatePhase_Failed_Actions": {
                                                "actions": {
                                                    "Get_Failed_UpdatePhase_Actions": {
                                                        "type": "Compose",
                                                        "inputs": "@result('Update_User_Verify_Update_And_Provisioning')"
                                                    },
                                                    "Filter_Failed_UpdatePhase_Actions": {
                                                        "runAfter": {
                                                            "Get_Failed_UpdatePhase_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Query",
                                                        "inputs": {
                                                            "from": "@outputs('Get_Failed_UpdatePhase_Actions')",
                                                            "where": "@equals(item()?['status'], 'Failed')"
                                                        }
                                                    },
                                                    "Set_UpdateUser_UpdatePhase_Failed_Action_Name": {
                                                        "runAfter": {
                                                            "Filter_Failed_UpdatePhase_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "UpdateUserFailedActionName",
                                                            "value": "@{if(greater(length(body('Filter_Failed_UpdatePhase_Actions')), 0), first(body('Filter_Failed_UpdatePhase_Actions'))?['name'], 'Unknown_Action')}"
                                                        }
                                                    },
                                                    "Set_UpdateUser_UpdatePhase_Failed_Action_Response": {
                                                        "runAfter": {
                                                            "Set_UpdateUser_UpdatePhase_Failed_Action_Name": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "UpdateUserFailedActionResponse",
                                                            "value": "@if(greater(length(body('Filter_Failed_UpdatePhase_Actions')), 0), coalesce(first(body('Filter_Failed_UpdatePhase_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                        }
                                                    },
                                                    "Set_UpdateUser_UpdatePhase_Status_Failed": {
                                                        "runAfter": {
                                                            "Set_UpdateUser_UpdatePhase_Failed_Action_Response": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "UpdateUserScopeExecutionStatus",
                                                            "value": "Failed"
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Update_User_Verify_Update_And_Provisioning": [
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            },
                                            "Set_UpdateUser_UpdatePhase_Status_Success": {
                                                "runAfter": {
                                                    "Update_User_Verify_Update_And_Provisioning": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "UpdateUserScopeExecutionStatus",
                                                    "value": "Succeeded"
                                                }
                                            },
                                            "Set_UpdateUser_UpdatePhase_Output_Variables": {
                                                "actions": {
                                                    "Set_UpdateUserTest_UpdatePhase_Outputs": {
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "UpdateUserTestOutputs",
                                                            "value": {
                                                                "overallResult": "@outputs('Update_Analyze_Update_Provisioning_Results')?['overallResult']",
                                                                "result": "@outputs('Update_Analyze_Update_Provisioning_Results')?['provisioningResult']",
                                                                "errorDetails": "@outputs('Update_Analyze_Update_Provisioning_Results')?['provisioningErrorDetails']"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Update_Analyze_Update_Provisioning_Results": [
                                                        "Succeeded",
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            },
                                            "Update_Analyze_Update_Provisioning_Results": {
                                                "runAfter": {
                                                    "Update_User_Verify_Update_And_Provisioning": [
                                                        "Succeeded",
                                                        "Failed",
                                                        "TimedOut"
                                                    ],
                                                    "Capture_Update_UpdatePhase_Failed_Actions": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ],
                                                    "Set_UpdateUser_UpdatePhase_Status_Success": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ]
                                                },
                                                "type": "Compose",
                                                "inputs": {
                                                    "provisioningLogsCount": "@length(coalesce(body('Update_Verify_Update_Provisioning_Logs')?['value'], json('[]')))",
                                                    "hasProvisioningLogs": "@greater(length(coalesce(body('Update_Verify_Update_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                    "provisioningStatus": "@if(greater(length(coalesce(body('Update_Verify_Update_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Update_Verify_Update_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                                    "provisioningResult": "@if(equals(variables('UpdateUserScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('Update_Verify_Update_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Update_Verify_Update_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('UpdateUserFailedActionName')))",
                                                    "provisioningErrorDetails": "@if(equals(variables('UpdateUserScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Update_Verify_Update_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Update_Verify_Update_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('Update_Verify_Update_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('UpdateUserFailedActionResponse'))",
                                                    "overallResult": "@if(equals(variables('UpdateUserScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Update_Verify_Update_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('Update_Verify_Update_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Set_UpdateUser_CreatePhase_Output_Variables": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped"
                                            ]
                                        },
                                        "else": {
                                            "actions": {}
                                        },
                                        "expression": {
                                            "and": [
                                                {
                                                    "equals": [
                                                        "@toLower(variables('UpdateUserTestOutputs')['overallResult'])",
                                                        "passed"
                                                    ]
                                                }
                                            ]
                                        },
                                        "type": "If"
                                    },
                                    "Update_Cleanup_Delete_User": {
                                        "runAfter": {
                                            "Update_User_Check_Create_Phase_Status": [
                                                "Succeeded",
                                                "Failed",
                                                "TimedOut",
                                                "Skipped"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "https://graph.microsoft.com/beta/users/@{body('Update_User_-_Create_User_Graph')?['id']}",
                                            "method": "DELETE",
                                            "authentication": {
                                                "type": "ManagedServiceIdentity",
                                                "audience": "https://graph.microsoft.com/"
                                            }
                                        }
                                    },
                                    "Capture_Update_CreatePhase_Failed_Actions": {
                                        "actions": {
                                            "Get_Failed_CreatePhase_Actions": {
                                                "type": "Compose",
                                                "inputs": "@result('Update_User_Verify_Creation_And_Provisioning')"
                                            },
                                            "Filter_Failed_CreatePhase_Actions": {
                                                "runAfter": {
                                                    "Get_Failed_CreatePhase_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Query",
                                                "inputs": {
                                                    "from": "@outputs('Get_Failed_CreatePhase_Actions')",
                                                    "where": "@equals(item()?['status'], 'Failed')"
                                                }
                                            },
                                            "Set_UpdateUser_CreatePhase_Failed_Action_Name": {
                                                "runAfter": {
                                                    "Filter_Failed_CreatePhase_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "UpdateUserFailedActionName",
                                                    "value": "@{if(greater(length(body('Filter_Failed_CreatePhase_Actions')), 0), first(body('Filter_Failed_CreatePhase_Actions'))?['name'], 'Unknown_Action')}"
                                                }
                                            },
                                            "Set_UpdateUser_CreatePhase_Failed_Action_Response": {
                                                "runAfter": {
                                                    "Set_UpdateUser_CreatePhase_Failed_Action_Name": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "UpdateUserFailedActionResponse",
                                                    "value": "@if(greater(length(body('Filter_Failed_CreatePhase_Actions')), 0), coalesce(first(body('Filter_Failed_CreatePhase_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                }
                                            },
                                            "Set_UpdateUser_CreatePhase_Status_Failed": {
                                                "runAfter": {
                                                    "Set_UpdateUser_CreatePhase_Failed_Action_Response": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "UpdateUserScopeExecutionStatus",
                                                    "value": "Failed"
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Update_User_Verify_Creation_And_Provisioning": [
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    },
                                    "Set_UpdateUser_CreatePhase_Status_Success": {
                                        "runAfter": {
                                            "Update_User_Verify_Creation_And_Provisioning": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "UpdateUserScopeExecutionStatus",
                                            "value": "Succeeded"
                                        }
                                    },
                                    "Set_UpdateUser_CreatePhase_Output_Variables": {
                                        "actions": {
                                            "Set_UpdateUserTestOutputs": {
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "UpdateUserTestOutputs",
                                                    "value": {
                                                        "overallResult": "@outputs('Update_User_Analyze_Create_Provisioning_Results')?['overallResult']",
                                                        "result": "@outputs('Update_User_Analyze_Create_Provisioning_Results')?['provisioningResult']",
                                                        "errorDetails": "@outputs('Update_User_Analyze_Create_Provisioning_Results')?['provisioningErrorDetails']"
                                                    }
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Update_User_Analyze_Create_Provisioning_Results": [
                                                "Succeeded",
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    }
                                },
                                "type": "Scope"
                            }
                        },
                        "else": {
                            "actions": {}
                        },
                        "expression": {
                            "or": [
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "All"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "UserTests"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "Update_User_Test"
                                    ]
                                }
                            ]
                        },
                        "type": "If"
                    },
                    "Delete_User_Test": {
                        "actions": {
                            "Delete_User_Test_Actions": {
                                "actions": {
                                    "DeleteUser_Phase1_Verify_Creation_And_Provisioning": {
                                        "actions": {
                                            "DeleteUser_Check_Delete_User_Exists_Initial": {
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['deleteUser'], ''), '%22')}",
                                                    "method": "GET",
                                                    "headers": {
                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                        "Accept": "@{parameters('scimContentType')}"
                                                    }
                                                }
                                            },
                                            "DeleteUser_Create_Delete_User_Graph": {
                                                "runAfter": {
                                                    "DeleteUser_Check_Delete_User_Exists_Initial": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "accountEnabled": true,
                                                        "displayName": "@{outputs('Generate_Test_UserNames')['deleteUser']}",
                                                        "mailNickname": "@{replace(first(split(outputs('Generate_Test_UserNames')['deleteUser'],'@')),'.','')}",
                                                        "userPrincipalName": "@{outputs('Generate_Test_UserNames')['deleteUser']}",
                                                        "givenName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName']), concat('Given', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName'])}",
                                                        "surname": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname']), concat('Sur', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname'])}",
                                                        "jobTitle": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle']), concat('Title', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle'])}",
                                                        "department": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department']), concat('Dept', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department'])}",
                                                        "companyName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName']), concat('Company', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName'])}",
                                                        "businessPhones": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['businessPhones'], json(concat('[\"+ 1-555-', substring(guid(),0,4), '\"]')))",
                                                        "mobilePhone": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone'])}",
                                                        "officeLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation']), concat('Office', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation'])}",
                                                        "preferredLanguage": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage']), 'en-US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage'])}",
                                                        "employeeId": "@{substring(guid(), 0, 8)}",
                                                        "employeeType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType']), 'Employee', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType'])}",
                                                        "streetAddress": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress']), concat('Street', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress'])}",
                                                        "city": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city']), concat('City', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city'])}",
                                                        "state": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state']), 'WA', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state'])}",
                                                        "country": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country'])}",
                                                        "postalCode": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode'])}",
                                                        "usageLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation'])}",
                                                        "mail": "@{outputs('Generate_Test_UserNames')['deleteUser']}",
                                                        "otherMails": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['otherMails'], json(concat('[\"', substring(guid(),0,8), '@example.com\"]')))",
                                                        "faxNumber": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber'])}",
                                                        "userType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType']), 'Member', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType'])}",
                                                        "employeeOrgData": "@if(or(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'])), json(concat('{\"division\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), concat('Div', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), '\",\"costCenter\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), '\"}')), json(concat('{\"division\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division'], '\",\"costCenter\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'], '\"}')))",
                                                        "passwordProfile": {
                                                            "forceChangePasswordNextSignIn": "@parameters('forcePasswordChange')",
                                                            "password": "@parameters('defaultPassword')"
                                                        }
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "DeleteUser_Assign_Delete_User_To_App": {
                                                "runAfter": {
                                                    "DeleteUser_Create_Delete_User_Graph": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users/@{body('DeleteUser_Create_Delete_User_Graph')?['id']}/appRoleAssignments",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "principalId": "@{body('DeleteUser_Create_Delete_User_Graph')?['id']}",
                                                        "resourceId": "@{parameters('servicePrincipalId')}",
                                                        "appRoleId": "@{first(body('Get_App_Roles')?['appRoles'])?['id']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "DeleteUser_DoUntil_Wait_For_User_Creation": {
                                                "actions": {
                                                    "DeleteUser_Check_User_Synced": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['deleteUser'], ''), '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "DeleteUser_Delay_Creation_15s": {
                                                        "runAfter": {
                                                            "DeleteUser_Check_User_Synced": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "DeleteUser_Assign_Delete_User_To_App": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "expression": "@greater(length(coalesce(body('DeleteUser_Check_User_Synced')?['Resources'], json('[]'))), 0)",
                                                "limit": {
                                                    "count": 150,
                                                    "timeout": "PT40M"
                                                },
                                                "type": "Until"
                                            },
                                            "DeleteUser_DoUntil_Poll_Provisioning_Logs": {
                                                "actions": {
                                                    "DeleteUser_Verify_Provisioning_Logs": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('DeleteUser_Create_Delete_User_Graph')?['id'], '%27%20and%20provisioningAction%20eq%20%27create%27&$orderby=activityDateTime%20desc&$top=1')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Accept": "application/json"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "DeleteUser_Delay_Provisioning_Logs_15s": {
                                                        "runAfter": {
                                                            "DeleteUser_Verify_Provisioning_Logs": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "DeleteUser_DoUntil_Wait_For_User_Creation": [
                                                        "Succeeded",
                                                        "Failed",
                                                        "TimedOut"
                                                    ]
                                                },
                                                "expression": "@greater(length(coalesce(body('DeleteUser_Verify_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                "limit": {
                                                    "count": 150,
                                                    "timeout": "PT15M"
                                                },
                                                "type": "Until"
                                            }
                                        },
                                        "type": "Scope"
                                    },
                                    "DeleteUser_Capture_Phase1_Failed_Actions": {
                                        "actions": {
                                            "DeleteUser_Get_Phase1_Failed_Actions": {
                                                "type": "Compose",
                                                "inputs": "@result('DeleteUser_Phase1_Verify_Creation_And_Provisioning')"
                                            },
                                            "DeleteUser_Filter_Phase1_Failed_Actions": {
                                                "runAfter": {
                                                    "DeleteUser_Get_Phase1_Failed_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Query",
                                                "inputs": {
                                                    "from": "@outputs('DeleteUser_Get_Phase1_Failed_Actions')",
                                                    "where": "@equals(item()?['status'], 'Failed')"
                                                }
                                            },
                                            "DeleteUser_Set_Phase1_Failed_Action_Name": {
                                                "runAfter": {
                                                    "DeleteUser_Filter_Phase1_Failed_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DeleteUserFailedActionName",
                                                    "value": "@{if(greater(length(body('DeleteUser_Filter_Phase1_Failed_Actions')), 0), first(body('DeleteUser_Filter_Phase1_Failed_Actions'))?['name'], 'Unknown_Action')}"
                                                }
                                            },
                                            "DeleteUser_Set_Phase1_Failed_Action_Response": {
                                                "runAfter": {
                                                    "DeleteUser_Set_Phase1_Failed_Action_Name": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DeleteUserFailedActionResponse",
                                                    "value": "@if(greater(length(body('DeleteUser_Filter_Phase1_Failed_Actions')), 0), coalesce(first(body('DeleteUser_Filter_Phase1_Failed_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                }
                                            },
                                            "DeleteUser_Set_Phase1_Status_Failed": {
                                                "runAfter": {
                                                    "DeleteUser_Set_Phase1_Failed_Action_Response": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DeleteUserScopeExecutionStatus",
                                                    "value": "Failed"
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "DeleteUser_Phase1_Verify_Creation_And_Provisioning": [
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    },
                                    "DeleteUser_Set_Phase1_Status_Success": {
                                        "runAfter": {
                                            "DeleteUser_Phase1_Verify_Creation_And_Provisioning": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "DeleteUserScopeExecutionStatus",
                                            "value": "Succeeded"
                                        }
                                    },
                                    "DeleteUser_Analyze_Phase1_Provisioning_Results": {
                                        "runAfter": {
                                            "DeleteUser_Phase1_Verify_Creation_And_Provisioning": [
                                                "Succeeded",
                                                "Failed",
                                                "TimedOut"
                                            ],
                                            "DeleteUser_Capture_Phase1_Failed_Actions": [
                                                "Succeeded",
                                                "Skipped"
                                            ],
                                            "DeleteUser_Set_Phase1_Status_Success": [
                                                "Succeeded",
                                                "Skipped"
                                            ]
                                        },
                                        "type": "Compose",
                                        "inputs": {
                                            "provisioningLogsCount": "@length(coalesce(body('DeleteUser_Verify_Provisioning_Logs')?['value'], json('[]')))",
                                            "hasProvisioningLogs": "@greater(length(coalesce(body('DeleteUser_Verify_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                            "provisioningStatus": "@if(greater(length(coalesce(body('DeleteUser_Verify_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('DeleteUser_Verify_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                            "provisioningResult": "@if(equals(variables('DeleteUserScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('DeleteUser_Verify_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('DeleteUser_Verify_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('DeleteUserFailedActionName')))",
                                            "provisioningErrorDetails": "@if(equals(variables('DeleteUserScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('DeleteUser_Verify_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('DeleteUser_Verify_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('DeleteUser_Verify_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('DeleteUserFailedActionResponse'))",
                                            "overallResult": "@if(equals(variables('DeleteUserScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('DeleteUser_Verify_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('DeleteUser_Verify_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                        }
                                    },
                                    "DeleteUser_Set_Phase1_Output_Variables": {
                                        "actions": {
                                            "DeleteUser_Set_DeleteUserTestOutputs_Phase1": {
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DeleteUserTestOutputs",
                                                    "value": {
                                                        "overallResult": "@outputs('DeleteUser_Analyze_Phase1_Provisioning_Results')?['overallResult']",
                                                        "result": "@outputs('DeleteUser_Analyze_Phase1_Provisioning_Results')?['provisioningResult']",
                                                        "errorDetails": "@outputs('DeleteUser_Analyze_Phase1_Provisioning_Results')?['provisioningErrorDetails']"
                                                    }
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "DeleteUser_Analyze_Phase1_Provisioning_Results": [
                                                "Succeeded",
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    },
                                    "DeleteUser_Check_Phase1_Status": {
                                        "actions": {
                                            "DeleteUser_Phase2_Verify_Deletion_And_Provisioning": {
                                                "actions": {
                                                    "DeleteUser_Query_User_By_Id": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['deleteUser'], ''), '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "DeleteUser_Delete_User_From_Graph": {
                                                        "runAfter": {
                                                            "DeleteUser_Query_User_By_Id": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "https://graph.microsoft.com/beta/users/@{body('DeleteUser_Create_Delete_User_Graph')?['id']}",
                                                            "method": "DELETE",
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "DeleteUser_DoUntil_Wait_For_User_Deletion": {
                                                        "actions": {
                                                            "DeleteUser_Check_User_Deleted": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['deleteUser'], ''), '%22')}",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                        "Accept": "@{parameters('scimContentType')}"
                                                                    }
                                                                }
                                                            },
                                                            "DeleteUser_Delay_Deletion_15s": {
                                                                "runAfter": {
                                                                    "DeleteUser_Check_User_Deleted": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "DeleteUser_Delete_User_From_Graph": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "expression": "@or(equals(length(coalesce(body('DeleteUser_Check_User_Deleted')?['Resources'], json('[]'))), 0), if(parameters('IsSoftDeleted'), and(greater(length(coalesce(body('DeleteUser_Check_User_Deleted')?['Resources'], json('[]'))), 0), equals(first(body('DeleteUser_Check_User_Deleted')?['Resources'])?['active'], false)), false))",
                                                        "limit": {
                                                            "count": 150,
                                                            "timeout": "PT40M"
                                                        },
                                                        "type": "Until"
                                                    },
                                                    "DeleteUser_DoUntil_Poll_Delete_Provisioning_Logs": {
                                                        "actions": {
                                                            "DeleteUser_Verify_Delete_Provisioning_Logs": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('DeleteUser_Create_Delete_User_Graph')?['id'], '%27%20and%20provisioningAction%20eq%20%27', if(parameters('IsSoftDeleted'), 'Disable', 'Delete'), '%27&$orderby=activityDateTime%20desc&$top=1')}",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Accept": "application/json"
                                                                    },
                                                                    "authentication": {
                                                                        "type": "ManagedServiceIdentity",
                                                                        "audience": "https://graph.microsoft.com/"
                                                                    }
                                                                }
                                                            },
                                                            "DeleteUser_Delay_Delete_Provisioning_Logs_15s": {
                                                                "runAfter": {
                                                                    "DeleteUser_Verify_Delete_Provisioning_Logs": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "DeleteUser_DoUntil_Wait_For_User_Deletion": [
                                                                "Succeeded",
                                                                "Failed",
                                                                "TimedOut"
                                                            ]
                                                        },
                                                        "expression": "@greater(length(coalesce(body('DeleteUser_Verify_Delete_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                        "limit": {
                                                            "count": 150,
                                                            "timeout": "PT15M"
                                                        },
                                                        "type": "Until"
                                                    }
                                                },
                                                "type": "Scope"
                                            },
                                            "DeleteUser_Capture_Phase2_Failed_Actions": {
                                                "actions": {
                                                    "DeleteUser_Get_Phase2_Failed_Actions": {
                                                        "type": "Compose",
                                                        "inputs": "@result('DeleteUser_Phase2_Verify_Deletion_And_Provisioning')"
                                                    },
                                                    "DeleteUser_Filter_Phase2_Failed_Actions": {
                                                        "runAfter": {
                                                            "DeleteUser_Get_Phase2_Failed_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Query",
                                                        "inputs": {
                                                            "from": "@outputs('DeleteUser_Get_Phase2_Failed_Actions')",
                                                            "where": "@equals(item()?['status'], 'Failed')"
                                                        }
                                                    },
                                                    "DeleteUser_Set_Phase2_Failed_Action_Name": {
                                                        "runAfter": {
                                                            "DeleteUser_Filter_Phase2_Failed_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "DeleteUserFailedActionName",
                                                            "value": "@{if(greater(length(body('DeleteUser_Filter_Phase2_Failed_Actions')), 0), first(body('DeleteUser_Filter_Phase2_Failed_Actions'))?['name'], 'Unknown_Action')}"
                                                        }
                                                    },
                                                    "DeleteUser_Set_Phase2_Failed_Action_Response": {
                                                        "runAfter": {
                                                            "DeleteUser_Set_Phase2_Failed_Action_Name": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "DeleteUserFailedActionResponse",
                                                            "value": "@if(greater(length(body('DeleteUser_Filter_Phase2_Failed_Actions')), 0), coalesce(first(body('DeleteUser_Filter_Phase2_Failed_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                        }
                                                    },
                                                    "DeleteUser_Set_Phase2_Status_Failed": {
                                                        "runAfter": {
                                                            "DeleteUser_Set_Phase2_Failed_Action_Response": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "DeleteUserScopeExecutionStatus",
                                                            "value": "Failed"
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "DeleteUser_Phase2_Verify_Deletion_And_Provisioning": [
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            },
                                            "DeleteUser_Set_Phase2_Status_Success": {
                                                "runAfter": {
                                                    "DeleteUser_Phase2_Verify_Deletion_And_Provisioning": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DeleteUserScopeExecutionStatus",
                                                    "value": "Succeeded"
                                                }
                                            },
                                            "DeleteUser_Analyze_Phase2_Provisioning_Results": {
                                                "runAfter": {
                                                    "DeleteUser_Phase2_Verify_Deletion_And_Provisioning": [
                                                        "Succeeded",
                                                        "Failed",
                                                        "TimedOut"
                                                    ],
                                                    "DeleteUser_Capture_Phase2_Failed_Actions": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ],
                                                    "DeleteUser_Set_Phase2_Status_Success": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ]
                                                },
                                                "type": "Compose",
                                                "inputs": {
                                                    "provisioningLogsCount": "@length(coalesce(body('DeleteUser_Verify_Delete_Provisioning_Logs')?['value'], json('[]')))",
                                                    "hasProvisioningLogs": "@greater(length(coalesce(body('DeleteUser_Verify_Delete_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                    "provisioningStatus": "@if(greater(length(coalesce(body('DeleteUser_Verify_Delete_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('DeleteUser_Verify_Delete_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                                    "provisioningResult": "@if(equals(variables('DeleteUserScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('DeleteUser_Verify_Delete_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('DeleteUser_Verify_Delete_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('DeleteUserFailedActionName')))",
                                                    "provisioningErrorDetails": "@if(equals(variables('DeleteUserScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('DeleteUser_Verify_Delete_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('DeleteUser_Verify_Delete_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('DeleteUser_Verify_Delete_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('DeleteUserFailedActionResponse'))",
                                                    "overallResult": "@if(equals(variables('DeleteUserScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('DeleteUser_Verify_Delete_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('DeleteUser_Verify_Delete_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                                }
                                            },
                                            "DeleteUser_Set_Phase2_Output_Variables": {
                                                "actions": {
                                                    "DeleteUser_Set_DeleteUserTestOutputs_Phase2": {
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "DeleteUserTestOutputs",
                                                            "value": {
                                                                "overallResult": "@outputs('DeleteUser_Analyze_Phase2_Provisioning_Results')?['overallResult']",
                                                                "result": "@outputs('DeleteUser_Analyze_Phase2_Provisioning_Results')?['provisioningResult']",
                                                                "errorDetails": "@outputs('DeleteUser_Analyze_Phase2_Provisioning_Results')?['provisioningErrorDetails']"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "DeleteUser_Analyze_Phase2_Provisioning_Results": [
                                                        "Succeeded",
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            }
                                        },
                                        "runAfter": {
                                            "DeleteUser_Set_Phase1_Output_Variables": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped"
                                            ]
                                        },
                                        "else": {
                                            "actions": {}
                                        },
                                        "expression": {
                                            "and": [
                                                {
                                                    "equals": [
                                                        "@toLower(variables('DeleteUserTestOutputs')['overallResult'])",
                                                        "passed"
                                                    ]
                                                }
                                            ]
                                        },
                                        "type": "If"
                                    }
                                },
                                "type": "Scope"
                            }
                        },
                        "else": {
                            "actions": {}
                        },
                        "expression": {
                            "or": [
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "All"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "UserTests"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "Delete_User_Test"
                                    ]
                                }
                            ]
                        },
                        "type": "If"
                    },
                    "User_Update_Manager_Test": {
                        "actions": {
                            "User_Update_Manager_Test_Actions": {
                                "actions": {
                                    "Phase1_Create_Users_And_Initial_Sync": {
                                        "actions": {
                                            "Step1_Check_User_Exists": {
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['managerUser'], ''), '%22')}",
                                                    "method": "GET",
                                                    "headers": {
                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                        "Accept": "@{parameters('scimContentType')}"
                                                    }
                                                }
                                            },
                                            "Step2_Create_Test_User": {
                                                "runAfter": {
                                                    "Step1_Check_User_Exists": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "accountEnabled": true,
                                                        "displayName": "@{outputs('Generate_Test_UserNames')['managerUser']}",
                                                        "mailNickname": "@{replace(first(split(outputs('Generate_Test_UserNames')['managerUser'],'@')),'.','')}",
                                                        "userPrincipalName": "@{outputs('Generate_Test_UserNames')['managerUser']}",
                                                        "givenName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName']), concat('Given', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName'])}",
                                                        "surname": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname']), concat('Sur', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname'])}",
                                                        "jobTitle": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle']), concat('Title', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle'])}",
                                                        "department": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department']), concat('Dept', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department'])}",
                                                        "companyName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName']), concat('Company', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName'])}",
                                                        "businessPhones": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['businessPhones'], json(concat('[\"+ 1-555-', substring(guid(),0,4), '\"]')))",
                                                        "mobilePhone": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone'])}",
                                                        "officeLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation']), concat('Office', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation'])}",
                                                        "preferredLanguage": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage']), 'en-US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage'])}",
                                                        "employeeId": "@{substring(guid(), 0, 8)}",
                                                        "employeeType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType']), 'Employee', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType'])}",
                                                        "streetAddress": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress']), concat('Street', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress'])}",
                                                        "city": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city']), concat('City', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city'])}",
                                                        "state": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state']), 'WA', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state'])}",
                                                        "country": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country'])}",
                                                        "postalCode": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode'])}",
                                                        "usageLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation'])}",
                                                        "otherMails": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['otherMails'], json(concat('[\"', substring(guid(),0,8), '@example.com\"]')))",
                                                        "mail": "@{outputs('Generate_Test_UserNames')['managerUser']}",
                                                        "faxNumber": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber'])}",
                                                        "userType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType']), 'Member', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType'])}",
                                                        "employeeOrgData": "@if(or(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'])), json(concat('{\"division\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), concat('Div', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), '\",\"costCenter\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), '\"}')), json(concat('{\"division\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division'], '\",\"costCenter\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'], '\"}')))",
                                                        "passwordProfile": {
                                                            "forceChangePasswordNextSignIn": "@{coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['forceChangePasswordNextSignIn'], true)}",
                                                            "password": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['password']), concat('Tmp!', substring(guid(),0,8), '@', substring(guid(),24,8)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['password'])}"
                                                        }
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Step3_Create_Initial_Manager": {
                                                "runAfter": {
                                                    "Step2_Create_Test_User": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "accountEnabled": true,
                                                        "displayName": "Initial Manager User",
                                                        "mailNickname": "@{replace(first(split(outputs('Generate_Test_UserNames')['managerUserInitial'],'@')),'.','')}",
                                                        "userPrincipalName": "@{outputs('Generate_Test_UserNames')['managerUserInitial']}",
                                                        "givenName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName']), concat('Given', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName'])}",
                                                        "surname": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname']), concat('Sur', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname'])}",
                                                        "jobTitle": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle']), concat('Title', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle'])}",
                                                        "department": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department']), concat('Dept', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department'])}",
                                                        "companyName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName']), concat('Company', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName'])}",
                                                        "businessPhones": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['businessPhones'], json(concat('[\"+ 1-555-', substring(guid(),0,4), '\"]')))",
                                                        "mobilePhone": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone'])}",
                                                        "officeLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation']), concat('Office', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation'])}",
                                                        "preferredLanguage": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage']), 'en-US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage'])}",
                                                        "employeeId": "@{substring(guid(), 0, 8)}",
                                                        "employeeType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType']), 'Employee', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType'])}",
                                                        "streetAddress": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress']), concat('Street', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress'])}",
                                                        "city": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city']), concat('City', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city'])}",
                                                        "state": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state']), 'WA', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state'])}",
                                                        "country": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country'])}",
                                                        "postalCode": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode'])}",
                                                        "usageLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation'])}",
                                                        "otherMails": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['otherMails'], json(concat('[\"', substring(guid(),0,8), '@example.com\"]')))",
                                                        "mail": "@{outputs('Generate_Test_UserNames')['managerUserInitial']}",
                                                        "faxNumber": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber'])}",
                                                        "userType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType']), 'Member', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType'])}",
                                                        "employeeOrgData": "@if(or(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'])), json(concat('{\"division\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), concat('Div', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), '\",\"costCenter\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), '\"}')), json(concat('{\"division\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division'], '\",\"costCenter\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'], '\"}')))",
                                                        "passwordProfile": {
                                                            "forceChangePasswordNextSignIn": "@{coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['forceChangePasswordNextSignIn'], true)}",
                                                            "password": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['password']), concat('Tmp!', substring(guid(),0,8), '@', substring(guid(),24,8)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['password'])}"
                                                        }
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Step4_Create_New_Manager": {
                                                "runAfter": {
                                                    "Step3_Create_Initial_Manager": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "accountEnabled": true,
                                                        "displayName": "New Manager User",
                                                        "mailNickname": "newmanageruser",
                                                        "userPrincipalName": "@{outputs('Generate_Test_UserNames')['managerUserNew']}",
                                                        "givenName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName']), concat('Given', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName'])}",
                                                        "surname": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname']), concat('Sur', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname'])}",
                                                        "jobTitle": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle']), concat('Title', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle'])}",
                                                        "department": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department']), concat('Dept', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department'])}",
                                                        "companyName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName']), concat('Company', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName'])}",
                                                        "businessPhones": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['businessPhones'], json(concat('[\"+ 1-555-', substring(guid(),0,4), '\"]')))",
                                                        "mobilePhone": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone'])}",
                                                        "officeLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation']), concat('Office', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation'])}",
                                                        "preferredLanguage": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage']), 'en-US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage'])}",
                                                        "employeeId": "@{substring(guid(), 0, 8)}",
                                                        "employeeType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType']), 'Employee', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType'])}",
                                                        "streetAddress": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress']), concat('Street', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress'])}",
                                                        "city": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city']), concat('City', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city'])}",
                                                        "state": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state']), 'WA', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state'])}",
                                                        "country": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country'])}",
                                                        "postalCode": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode'])}",
                                                        "usageLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation'])}",
                                                        "otherMails": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['otherMails'], json(concat('[\"', substring(guid(),0,8), '@example.com\"]')))",
                                                        "mail": "@{outputs('Generate_Test_UserNames')['managerUserNew']}",
                                                        "faxNumber": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber'])}",
                                                        "userType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType']), 'Member', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType'])}",
                                                        "employeeOrgData": "@if(or(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'])), json(concat('{\"division\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), concat('Div', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), '\",\"costCenter\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), '\"}')), json(concat('{\"division\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division'], '\",\"costCenter\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'], '\"}')))",
                                                        "passwordProfile": {
                                                            "forceChangePasswordNextSignIn": "@{coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['forceChangePasswordNextSignIn'], true)}",
                                                            "password": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['password']), concat('Tmp!', substring(guid(),0,8), '@', substring(guid(),24,8)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['password'])}"
                                                        }
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Step5_Assign_Test_User_To_App": {
                                                "runAfter": {
                                                    "Step4_Create_New_Manager": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users/@{body('Step2_Create_Test_User')?['id']}/appRoleAssignments",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "principalId": "@{body('Step2_Create_Test_User')?['id']}",
                                                        "resourceId": "@{parameters('servicePrincipalId')}",
                                                        "appRoleId": "@{first(body('Get_App_Roles')?['appRoles'])?['id']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Step6_Assign_Initial_Manager_To_App": {
                                                "runAfter": {
                                                    "Step5_Assign_Test_User_To_App": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users/@{body('Step3_Create_Initial_Manager')?['id']}/appRoleAssignments",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "principalId": "@{body('Step3_Create_Initial_Manager')?['id']}",
                                                        "resourceId": "@{parameters('servicePrincipalId')}",
                                                        "appRoleId": "@{first(body('Get_App_Roles')?['appRoles'])?['id']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Step7_Assign_New_Manager_To_App": {
                                                "runAfter": {
                                                    "Step6_Assign_Initial_Manager_To_App": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users/@{body('Step4_Create_New_Manager')?['id']}/appRoleAssignments",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "principalId": "@{body('Step4_Create_New_Manager')?['id']}",
                                                        "resourceId": "@{parameters('servicePrincipalId')}",
                                                        "appRoleId": "@{first(body('Get_App_Roles')?['appRoles'])?['id']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "DoUntil_Poll_All_Users_Created": {
                                                "actions": {
                                                    "SCIM_Query_Test_User": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['managerUser'], ''), '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "SCIM_Query_Initial_Manager": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['managerUserInitial'], ''), '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "SCIM_Query_New_Manager": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['managerUserNew'], ''), '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "Delay_15s": {
                                                        "runAfter": {
                                                            "SCIM_Query_Test_User": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ],
                                                            "SCIM_Query_Initial_Manager": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ],
                                                            "SCIM_Query_New_Manager": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Step7_Assign_New_Manager_To_App": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "expression": "@and(and(greater(length(coalesce(body('SCIM_Query_Test_User')?['Resources'], json('[]'))), 0), greater(length(coalesce(body('SCIM_Query_Initial_Manager')?['Resources'], json('[]'))), 0)), greater(length(coalesce(body('SCIM_Query_New_Manager')?['Resources'], json('[]'))), 0))",
                                                "limit": {
                                                    "count": 150,
                                                    "timeout": "PT40M"
                                                },
                                                "type": "Until"
                                            },
                                            "DoUntil_Poll_Initial_Provisioning_Logs": {
                                                "actions": {
                                                    "Verify_Test_User_Provisioning_Logs": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Step2_Create_Test_User')?['id'], '%27%20and%20provisioningAction%20eq%20%27Create%27')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Accept": "application/json"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "Verify_Initial_Manager_Provisioning_Logs": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Step3_Create_Initial_Manager')?['id'], '%27%20and%20provisioningAction%20eq%20%27Create%27')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Accept": "application/json"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "Verify_New_Manager_Provisioning_Logs": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Step4_Create_New_Manager')?['id'], '%27%20and%20provisioningAction%20eq%20%27Create%27')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Accept": "application/json"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "ManagerTest_Delay_Provisioning_Logs_15s": {
                                                        "runAfter": {
                                                            "Verify_Test_User_Provisioning_Logs": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ],
                                                            "Verify_Initial_Manager_Provisioning_Logs": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ],
                                                            "Verify_New_Manager_Provisioning_Logs": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "DoUntil_Poll_All_Users_Created": [
                                                        "Succeeded",
                                                        "Failed",
                                                        "TimedOut"
                                                    ]
                                                },
                                                "expression": "@and(and(greater(length(coalesce(body('Verify_Test_User_Provisioning_Logs')?['value'], json('[]'))), 0), greater(length(coalesce(body('Verify_Initial_Manager_Provisioning_Logs')?['value'], json('[]'))), 0)), greater(length(coalesce(body('Verify_New_Manager_Provisioning_Logs')?['value'], json('[]'))), 0))",
                                                "limit": {
                                                    "count": 150,
                                                    "timeout": "PT15M"
                                                },
                                                "type": "Until"
                                            }
                                        },
                                        "type": "Scope"
                                    },
                                    "Capture_Phase1_Failed_Actions": {
                                        "actions": {
                                            "Get_Phase1_Failed_Actions": {
                                                "type": "Compose",
                                                "inputs": "@result('Phase1_Create_Users_And_Initial_Sync')"
                                            },
                                            "Filter_Phase1_Failed_Actions": {
                                                "runAfter": {
                                                    "Get_Phase1_Failed_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Query",
                                                "inputs": {
                                                    "from": "@outputs('Get_Phase1_Failed_Actions')",
                                                    "where": "@equals(item()?['status'], 'Failed')"
                                                }
                                            },
                                            "Set_Phase1_Failed_Action_Name": {
                                                "runAfter": {
                                                    "Filter_Phase1_Failed_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "ManagerTestFailedActionName",
                                                    "value": "@{if(greater(length(body('Filter_Phase1_Failed_Actions')), 0), first(body('Filter_Phase1_Failed_Actions'))?['name'], 'Unknown_Action')}"
                                                }
                                            },
                                            "Set_Phase1_Failed_Action_Response": {
                                                "runAfter": {
                                                    "Set_Phase1_Failed_Action_Name": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "ManagerTestFailedActionResponse",
                                                    "value": "@if(greater(length(body('Filter_Phase1_Failed_Actions')), 0), coalesce(first(body('Filter_Phase1_Failed_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                }
                                            },
                                            "Set_Phase1_Status_Failed": {
                                                "runAfter": {
                                                    "Set_Phase1_Failed_Action_Response": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "ManagerTestScopeExecutionStatus",
                                                    "value": "Failed"
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Phase1_Create_Users_And_Initial_Sync": [
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    },
                                    "Set_Phase1_Status_Success": {
                                        "runAfter": {
                                            "Phase1_Create_Users_And_Initial_Sync": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "ManagerTestScopeExecutionStatus",
                                            "value": "Succeeded"
                                        }
                                    },
                                    "Analyze_Phase1_Provisioning_Results": {
                                        "runAfter": {
                                            "Phase1_Create_Users_And_Initial_Sync": [
                                                "Succeeded",
                                                "Failed",
                                                "TimedOut"
                                            ],
                                            "Capture_Phase1_Failed_Actions": [
                                                "Succeeded",
                                                "Skipped"
                                            ],
                                            "Set_Phase1_Status_Success": [
                                                "Succeeded",
                                                "Skipped"
                                            ]
                                        },
                                        "type": "Compose",
                                        "inputs": {
                                            "provisioningResult": "@if(equals(variables('ManagerTestScopeExecutionStatus'), 'Succeeded'), if(and(and(greater(length(coalesce(body('Verify_Test_User_Provisioning_Logs')?['value'], json('[]'))), 0), greater(length(coalesce(body('Verify_Initial_Manager_Provisioning_Logs')?['value'], json('[]'))), 0)), greater(length(coalesce(body('Verify_New_Manager_Provisioning_Logs')?['value'], json('[]'))), 0)), 'All Users Created', 'PROVISIONING_LOGS_MISSING'), concat('Failed Action: ', variables('ManagerTestFailedActionName')))",
                                            "provisioningErrorDetails": "@if(equals(variables('ManagerTestScopeExecutionStatus'), 'Succeeded'), if(or(or(equals(toLower(coalesce(first(body('Verify_Test_User_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'failure'), equals(toLower(coalesce(first(body('Verify_Initial_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'failure')), equals(toLower(coalesce(first(body('Verify_New_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'failure')), json(concat('{\"testUser\":', string(coalesce(first(body('Verify_Test_User_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null)), ',\"initialManager\":', string(coalesce(first(body('Verify_Initial_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null)), ',\"newManager\":', string(coalesce(first(body('Verify_New_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null)), '}')), null), variables('ManagerTestFailedActionResponse'))",
                                            "overallResult": "@if(equals(variables('ManagerTestScopeExecutionStatus'), 'Succeeded'), if(and(and(and(greater(length(coalesce(body('Verify_Test_User_Provisioning_Logs')?['value'], json('[]'))), 0), greater(length(coalesce(body('Verify_Initial_Manager_Provisioning_Logs')?['value'], json('[]'))), 0)), greater(length(coalesce(body('Verify_New_Manager_Provisioning_Logs')?['value'], json('[]'))), 0)), not(or(or(equals(toLower(coalesce(first(body('Verify_Test_User_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'failure'), equals(toLower(coalesce(first(body('Verify_Initial_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'failure')), equals(toLower(coalesce(first(body('Verify_New_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'failure')))), 'PASSED', 'FAILED'), 'FAILED')"
                                        }
                                    },
                                    "Set_Phase1_Output_Variables": {
                                        "actions": {
                                            "Set_ManagerTestOutputs_Phase1": {
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "ManagerTestOutputs",
                                                    "value": {
                                                        "overallResult": "@outputs('Analyze_Phase1_Provisioning_Results')?['overallResult']",
                                                        "result": "@outputs('Analyze_Phase1_Provisioning_Results')?['provisioningResult']",
                                                        "errorDetails": "@outputs('Analyze_Phase1_Provisioning_Results')?['provisioningErrorDetails']"
                                                    }
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Analyze_Phase1_Provisioning_Results": [
                                                "Succeeded",
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    },
                                    "Cleanup_Delete_Test_User": {
                                        "runAfter": {
                                            "Check_Phase1_Status": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped",
                                                "TimedOut"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "https://graph.microsoft.com/beta/users/@{body('Step2_Create_Test_User')?['id']}",
                                            "method": "DELETE",
                                            "authentication": {
                                                "type": "ManagedServiceIdentity",
                                                "audience": "https://graph.microsoft.com/"
                                            }
                                        }
                                    },
                                    "Cleanup_Delete_Initial_Manager": {
                                        "runAfter": {
                                            "Cleanup_Delete_Test_User": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped",
                                                "TimedOut"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "https://graph.microsoft.com/beta/users/@{body('Step3_Create_Initial_Manager')?['id']}",
                                            "method": "DELETE",
                                            "authentication": {
                                                "type": "ManagedServiceIdentity",
                                                "audience": "https://graph.microsoft.com/"
                                            }
                                        }
                                    },
                                    "Cleanup_Delete_New_Manager": {
                                        "runAfter": {
                                            "Cleanup_Delete_Initial_Manager": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped",
                                                "TimedOut"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "https://graph.microsoft.com/beta/users/@{body('Step4_Create_New_Manager')?['id']}",
                                            "method": "DELETE",
                                            "authentication": {
                                                "type": "ManagedServiceIdentity",
                                                "audience": "https://graph.microsoft.com/"
                                            }
                                        }
                                    },
                                    "Check_Phase1_Status": {
                                        "actions": {
                                            "Phase2_Set_Manager": {
                                                "actions": {
                                                    "Step1_Set_Manager_Relationship": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "https://graph.microsoft.com/beta/users/@{body('Step2_Create_Test_User')?['id']}/manager/$ref",
                                                            "method": "PUT",
                                                            "headers": {
                                                                "Content-Type": "application/json"
                                                            },
                                                            "body": {
                                                                "@@odata.id": "https://graph.microsoft.com/beta/users/@{body('Step3_Create_Initial_Manager')?['id']}"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "DoUntil_Wait_For_Manager_Set": {
                                                        "actions": {
                                                            "SCIM_Verify_Manager_Set": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['managerUser'], ''), '%22')}",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                        "Accept": "@{parameters('scimContentType')}"
                                                                    }
                                                                }
                                                            },
                                                            "Delay_Manager_Set_15s": {
                                                                "runAfter": {
                                                                    "SCIM_Verify_Manager_Set": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Step1_Set_Manager_Relationship": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "expression": "@and(greater(length(coalesce(body('SCIM_Verify_Manager_Set')?['Resources'], json('[]'))), 0), contains(string(body('SCIM_Verify_Manager_Set')), first(body('SCIM_Query_Initial_Manager')?['Resources'])?['id']))",
                                                        "limit": {
                                                            "count": 150,
                                                            "timeout": "PT40M"
                                                        },
                                                        "type": "Until"
                                                    },
                                                    "DoUntil_Poll_Set_Manager_Provisioning_Logs": {
                                                        "actions": {
                                                            "Verify_Set_Manager_Provisioning_Logs": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Step2_Create_Test_User')?['id'], '%27%20and%20provisioningAction%20eq%20%27Update%27%20and%20modifiedProperties/any(p:%20p/displayName%20eq%20%27manager%27%20or%20p/displayName%20eq%20%27urn:ietf:params:scim:schemas:extension:enterprise:2.0:User:manager%27)')}",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Accept": "application/json"
                                                                    },
                                                                    "authentication": {
                                                                        "type": "ManagedServiceIdentity",
                                                                        "audience": "https://graph.microsoft.com/"
                                                                    }
                                                                }
                                                            },
                                                            "Delay_Set_Manager_Provisioning_Logs_15s": {
                                                                "runAfter": {
                                                                    "Verify_Set_Manager_Provisioning_Logs": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "DoUntil_Wait_For_Manager_Set": [
                                                                "Succeeded",
                                                                "Failed",
                                                                "TimedOut"
                                                            ]
                                                        },
                                                        "expression": "@and(greater(length(coalesce(body('Verify_Set_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), and(or(empty(first(body('Verify_Set_Manager_Provisioning_Logs')?['value'])?['modifiedProperties'][0]?['oldValue']), equals(first(body('Verify_Set_Manager_Provisioning_Logs')?['value'])?['modifiedProperties'][0]?['oldValue'], 'null')), equals(first(body('Verify_Set_Manager_Provisioning_Logs')?['value'])?['modifiedProperties'][0]?['newValue'], body('SCIM_Query_Initial_Manager')?['id'])))",
                                                        "limit": {
                                                            "count": 150,
                                                            "timeout": "PT15M"
                                                        },
                                                        "type": "Until"
                                                    }
                                                },
                                                "type": "Scope"
                                            },
                                            "Capture_Phase2_Failed_Actions": {
                                                "actions": {
                                                    "Get_Phase2_Failed_Actions": {
                                                        "type": "Compose",
                                                        "inputs": "@result('Phase2_Set_Manager')"
                                                    },
                                                    "Filter_Phase2_Failed_Actions": {
                                                        "runAfter": {
                                                            "Get_Phase2_Failed_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Query",
                                                        "inputs": {
                                                            "from": "@outputs('Get_Phase2_Failed_Actions')",
                                                            "where": "@equals(item()?['status'], 'Failed')"
                                                        }
                                                    },
                                                    "Set_Phase2_Failed_Action_Name": {
                                                        "runAfter": {
                                                            "Filter_Phase2_Failed_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "ManagerTestFailedActionName",
                                                            "value": "@{if(greater(length(body('Filter_Phase2_Failed_Actions')), 0), first(body('Filter_Phase2_Failed_Actions'))?['name'], 'Unknown_Action')}"
                                                        }
                                                    },
                                                    "Set_Phase2_Failed_Action_Response": {
                                                        "runAfter": {
                                                            "Set_Phase2_Failed_Action_Name": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "ManagerTestFailedActionResponse",
                                                            "value": "@{if(greater(length(body('Filter_Phase2_Failed_Actions')), 0), coalesce(first(body('Filter_Phase2_Failed_Actions'))?['outputs'], json('{}')), json('{}'))}"
                                                        }
                                                    },
                                                    "Set_Phase2_Status_Failed": {
                                                        "runAfter": {
                                                            "Set_Phase2_Failed_Action_Response": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "ManagerTestScopeExecutionStatus",
                                                            "value": "Failed"
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Phase2_Set_Manager": [
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            },
                                            "Set_Phase2_Status_Success": {
                                                "runAfter": {
                                                    "Phase2_Set_Manager": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "ManagerTestScopeExecutionStatus",
                                                    "value": "Succeeded"
                                                }
                                            },
                                            "Analyze_Phase2_Provisioning_Results": {
                                                "runAfter": {
                                                    "Phase2_Set_Manager": [
                                                        "Succeeded",
                                                        "Failed",
                                                        "TimedOut"
                                                    ],
                                                    "Capture_Phase2_Failed_Actions": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ],
                                                    "Set_Phase2_Status_Success": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ]
                                                },
                                                "type": "Compose",
                                                "inputs": {
                                                    "setManagerProvisioningStatus": "@if(greater(length(coalesce(body('Verify_Set_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Verify_Set_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                                    "hasProvisioningLogs": "@greater(length(coalesce(body('Verify_Set_Manager_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                    "hasFailures": "@equals(toLower(coalesce(first(body('Verify_Set_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'failure')",
                                                    "provisioningResult": "@if(equals(variables('ManagerTestScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('Verify_Set_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Verify_Set_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('ManagerTestFailedActionName')))",
                                                    "provisioningErrorDetails": "@if(equals(variables('ManagerTestScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Verify_Set_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Verify_Set_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('Verify_Set_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('ManagerTestFailedActionResponse'))",
                                                    "overallResult": "@if(equals(variables('ManagerTestScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Verify_Set_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('Verify_Set_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                                }
                                            },
                                            "Set_Phase2_Output_Variables": {
                                                "actions": {
                                                    "Set_ManagerTestOutputs_Phase2": {
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "ManagerTestOutputs",
                                                            "value": {
                                                                "overallResult": "@outputs('Analyze_Phase2_Provisioning_Results')?['overallResult']",
                                                                "result": "@outputs('Analyze_Phase2_Provisioning_Results')?['provisioningResult']",
                                                                "errorDetails": "@outputs('Analyze_Phase2_Provisioning_Results')?['provisioningErrorDetails']"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Analyze_Phase2_Provisioning_Results": [
                                                        "Succeeded",
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            },
                                            "Check_Phase2_Status": {
                                                "actions": {
                                                    "Phase3_Change_Manager": {
                                                        "actions": {
                                                            "Step1_Change_Manager_Relationship": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "https://graph.microsoft.com/beta/users/@{body('Step2_Create_Test_User')?['id']}/manager/$ref",
                                                                    "method": "PUT",
                                                                    "headers": {
                                                                        "Content-Type": "application/json"
                                                                    },
                                                                    "body": {
                                                                        "@@odata.id": "https://graph.microsoft.com/beta/users/@{body('Step4_Create_New_Manager')?['id']}"
                                                                    },
                                                                    "authentication": {
                                                                        "type": "ManagedServiceIdentity",
                                                                        "audience": "https://graph.microsoft.com/"
                                                                    }
                                                                }
                                                            },
                                                            "DoUntil_Wait_For_Manager_Change": {
                                                                "actions": {
                                                                    "SCIM_Verify_Manager_Change": {
                                                                        "type": "Http",
                                                                        "inputs": {
                                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['managerUser'], ''), '%22')}",
                                                                            "method": "GET",
                                                                            "headers": {
                                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                                "Accept": "@{parameters('scimContentType')}"
                                                                            }
                                                                        }
                                                                    },
                                                                    "Delay_Manager_Change_15s": {
                                                                        "runAfter": {
                                                                            "SCIM_Verify_Manager_Change": [
                                                                                "Succeeded",
                                                                                "Failed"
                                                                            ]
                                                                        },
                                                                        "type": "Wait",
                                                                        "inputs": {
                                                                            "interval": {
                                                                                "count": 15,
                                                                                "unit": "Second"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "Step1_Change_Manager_Relationship": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "expression": "@and(greater(length(coalesce(body('SCIM_Verify_Manager_Change')?['Resources'], json('[]'))), 0), contains(string(body('SCIM_Verify_Manager_Change')), first(body('SCIM_Query_New_Manager')?['Resources'])?['id']))",
                                                                "limit": {
                                                                    "count": 150,
                                                                    "timeout": "PT40M"
                                                                },
                                                                "type": "Until"
                                                            },
                                                            "DoUntil_Poll_Change_Manager_Provisioning_Logs": {
                                                                "actions": {
                                                                    "Verify_Change_Manager_Provisioning_Logs": {
                                                                        "type": "Http",
                                                                        "inputs": {
                                                                            "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Step2_Create_Test_User')?['id'], '%27%20and%20provisioningAction%20eq%20%27Update%27%20and%20modifiedProperties/any(p:%20p/displayName%20eq%20%27manager%27%20or%20p/displayName%20eq%20%27urn:ietf:params:scim:schemas:extension:enterprise:2.0:User:manager%27)')}",
                                                                            "method": "GET",
                                                                            "headers": {
                                                                                "Accept": "application/json"
                                                                            },
                                                                            "authentication": {
                                                                                "type": "ManagedServiceIdentity",
                                                                                "audience": "https://graph.microsoft.com/"
                                                                            }
                                                                        }
                                                                    },
                                                                    "Delay_Change_Manager_Provisioning_Logs_15s": {
                                                                        "runAfter": {
                                                                            "Verify_Change_Manager_Provisioning_Logs": [
                                                                                "Succeeded",
                                                                                "Failed"
                                                                            ]
                                                                        },
                                                                        "type": "Wait",
                                                                        "inputs": {
                                                                            "interval": {
                                                                                "count": 15,
                                                                                "unit": "Second"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "DoUntil_Wait_For_Manager_Change": [
                                                                        "Succeeded",
                                                                        "Failed",
                                                                        "TimedOut"
                                                                    ]
                                                                },
                                                                "expression": "@and(greater(length(coalesce(body('Verify_Change_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), equals(first(body('Verify_Change_Manager_Provisioning_Logs')?['value'])?['modifiedProperties'][0]?['newValue'], body('SCIM_Query_New_Manager')?['id']))",
                                                                "limit": {
                                                                    "count": 150,
                                                                    "timeout": "PT15M"
                                                                },
                                                                "type": "Until"
                                                            }
                                                        },
                                                        "type": "Scope"
                                                    },
                                                    "Capture_Phase3_Failed_Actions": {
                                                        "actions": {
                                                            "Get_Phase3_Failed_Actions": {
                                                                "type": "Compose",
                                                                "inputs": "@result('Phase3_Change_Manager')"
                                                            },
                                                            "Filter_Phase3_Failed_Actions": {
                                                                "runAfter": {
                                                                    "Get_Phase3_Failed_Actions": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Query",
                                                                "inputs": {
                                                                    "from": "@outputs('Get_Phase3_Failed_Actions')",
                                                                    "where": "@equals(item()?['status'], 'Failed')"
                                                                }
                                                            },
                                                            "Set_Phase3_Failed_Action_Name": {
                                                                "runAfter": {
                                                                    "Filter_Phase3_Failed_Actions": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "ManagerTestFailedActionName",
                                                                    "value": "@{if(greater(length(body('Filter_Phase3_Failed_Actions')), 0), first(body('Filter_Phase3_Failed_Actions'))?['name'], 'Unknown_Action')}"
                                                                }
                                                            },
                                                            "Set_Phase3_Failed_Action_Response": {
                                                                "runAfter": {
                                                                    "Set_Phase3_Failed_Action_Name": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "ManagerTestFailedActionResponse",
                                                                    "value": "@{if(greater(length(body('Filter_Phase3_Failed_Actions')), 0), coalesce(first(body('Filter_Phase3_Failed_Actions'))?['outputs'], json('{}')), json('{}'))}"
                                                                }
                                                            },
                                                            "Set_Phase3_Status_Failed": {
                                                                "runAfter": {
                                                                    "Set_Phase3_Failed_Action_Response": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "ManagerTestScopeExecutionStatus",
                                                                    "value": "Failed"
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Phase3_Change_Manager": [
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Scope"
                                                    },
                                                    "Set_Phase3_Status_Success": {
                                                        "runAfter": {
                                                            "Phase3_Change_Manager": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "ManagerTestScopeExecutionStatus",
                                                            "value": "Succeeded"
                                                        }
                                                    },
                                                    "Analyze_Phase3_Provisioning_Results": {
                                                        "runAfter": {
                                                            "Phase3_Change_Manager": [
                                                                "Succeeded",
                                                                "Failed",
                                                                "TimedOut"
                                                            ],
                                                            "Capture_Phase3_Failed_Actions": [
                                                                "Succeeded",
                                                                "Skipped"
                                                            ],
                                                            "Set_Phase3_Status_Success": [
                                                                "Succeeded",
                                                                "Skipped"
                                                            ]
                                                        },
                                                        "type": "Compose",
                                                        "inputs": {
                                                            "changeManagerProvisioningStatus": "@if(greater(length(coalesce(body('Verify_Change_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Verify_Change_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                                            "hasProvisioningLogs": "@greater(length(coalesce(body('Verify_Change_Manager_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                            "hasFailures": "@equals(toLower(coalesce(first(body('Verify_Change_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'failure')",
                                                            "provisioningResult": "@if(equals(variables('ManagerTestScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('Verify_Change_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Verify_Change_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('ManagerTestFailedActionName')))",
                                                            "provisioningErrorDetails": "@if(equals(variables('ManagerTestScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Verify_Change_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Verify_Change_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('Verify_Change_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('ManagerTestFailedActionResponse'))",
                                                            "overallResult": "@if(equals(variables('ManagerTestScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Verify_Change_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('Verify_Change_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                                        }
                                                    },
                                                    "Set_Phase3_Output_Variables": {
                                                        "actions": {
                                                            "Set_ManagerTestOutputs_Phase3": {
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "ManagerTestOutputs",
                                                                    "value": {
                                                                        "overallResult": "@outputs('Analyze_Phase3_Provisioning_Results')?['overallResult']",
                                                                        "result": "@outputs('Analyze_Phase3_Provisioning_Results')?['provisioningResult']",
                                                                        "errorDetails": "@outputs('Analyze_Phase3_Provisioning_Results')?['provisioningErrorDetails']"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Analyze_Phase3_Provisioning_Results": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Scope"
                                                    },
                                                    "Check_Phase3_Status": {
                                                        "actions": {
                                                            "Phase4_Remove_Manager": {
                                                                "actions": {
                                                                    "Step1_Remove_Manager_Relationship": {
                                                                        "type": "Http",
                                                                        "inputs": {
                                                                            "uri": "https://graph.microsoft.com/beta/users/@{body('Step2_Create_Test_User')?['id']}/manager/$ref",
                                                                            "method": "DELETE",
                                                                            "headers": {
                                                                                "Content-Type": "application/json"
                                                                            },
                                                                            "authentication": {
                                                                                "type": "ManagedServiceIdentity",
                                                                                "audience": "https://graph.microsoft.com/"
                                                                            }
                                                                        }
                                                                    },
                                                                    "DoUntil_Wait_For_Manager_Remove": {
                                                                        "actions": {
                                                                            "SCIM_Verify_Manager_Remove": {
                                                                                "type": "Http",
                                                                                "inputs": {
                                                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['managerUser'], ''), '%22')}",
                                                                                    "method": "GET",
                                                                                    "headers": {
                                                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                                        "Accept": "@{parameters('scimContentType')}"
                                                                                    }
                                                                                }
                                                                            },
                                                                            "Delay_Manager_Remove_15s": {
                                                                                "runAfter": {
                                                                                    "SCIM_Verify_Manager_Remove": [
                                                                                        "Succeeded",
                                                                                        "Failed"
                                                                                    ]
                                                                                },
                                                                                "type": "Wait",
                                                                                "inputs": {
                                                                                    "interval": {
                                                                                        "count": 15,
                                                                                        "unit": "Second"
                                                                                    }
                                                                                }
                                                                            }
                                                                        },
                                                                        "runAfter": {
                                                                            "Step1_Remove_Manager_Relationship": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "expression": "@and(greater(length(coalesce(body('SCIM_Verify_Manager_Remove')?['Resources'], json('[]'))), 0), or(not(contains(string(body('SCIM_Verify_Manager_Remove')), 'manager')), empty(first(body('SCIM_Verify_Manager_Remove')?['Resources'])?['urn:ietf:params:scim:schemas:extension:enterprise:2.0:User']?['manager']?['value'])))",
                                                                        "limit": {
                                                                            "count": 150,
                                                                            "timeout": "PT40M"
                                                                        },
                                                                        "type": "Until"
                                                                    },
                                                                    "DoUntil_Poll_Remove_Manager_Provisioning_Logs": {
                                                                        "actions": {
                                                                            "Verify_Remove_Manager_Provisioning_Logs": {
                                                                                "type": "Http",
                                                                                "inputs": {
                                                                                    "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Step2_Create_Test_User')?['id'], '%27%20and%20provisioningAction%20eq%20%27Update%27%20and%20modifiedProperties/any(p:%20p/displayName%20eq%20%27manager%27%20or%20p/displayName%20eq%20%27urn:ietf:params:scim:schemas:extension:enterprise:2.0:User:manager%27)')}",
                                                                                    "method": "GET",
                                                                                    "headers": {
                                                                                        "Accept": "application/json"
                                                                                    },
                                                                                    "authentication": {
                                                                                        "type": "ManagedServiceIdentity",
                                                                                        "audience": "https://graph.microsoft.com/"
                                                                                    }
                                                                                }
                                                                            },
                                                                            "Delay_Remove_Manager_Provisioning_Logs_15s": {
                                                                                "runAfter": {
                                                                                    "Verify_Remove_Manager_Provisioning_Logs": [
                                                                                        "Succeeded",
                                                                                        "Failed"
                                                                                    ]
                                                                                },
                                                                                "type": "Wait",
                                                                                "inputs": {
                                                                                    "interval": {
                                                                                        "count": 15,
                                                                                        "unit": "Second"
                                                                                    }
                                                                                }
                                                                            }
                                                                        },
                                                                        "runAfter": {
                                                                            "DoUntil_Wait_For_Manager_Remove": [
                                                                                "Succeeded",
                                                                                "Failed",
                                                                                "TimedOut"
                                                                            ]
                                                                        },
                                                                        "expression": "@and(greater(length(coalesce(body('Verify_Remove_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), and(equals(first(body('Verify_Remove_Manager_Provisioning_Logs')?['value'])?['modifiedProperties'][0]?['oldValue'], body('SCIM_Query_New_Manager')?['id']), or(empty(first(body('Verify_Remove_Manager_Provisioning_Logs')?['value'])?['modifiedProperties'][0]?['newValue']), equals(first(body('Verify_Remove_Manager_Provisioning_Logs')?['value'])?['modifiedProperties'][0]?['newValue'], 'null'))))",
                                                                        "limit": {
                                                                            "count": 150,
                                                                            "timeout": "PT15M"
                                                                        },
                                                                        "type": "Until"
                                                                    }
                                                                },
                                                                "type": "Scope"
                                                            },
                                                            "Capture_Phase4_Failed_Actions": {
                                                                "actions": {
                                                                    "Get_Phase4_Failed_Actions": {
                                                                        "type": "Compose",
                                                                        "inputs": "@result('Phase4_Remove_Manager')"
                                                                    },
                                                                    "Filter_Phase4_Failed_Actions": {
                                                                        "runAfter": {
                                                                            "Get_Phase4_Failed_Actions": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "Query",
                                                                        "inputs": {
                                                                            "from": "@outputs('Get_Phase4_Failed_Actions')",
                                                                            "where": "@equals(item()?['status'], 'Failed')"
                                                                        }
                                                                    },
                                                                    "Set_Phase4_Failed_Action_Name": {
                                                                        "runAfter": {
                                                                            "Filter_Phase4_Failed_Actions": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "SetVariable",
                                                                        "inputs": {
                                                                            "name": "ManagerTestFailedActionName",
                                                                            "value": "@{if(greater(length(body('Filter_Phase4_Failed_Actions')), 0), first(body('Filter_Phase4_Failed_Actions'))?['name'], 'Unknown_Action')}"
                                                                        }
                                                                    },
                                                                    "Set_Phase4_Failed_Action_Response": {
                                                                        "runAfter": {
                                                                            "Set_Phase4_Failed_Action_Name": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "SetVariable",
                                                                        "inputs": {
                                                                            "name": "ManagerTestFailedActionResponse",
                                                                            "value": "@{if(greater(length(body('Filter_Phase4_Failed_Actions')), 0), coalesce(first(body('Filter_Phase4_Failed_Actions'))?['outputs'], json('{}')), json('{}'))}"
                                                                        }
                                                                    },
                                                                    "Set_Phase4_Status_Failed": {
                                                                        "runAfter": {
                                                                            "Set_Phase4_Failed_Action_Response": [
                                                                                "Succeeded"
                                                                            ]
                                                                        },
                                                                        "type": "SetVariable",
                                                                        "inputs": {
                                                                            "name": "ManagerTestScopeExecutionStatus",
                                                                            "value": "Failed"
                                                                        }
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "Phase4_Remove_Manager": [
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Scope"
                                                            },
                                                            "Set_Phase4_Status_Success": {
                                                                "runAfter": {
                                                                    "Phase4_Remove_Manager": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "ManagerTestScopeExecutionStatus",
                                                                    "value": "Succeeded"
                                                                }
                                                            },
                                                            "Analyze_Phase4_Provisioning_Results": {
                                                                "runAfter": {
                                                                    "Phase4_Remove_Manager": [
                                                                        "Succeeded",
                                                                        "Failed",
                                                                        "TimedOut"
                                                                    ],
                                                                    "Capture_Phase4_Failed_Actions": [
                                                                        "Succeeded",
                                                                        "Skipped"
                                                                    ],
                                                                    "Set_Phase4_Status_Success": [
                                                                        "Succeeded",
                                                                        "Skipped"
                                                                    ]
                                                                },
                                                                "type": "Compose",
                                                                "inputs": {
                                                                    "removeManagerProvisioningStatus": "@if(greater(length(coalesce(body('Verify_Remove_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Verify_Remove_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                                                    "hasProvisioningLogs": "@greater(length(coalesce(body('Verify_Remove_Manager_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                                    "hasFailures": "@equals(toLower(coalesce(first(body('Verify_Remove_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'failure')",
                                                                    "provisioningResult": "@if(equals(variables('ManagerTestScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('Verify_Remove_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Verify_Remove_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('ManagerTestFailedActionName')))",
                                                                    "provisioningErrorDetails": "@if(equals(variables('ManagerTestScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Verify_Remove_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Verify_Remove_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('Verify_Remove_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('ManagerTestFailedActionResponse'))",
                                                                    "overallResult": "@if(equals(variables('ManagerTestScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Verify_Remove_Manager_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('Verify_Remove_Manager_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                                                }
                                                            },
                                                            "Set_Phase4_Output_Variables": {
                                                                "actions": {
                                                                    "Set_ManagerTestOutputs_Phase4": {
                                                                        "type": "SetVariable",
                                                                        "inputs": {
                                                                            "name": "ManagerTestOutputs",
                                                                            "value": {
                                                                                "overallResult": "@outputs('Analyze_Phase4_Provisioning_Results')?['overallResult']",
                                                                                "result": "@outputs('Analyze_Phase4_Provisioning_Results')?['provisioningResult']",
                                                                                "errorDetails": "@outputs('Analyze_Phase4_Provisioning_Results')?['provisioningErrorDetails']"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "runAfter": {
                                                                    "Analyze_Phase4_Provisioning_Results": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Scope"
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Set_Phase3_Output_Variables": [
                                                                "Succeeded",
                                                                "Failed",
                                                                "Skipped"
                                                            ]
                                                        },
                                                        "else": {
                                                            "actions": {}
                                                        },
                                                        "expression": {
                                                            "and": [
                                                                {
                                                                    "equals": [
                                                                        "@toLower(variables('ManagerTestOutputs')['overallResult'])",
                                                                        "passed"
                                                                    ]
                                                                }
                                                            ]
                                                        },
                                                        "type": "If"
                                                    }
                                                },
                                                "runAfter": {
                                                    "Set_Phase2_Output_Variables": [
                                                        "Succeeded",
                                                        "Failed",
                                                        "Skipped"
                                                    ]
                                                },
                                                "else": {
                                                    "actions": {}
                                                },
                                                "expression": {
                                                    "and": [
                                                        {
                                                            "equals": [
                                                                "@toLower(variables('ManagerTestOutputs')['overallResult'])",
                                                                "passed"
                                                            ]
                                                        }
                                                    ]
                                                },
                                                "type": "If"
                                            }
                                        },
                                        "runAfter": {
                                            "Set_Phase1_Output_Variables": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped"
                                            ]
                                        },
                                        "else": {
                                            "actions": {}
                                        },
                                        "expression": {
                                            "and": [
                                                {
                                                    "equals": [
                                                        "@toLower(variables('ManagerTestOutputs')['overallResult'])",
                                                        "passed"
                                                    ]
                                                }
                                            ]
                                        },
                                        "type": "If"
                                    }
                                },
                                "type": "Scope"
                            }
                        },
                        "else": {
                            "actions": {}
                        },
                        "expression": {
                            "or": [
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "All"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "UserTests"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "User_Update_Manager_Test"
                                    ]
                                }
                            ]
                        },
                        "type": "If"
                    },
                    "Disable_User_Test": {
                        "actions": {
                            "DisableUserTest_Disable_User_Test_Actions": {
                                "actions": {
                                    "DisableUserTest_Phase1_Create_User_And_Verify": {
                                        "actions": {
                                            "DisableUserTest_Disable_Step1_Check_User_Exists": {
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['disableUser'], ''), '%22')}",
                                                    "method": "GET",
                                                    "headers": {
                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                        "Accept": "@{parameters('scimContentType')}",
                                                        "Content-Type": "@{parameters('scimContentType')}"
                                                    }
                                                }
                                            },
                                            "DisableUserTest_Disable_Step2_Create_User": {
                                                "runAfter": {
                                                    "DisableUserTest_Disable_Step1_Check_User_Exists": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "accountEnabled": true,
                                                        "displayName": "@{outputs('Generate_Test_UserNames')['disableUser']}",
                                                        "mailNickname": "@{replace(first(split(outputs('Generate_Test_UserNames')['disableUser'],'@')),'.','')}",
                                                        "userPrincipalName": "@{outputs('Generate_Test_UserNames')['disableUser']}",
                                                        "givenName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName']), concat('Given', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName'])}",
                                                        "surname": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname']), concat('Sur', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname'])}",
                                                        "jobTitle": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle']), concat('Title', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle'])}",
                                                        "department": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department']), concat('Dept', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department'])}",
                                                        "companyName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName']), concat('Company', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName'])}",
                                                        "businessPhones": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['businessPhones'], json(concat('[\"+ 1-555-', substring(guid(),0,4), '\"]')))",
                                                        "mobilePhone": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone'])}",
                                                        "officeLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation']), concat('Office', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation'])}",
                                                        "preferredLanguage": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage']), 'en-US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage'])}",
                                                        "employeeId": "@{substring(guid(), 0, 8)}",
                                                        "employeeType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType']), 'Employee', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType'])}",
                                                        "streetAddress": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress']), concat('Street', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress'])}",
                                                        "city": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city']), concat('City', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city'])}",
                                                        "state": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state']), 'WA', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state'])}",
                                                        "country": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country'])}",
                                                        "postalCode": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode'])}",
                                                        "usageLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation'])}",
                                                        "mail": "@{outputs('Generate_Test_UserNames')['disableUser']}",
                                                        "otherMails": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['otherMails'], json(concat('[\"', substring(guid(),0,8), '@example.com\"]')))",
                                                        "faxNumber": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber'])}",
                                                        "userType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType']), 'Member', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType'])}",
                                                        "employeeOrgData": "@if(or(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'])), json(concat('{\"division\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), concat('Div', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), '\",\"costCenter\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), '\"}')), json(concat('{\"division\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division'], '\",\"costCenter\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'], '\"}')))",
                                                        "passwordProfile": {
                                                            "forceChangePasswordNextSignIn": "@parameters('forcePasswordChange')",
                                                            "password": "@parameters('defaultPassword')"
                                                        }
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "DisableUserTest_Disable_Assign_User_To_App": {
                                                "runAfter": {
                                                    "DisableUserTest_Disable_Step2_Create_User": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users/@{body('DisableUserTest_Disable_Step2_Create_User')?['id']}/appRoleAssignments",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "principalId": "@{body('DisableUserTest_Disable_Step2_Create_User')?['id']}",
                                                        "resourceId": "@{parameters('servicePrincipalId')}",
                                                        "appRoleId": "@{first(body('Get_App_Roles')?['appRoles'])?['id']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "DisableUserTest_Disable_DoUntil_Wait_For_User_Creation": {
                                                "actions": {
                                                    "DisableUserTest_Disable_Step3_Fetch_User_By_Filter": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['disableUser'], ''), '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "DisableUserTest_Disable_Delay_Creation_15s": {
                                                        "runAfter": {
                                                            "DisableUserTest_Disable_Step3_Fetch_User_By_Filter": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "DisableUserTest_Disable_Assign_User_To_App": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "expression": "@greater(length(coalesce(body('DisableUserTest_Disable_Step3_Fetch_User_By_Filter')?['Resources'], json('[]'))), 0)",
                                                "limit": {
                                                    "count": 150,
                                                    "timeout": "PT40M"
                                                },
                                                "type": "Until"
                                            },
                                            "DisableUserTest_Disable_Create_Poll_Provisioning_Logs": {
                                                "actions": {
                                                    "DisableUserTest_Disable_Create_Check_Provisioning_Logs": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('DisableUserTest_Disable_Step2_Create_User')?['id'], '%27%20and%20provisioningAction%20eq%20%27create%27')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Accept": "application/json"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "DisableUserTest_Disable_Create_Polling_Wait": {
                                                        "runAfter": {
                                                            "DisableUserTest_Disable_Create_Check_Provisioning_Logs": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "DisableUserTest_Disable_DoUntil_Wait_For_User_Creation": [
                                                        "Succeeded",
                                                        "Failed",
                                                        "TimedOut"
                                                    ]
                                                },
                                                "expression": "@greater(length(coalesce(body('DisableUserTest_Disable_Create_Check_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                "limit": {
                                                    "count": 150,
                                                    "timeout": "PT15M"
                                                },
                                                "type": "Until"
                                            }
                                        },
                                        "type": "Scope"
                                    },
                                    "DisableUserTest_Capture_Phase1_Failed_Actions": {
                                        "actions": {
                                            "DisableUserTest_Get_Phase1_Failed_Actions": {
                                                "type": "Compose",
                                                "inputs": "@result('DisableUserTest_Phase1_Create_User_And_Verify')"
                                            },
                                            "DisableUserTest_Filter_Phase1_Failed_Actions": {
                                                "runAfter": {
                                                    "DisableUserTest_Get_Phase1_Failed_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Query",
                                                "inputs": {
                                                    "from": "@outputs('DisableUserTest_Get_Phase1_Failed_Actions')",
                                                    "where": "@equals(item()?['status'], 'Failed')"
                                                }
                                            },
                                            "DisableUserTest_Set_Phase1_Failed_Action_Name": {
                                                "runAfter": {
                                                    "DisableUserTest_Filter_Phase1_Failed_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DisableUserFailedActionName",
                                                    "value": "@{if(greater(length(body('DisableUserTest_Filter_Phase1_Failed_Actions')), 0), first(body('DisableUserTest_Filter_Phase1_Failed_Actions'))?['name'], 'Unknown_Action')}"
                                                }
                                            },
                                            "DisableUserTest_Set_Phase1_Failed_Action_Response": {
                                                "runAfter": {
                                                    "DisableUserTest_Set_Phase1_Failed_Action_Name": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DisableUserFailedActionResponse",
                                                    "value": "@if(greater(length(body('DisableUserTest_Filter_Phase1_Failed_Actions')), 0), coalesce(first(body('DisableUserTest_Filter_Phase1_Failed_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                }
                                            },
                                            "DisableUserTest_Set_Phase1_Status_Failed": {
                                                "runAfter": {
                                                    "DisableUserTest_Set_Phase1_Failed_Action_Response": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DisableUserScopeExecutionStatus",
                                                    "value": "Failed"
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "DisableUserTest_Phase1_Create_User_And_Verify": [
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    },
                                    "DisableUserTest_Set_Phase1_Status_Success": {
                                        "runAfter": {
                                            "DisableUserTest_Phase1_Create_User_And_Verify": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "DisableUserScopeExecutionStatus",
                                            "value": "Succeeded"
                                        }
                                    },
                                    "DisableUserTest_Analyze_Phase1_Provisioning_Results": {
                                        "runAfter": {
                                            "DisableUserTest_Phase1_Create_User_And_Verify": [
                                                "Succeeded",
                                                "Failed",
                                                "TimedOut"
                                            ],
                                            "DisableUserTest_Capture_Phase1_Failed_Actions": [
                                                "Succeeded",
                                                "Skipped"
                                            ],
                                            "DisableUserTest_Set_Phase1_Status_Success": [
                                                "Succeeded",
                                                "Skipped"
                                            ]
                                        },
                                        "type": "Compose",
                                        "inputs": {
                                            "provisioningLogsCount": "@length(coalesce(body('DisableUserTest_Disable_Create_Check_Provisioning_Logs')?['value'], json('[]')))",
                                            "hasProvisioningLogs": "@greater(length(coalesce(body('DisableUserTest_Disable_Create_Check_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                            "provisioningStatus": "@if(greater(length(coalesce(body('DisableUserTest_Disable_Create_Check_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('DisableUserTest_Disable_Create_Check_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                            "provisioningResult": "@if(equals(variables('DisableUserScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('DisableUserTest_Disable_Create_Check_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('DisableUserTest_Disable_Create_Check_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('DisableUserFailedActionName')))",
                                            "provisioningErrorDetails": "@if(equals(variables('DisableUserScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('DisableUserTest_Disable_Create_Check_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('DisableUserTest_Disable_Create_Check_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('DisableUserTest_Disable_Create_Check_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('DisableUserFailedActionResponse'))",
                                            "overallResult": "@if(equals(variables('DisableUserScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('DisableUserTest_Disable_Create_Check_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('DisableUserTest_Disable_Create_Check_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                        }
                                    },
                                    "DisableUserTest_Set_Phase1_Output_Variables": {
                                        "actions": {
                                            "DisableUserTest_Set_DisableUserTestOutputs_Phase1": {
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DisableUserTestOutputs",
                                                    "value": {
                                                        "overallResult": "@outputs('DisableUserTest_Analyze_Phase1_Provisioning_Results')?['overallResult']",
                                                        "result": "@outputs('DisableUserTest_Analyze_Phase1_Provisioning_Results')?['provisioningResult']",
                                                        "errorDetails": "@outputs('DisableUserTest_Analyze_Phase1_Provisioning_Results')?['provisioningErrorDetails']"
                                                    }
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "DisableUserTest_Analyze_Phase1_Provisioning_Results": [
                                                "Succeeded",
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    },
                                    "DisableUserTest_Check_Phase1_Status": {
                                        "actions": {
                                            "DisableUserTest_Phase2_Disable_User_And_Verify": {
                                                "actions": {
                                                    "DisableUserTest_Disable_Step4_Query_User_By_Id": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['disableUser'], ''), '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "DisableUserTest_Disable_Step5_Disable_Or_Delete_User": {
                                                        "runAfter": {
                                                            "DisableUserTest_Disable_Step4_Query_User_By_Id": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "https://graph.microsoft.com/beta/users/@{body('DisableUserTest_Disable_Step2_Create_User')?['id']}",
                                                            "method": "@{if(parameters('IsSoftDeleted'), 'PATCH', 'DELETE')}",
                                                            "headers": {
                                                                "Content-Type": "application/json"
                                                            },
                                                            "body": "@{if(parameters('IsSoftDeleted'), json('{\"accountEnabled\": false}'), null)}",
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "DisableUserTest_Disable_DoUntil_Wait_For_User_Disable": {
                                                        "actions": {
                                                            "DisableUserTest_Disable_Step6_Check_User_After_Disable": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['disableUser'], ''), '%22')}",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                        "Accept": "@{parameters('scimContentType')}"
                                                                    }
                                                                }
                                                            },
                                                            "DisableUserTest_Disable_Delay_Final_15s": {
                                                                "runAfter": {
                                                                    "DisableUserTest_Disable_Step6_Check_User_After_Disable": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "DisableUserTest_Disable_Step5_Disable_Or_Delete_User": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "expression": "@if(parameters('IsSoftDeleted'), and(greater(length(coalesce(body('DisableUserTest_Disable_Step6_Check_User_After_Disable')?['Resources'], json('[]'))), 0), equals(first(body('DisableUserTest_Disable_Step6_Check_User_After_Disable')?['Resources'])?['active'], false)), equals(length(coalesce(body('DisableUserTest_Disable_Step6_Check_User_After_Disable')?['Resources'], json('[]'))), 0))",
                                                        "limit": {
                                                            "count": 150,
                                                            "timeout": "PT40M"
                                                        },
                                                        "type": "Until"
                                                    },
                                                    "DisableUserTest_Disable_DoUntil_Poll_Disable_Provisioning_Logs": {
                                                        "actions": {
                                                            "DisableUserTest_Disable_Verify_Disable_Provisioning_Logs": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('DisableUserTest_Disable_Step2_Create_User')?['id'], '%27%20and%20provisioningAction%20eq%20%27', if(parameters('IsSoftDeleted'), 'Disable', 'Delete'), '%27')}",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Accept": "application/json"
                                                                    },
                                                                    "authentication": {
                                                                        "type": "ManagedServiceIdentity",
                                                                        "audience": "https://graph.microsoft.com/"
                                                                    }
                                                                }
                                                            },
                                                            "DisableUserTest_Disable_Delay_Disable_Provisioning_Logs_15s": {
                                                                "runAfter": {
                                                                    "DisableUserTest_Disable_Verify_Disable_Provisioning_Logs": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "DisableUserTest_Disable_DoUntil_Wait_For_User_Disable": [
                                                                "Succeeded",
                                                                "Failed",
                                                                "TimedOut"
                                                            ]
                                                        },
                                                        "expression": "@greater(length(coalesce(body('DisableUserTest_Disable_Verify_Disable_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                        "limit": {
                                                            "count": 150,
                                                            "timeout": "PT15M"
                                                        },
                                                        "type": "Until"
                                                    }
                                                },
                                                "type": "Scope"
                                            },
                                            "DisableUserTest_Capture_Phase2_Failed_Actions": {
                                                "actions": {
                                                    "DisableUserTest_Get_Phase2_Failed_Actions": {
                                                        "type": "Compose",
                                                        "inputs": "@result('DisableUserTest_Phase2_Disable_User_And_Verify')"
                                                    },
                                                    "DisableUserTest_Filter_Phase2_Failed_Actions": {
                                                        "runAfter": {
                                                            "DisableUserTest_Get_Phase2_Failed_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Query",
                                                        "inputs": {
                                                            "from": "@outputs('DisableUserTest_Get_Phase2_Failed_Actions')",
                                                            "where": "@equals(item()?['status'], 'Failed')"
                                                        }
                                                    },
                                                    "DisableUserTest_Set_Phase2_Failed_Action_Name": {
                                                        "runAfter": {
                                                            "DisableUserTest_Filter_Phase2_Failed_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "DisableUserFailedActionName",
                                                            "value": "@{if(greater(length(body('DisableUserTest_Filter_Phase2_Failed_Actions')), 0), first(body('DisableUserTest_Filter_Phase2_Failed_Actions'))?['name'], 'Unknown_Action')}"
                                                        }
                                                    },
                                                    "DisableUserTest_Set_Phase2_Failed_Action_Response": {
                                                        "runAfter": {
                                                            "DisableUserTest_Set_Phase2_Failed_Action_Name": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "DisableUserFailedActionResponse",
                                                            "value": "@if(greater(length(body('DisableUserTest_Filter_Phase2_Failed_Actions')), 0), coalesce(first(body('DisableUserTest_Filter_Phase2_Failed_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                        }
                                                    },
                                                    "DisableUserTest_Set_Phase2_Status_Failed": {
                                                        "runAfter": {
                                                            "DisableUserTest_Set_Phase2_Failed_Action_Response": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "DisableUserScopeExecutionStatus",
                                                            "value": "Failed"
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "DisableUserTest_Phase2_Disable_User_And_Verify": [
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            },
                                            "DisableUserTest_Set_Phase2_Status_Success": {
                                                "runAfter": {
                                                    "DisableUserTest_Phase2_Disable_User_And_Verify": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DisableUserScopeExecutionStatus",
                                                    "value": "Succeeded"
                                                }
                                            },
                                            "DisableUserTest_Analyze_Phase2_Provisioning_Results": {
                                                "runAfter": {
                                                    "DisableUserTest_Phase2_Disable_User_And_Verify": [
                                                        "Succeeded",
                                                        "Failed",
                                                        "TimedOut"
                                                    ],
                                                    "DisableUserTest_Capture_Phase2_Failed_Actions": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ],
                                                    "DisableUserTest_Set_Phase2_Status_Success": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ]
                                                },
                                                "type": "Compose",
                                                "inputs": {
                                                    "provisioningLogsCount": "@length(coalesce(body('DisableUserTest_Disable_Verify_Disable_Provisioning_Logs')?['value'], json('[]')))",
                                                    "hasProvisioningLogs": "@greater(length(coalesce(body('DisableUserTest_Disable_Verify_Disable_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                    "provisioningStatus": "@if(greater(length(coalesce(body('DisableUserTest_Disable_Verify_Disable_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('DisableUserTest_Disable_Verify_Disable_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                                    "provisioningResult": "@if(equals(variables('DisableUserScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('DisableUserTest_Disable_Verify_Disable_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('DisableUserTest_Disable_Verify_Disable_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('DisableUserFailedActionName')))",
                                                    "provisioningErrorDetails": "@if(equals(variables('DisableUserScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('DisableUserTest_Disable_Verify_Disable_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('DisableUserTest_Disable_Verify_Disable_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('DisableUserTest_Disable_Verify_Disable_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('DisableUserFailedActionResponse'))",
                                                    "overallResult": "@if(equals(variables('DisableUserScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('DisableUserTest_Disable_Verify_Disable_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('DisableUserTest_Disable_Verify_Disable_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                                }
                                            },
                                            "DisableUserTest_Set_Phase2_Output_Variables": {
                                                "actions": {
                                                    "DisableUserTest_Set_DisableUserTestOutputs_Phase2": {
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "DisableUserTestOutputs",
                                                            "value": {
                                                                "overallResult": "@outputs('DisableUserTest_Analyze_Phase2_Provisioning_Results')?['overallResult']",
                                                                "result": "@outputs('DisableUserTest_Analyze_Phase2_Provisioning_Results')?['provisioningResult']",
                                                                "errorDetails": "@outputs('DisableUserTest_Analyze_Phase2_Provisioning_Results')?['provisioningErrorDetails']"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "DisableUserTest_Analyze_Phase2_Provisioning_Results": [
                                                        "Succeeded",
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            }
                                        },
                                        "runAfter": {
                                            "DisableUserTest_Set_Phase1_Output_Variables": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped"
                                            ]
                                        },
                                        "else": {
                                            "actions": {}
                                        },
                                        "expression": {
                                            "and": [
                                                {
                                                    "equals": [
                                                        "@toLower(variables('DisableUserTestOutputs')['overallResult'])",
                                                        "passed"
                                                    ]
                                                }
                                            ]
                                        },
                                        "type": "If"
                                    },
                                    "DisableUserTest_Cleanup_Delete_User": {
                                        "runAfter": {
                                            "DisableUserTest_Check_Phase1_Status": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped",
                                                "TimedOut"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "https://graph.microsoft.com/beta/users/@{body('DisableUserTest_Disable_Step2_Create_User')?['id']}",
                                            "method": "DELETE",
                                            "authentication": {
                                                "type": "ManagedServiceIdentity",
                                                "audience": "https://graph.microsoft.com/"
                                            }
                                        }
                                    }
                                },
                                "type": "Scope"
                            }
                        },
                        "else": {
                            "actions": {}
                        },
                        "expression": {
                            "or": [
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "All"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "Disable_User_Test"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "UserTests"
                                    ]
                                }
                            ]
                        },
                        "type": "If"
                    }
                },
                "runAfter": {
                    "Initialize_All_Group_Test_Variables": [
                        "Succeeded"
                    ]
                },
                "type": "Scope"
            },
            "GroupTests_Scope": {
                "actions": {
                    "Create_Group_Test": {
                        "actions": {
                            "Create_Group_Test_Actions": {
                                "actions": {
                                    "Create_Group_Initial_Verify_Group_Exists": {
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', outputs('Generate_Test_GroupNames')['createGroup'], '%22')}",
                                            "method": "GET",
                                            "headers": {
                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                "Accept": "@{parameters('scimContentType')}"
                                            }
                                        }
                                    },
                                    "Create_Group_Create_Group_Graph": {
                                        "runAfter": {
                                            "Create_Group_Initial_Verify_Group_Exists": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "https://graph.microsoft.com/beta/groups",
                                            "method": "POST",
                                            "headers": {
                                                "Content-Type": "application/json"
                                            },
                                            "body": {
                                                "displayName": "@{outputs('Generate_Test_GroupNames')['createGroup']}",
                                                "description": "@{parameters('defaultGroupProperties')['description']}",
                                                "mailEnabled": "@parameters('defaultGroupProperties')['mailEnabled']",
                                                "mailNickname": "@{replace(outputs('Generate_Test_GroupNames')['createGroup'], '-', '')}",
                                                "securityEnabled": "@parameters('defaultGroupProperties')['securityEnabled']",
                                                "groupTypes": "@parameters('defaultGroupProperties')['groupTypes']",
                                                "isAssignableToRole": "@parameters('defaultGroupProperties')['isAssignableToRole']",
                                                "visibility": "@{parameters('defaultGroupProperties')['visibility']}"
                                            },
                                            "authentication": {
                                                "type": "ManagedServiceIdentity",
                                                "audience": "https://graph.microsoft.com/"
                                            }
                                        }
                                    },
                                    "Create_Group_Assign_Group_To_App": {
                                        "runAfter": {
                                            "Create_Group_Create_Group_Graph": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "https://graph.microsoft.com/beta/groups/@{body('Create_Group_Create_Group_Graph')?['id']}/appRoleAssignments",
                                            "method": "POST",
                                            "headers": {
                                                "Content-Type": "application/json"
                                            },
                                            "body": {
                                                "principalId": "@{body('Create_Group_Create_Group_Graph')?['id']}",
                                                "resourceId": "@{parameters('servicePrincipalId')}",
                                                "appRoleId": "@{first(body('Get_App_Roles')?['appRoles'])?['id']}"
                                            },
                                            "authentication": {
                                                "type": "ManagedServiceIdentity",
                                                "audience": "https://graph.microsoft.com/"
                                            }
                                        }
                                    },
                                    "DoUntil_Poll_Create_Group": {
                                        "actions": {
                                            "Create_Group_Query_Create_Group": {
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', outputs('Generate_Test_GroupNames')['createGroup'], '%22')}",
                                                    "method": "GET",
                                                    "headers": {
                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                        "Accept": "@{parameters('scimContentType')}"
                                                    }
                                                }
                                            },
                                            "Delay_Create_Group_15s": {
                                                "runAfter": {
                                                    "Create_Group_Query_Create_Group": [
                                                        "Succeeded",
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Wait",
                                                "inputs": {
                                                    "interval": {
                                                        "count": 15,
                                                        "unit": "Second"
                                                    }
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Create_Group_Assign_Group_To_App": [
                                                "Succeeded"
                                            ]
                                        },
                                        "expression": "@greater(length(coalesce(body('Create_Group_Query_Create_Group')?['Resources'], json('[]'))), 0)",
                                        "limit": {
                                            "count": 150,
                                            "timeout": "PT40M"
                                        },
                                        "type": "Until"
                                    },
                                    "DoUntil_Poll_Group_Provisioning_Logs": {
                                        "actions": {
                                            "Verify_Group_Provisioning_Logs": {
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "@concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Create_Group_Create_Group_Graph')?['id'], '%27%20and%20provisioningAction%20eq%20%27Create%27')",
                                                    "method": "GET",
                                                    "headers": {
                                                        "Accept": "application/json"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Delay_Group_Provisioning_Logs_15s": {
                                                "runAfter": {
                                                    "Verify_Group_Provisioning_Logs": [
                                                        "Succeeded",
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Wait",
                                                "inputs": {
                                                    "interval": {
                                                        "count": 15,
                                                        "unit": "Second"
                                                    }
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "DoUntil_Poll_Create_Group": [
                                                "Succeeded",
                                                "Failed",
                                                "TimedOut"
                                            ]
                                        },
                                        "expression": "@greater(length(coalesce(body('Verify_Group_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                        "limit": {
                                            "count": 150,
                                            "timeout": "PT15M"
                                        },
                                        "type": "Until"
                                    }
                                },
                                "type": "Scope"
                            },
                            "Capture_Failed_Group_Action_Details": {
                                "actions": {
                                    "Get_Failed_Group_Actions": {
                                        "type": "Compose",
                                        "inputs": "@result('Create_Group_Test_Actions')"
                                    },
                                    "Filter_Failed_Group_Actions": {
                                        "runAfter": {
                                            "Get_Failed_Group_Actions": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "Query",
                                        "inputs": {
                                            "from": "@outputs('Get_Failed_Group_Actions')",
                                            "where": "@equals(item()?['status'], 'Failed')"
                                        }
                                    },
                                    "Set_Failed_Group_Action_Name": {
                                        "runAfter": {
                                            "Filter_Failed_Group_Actions": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "CreateGroupFailedActionName",
                                            "value": "@{if(greater(length(body('Filter_Failed_Group_Actions')), 0), first(body('Filter_Failed_Group_Actions'))?['name'], 'Unknown_Action')}"
                                        }
                                    },
                                    "Set_Failed_Group_Action_Response": {
                                        "runAfter": {
                                            "Set_Failed_Group_Action_Name": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "CreateGroupFailedActionResponse",
                                            "value": "@if(greater(length(body('Filter_Failed_Group_Actions')), 0), coalesce(first(body('Filter_Failed_Group_Actions'))?['outputs'], json('{}')), json('{}'))"
                                        }
                                    },
                                    "Set_Create_Group_Test_Status_Failed": {
                                        "runAfter": {
                                            "Set_Failed_Group_Action_Response": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "CreateGroupScopeExecutionStatus",
                                            "value": "Failed"
                                        }
                                    }
                                },
                                "runAfter": {
                                    "Create_Group_Test_Actions": [
                                        "Failed"
                                    ]
                                },
                                "type": "Scope"
                            },
                            "Set_Create_Group_Test_Status_Success": {
                                "runAfter": {
                                    "Create_Group_Test_Actions": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "SetVariable",
                                "inputs": {
                                    "name": "CreateGroupScopeExecutionStatus",
                                    "value": "Succeeded"
                                }
                            },
                            "Create_Group_Test_Analyze_Provisioning_Results": {
                                "runAfter": {
                                    "Create_Group_Test_Actions": [
                                        "Succeeded",
                                        "Failed",
                                        "TimedOut"
                                    ],
                                    "Capture_Failed_Group_Action_Details": [
                                        "Succeeded",
                                        "Skipped"
                                    ],
                                    "Set_Create_Group_Test_Status_Success": [
                                        "Succeeded",
                                        "Skipped"
                                    ]
                                },
                                "type": "Compose",
                                "inputs": {
                                    "provisioningLogsCount": "@length(coalesce(body('Verify_Group_Provisioning_Logs')?['value'], json('[]')))",
                                    "hasProvisioningLogs": "@greater(length(coalesce(body('Verify_Group_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                    "provisioningStatus": "@if(greater(length(coalesce(body('Verify_Group_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Verify_Group_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                    "provisioningResult": "@if(equals(variables('CreateGroupScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('Verify_Group_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Verify_Group_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('CreateGroupFailedActionName')))",
                                    "provisioningErrorDetails": "@if(equals(variables('CreateGroupScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Verify_Group_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Verify_Group_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('Verify_Group_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('CreateGroupFailedActionResponse'))",
                                    "overallResult": "@if(equals(variables('CreateGroupScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Verify_Group_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('Verify_Group_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                }
                            },
                            "Set_CreateGroup_Output_Variables": {
                                "actions": {
                                    "Set_CreateGroupTestOutputs": {
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "CreateGroupTestOutputs",
                                            "value": {
                                                "overallResult": "@outputs('Create_Group_Test_Analyze_Provisioning_Results')?['overallResult']",
                                                "result": "@outputs('Create_Group_Test_Analyze_Provisioning_Results')?['provisioningResult']",
                                                "errorDetails": "@outputs('Create_Group_Test_Analyze_Provisioning_Results')?['provisioningErrorDetails']"
                                            }
                                        }
                                    }
                                },
                                "runAfter": {
                                    "Create_Group_Test_Analyze_Provisioning_Results": [
                                        "Succeeded",
                                        "Failed"
                                    ]
                                },
                                "type": "Scope"
                            },
                            "Delete_Created_Group": {
                                "runAfter": {
                                    "Set_CreateGroup_Output_Variables": [
                                        "Succeeded",
                                        "Failed",
                                        "Skipped"
                                    ]
                                },
                                "type": "Http",
                                "inputs": {
                                    "uri": "https://graph.microsoft.com/beta/groups/@{body('Create_Group_Create_Group_Graph')?['id']}",
                                    "method": "DELETE",
                                    "authentication": {
                                        "type": "ManagedServiceIdentity",
                                        "audience": "https://graph.microsoft.com/"
                                    }
                                }
                            }
                        },
                        "else": {
                            "actions": {}
                        },
                        "expression": {
                            "or": [
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "All"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "GroupTests"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "Create_Group_Test"
                                    ]
                                }
                            ]
                        },
                        "type": "If"
                    },
                    "Update_Group_Test": {
                        "actions": {
                            "Update_Group_Test_Actions": {
                                "actions": {
                                    "Update_Group_Verify_Creation_And_Provisioning": {
                                        "actions": {
                                            "Update_Group_Initial_Verify_Group_Exists": {
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', concat(outputs('Generate_Test_GroupNames')['createGroup'], '-Update'), '%22')}",
                                                    "method": "GET",
                                                    "headers": {
                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                        "Accept": "@{parameters('scimContentType')}"
                                                    }
                                                }
                                            },
                                            "Update_Group_Create_Group_Graph": {
                                                "runAfter": {
                                                    "Update_Group_Initial_Verify_Group_Exists": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/groups",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "displayName": "@{concat(outputs('Generate_Test_GroupNames')['createGroup'], '-Update')}",
                                                        "description": "@{parameters('defaultGroupProperties')['description']}",
                                                        "mailEnabled": "@parameters('defaultGroupProperties')['mailEnabled']",
                                                        "mailNickname": "@{replace(concat(outputs('Generate_Test_GroupNames')['createGroup'], 'Update'), '-', '')}",
                                                        "securityEnabled": "@parameters('defaultGroupProperties')['securityEnabled']",
                                                        "groupTypes": "@parameters('defaultGroupProperties')['groupTypes']",
                                                        "isAssignableToRole": "@parameters('defaultGroupProperties')['isAssignableToRole']",
                                                        "visibility": "@{parameters('defaultGroupProperties')['visibility']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Update_Group_Assign_To_App": {
                                                "runAfter": {
                                                    "Update_Group_Create_Group_Graph": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/groups/@{body('Update_Group_Create_Group_Graph')?['id']}/appRoleAssignments",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "principalId": "@{body('Update_Group_Create_Group_Graph')?['id']}",
                                                        "resourceId": "@{parameters('servicePrincipalId')}",
                                                        "appRoleId": "@{first(body('Get_App_Roles')?['appRoles'])?['id']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Update_Group_DoUntil_Wait_For_Creation": {
                                                "actions": {
                                                    "Update_Group_Check_Group_Create": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', concat(outputs('Generate_Test_GroupNames')['createGroup'], '-Update'), '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "Update_Group_Delay_Creation_15s": {
                                                        "runAfter": {
                                                            "Update_Group_Check_Group_Create": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Update_Group_Assign_To_App": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "expression": "@greater(length(coalesce(body('Update_Group_Check_Group_Create')?['Resources'], json('[]'))), 0)",
                                                "limit": {
                                                    "count": 150,
                                                    "timeout": "PT40M"
                                                },
                                                "type": "Until"
                                            },
                                            "Update_Group_DoUntil_Poll_Create_Provisioning": {
                                                "actions": {
                                                    "Update_Group_Verify_Create_Provisioning": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Update_Group_Create_Group_Graph')?['id'], '%27%20and%20provisioningAction%20eq%20%27Create%27')",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Accept": "application/json"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "Update_Group_Delay_Create_Provisioning_15s": {
                                                        "runAfter": {
                                                            "Update_Group_Verify_Create_Provisioning": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Update_Group_DoUntil_Wait_For_Creation": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "expression": "@greater(length(coalesce(body('Update_Group_Verify_Create_Provisioning')?['value'], json('[]'))), 0)",
                                                "limit": {
                                                    "count": 150,
                                                    "timeout": "PT15M"
                                                },
                                                "type": "Until"
                                            }
                                        },
                                        "type": "Scope"
                                    },
                                    "Capture_Update_Group_CreatePhase_Failed": {
                                        "actions": {
                                            "Get_Failed_CreatePhase_Group_Actions": {
                                                "type": "Compose",
                                                "inputs": "@result('Update_Group_Verify_Creation_And_Provisioning')"
                                            },
                                            "Filter_Failed_CreatePhase_Group_Actions": {
                                                "runAfter": {
                                                    "Get_Failed_CreatePhase_Group_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Query",
                                                "inputs": {
                                                    "from": "@outputs('Get_Failed_CreatePhase_Group_Actions')",
                                                    "where": "@equals(item()?['status'], 'Failed')"
                                                }
                                            },
                                            "Set_UpdateGroup_CreatePhase_Failed_Action_Name": {
                                                "runAfter": {
                                                    "Filter_Failed_CreatePhase_Group_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "UpdateGroupFailedActionName",
                                                    "value": "@{if(greater(length(body('Filter_Failed_CreatePhase_Group_Actions')), 0), first(body('Filter_Failed_CreatePhase_Group_Actions'))?['name'], 'Unknown_Action')}"
                                                }
                                            },
                                            "Set_UpdateGroup_CreatePhase_Failed_Action_Response": {
                                                "runAfter": {
                                                    "Set_UpdateGroup_CreatePhase_Failed_Action_Name": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "UpdateGroupFailedActionResponse",
                                                    "value": "@if(greater(length(body('Filter_Failed_CreatePhase_Group_Actions')), 0), coalesce(first(body('Filter_Failed_CreatePhase_Group_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                }
                                            },
                                            "Set_UpdateGroup_CreatePhase_Status_Failed": {
                                                "runAfter": {
                                                    "Set_UpdateGroup_CreatePhase_Failed_Action_Response": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "UpdateGroupScopeExecutionStatus",
                                                    "value": "Failed"
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Update_Group_Verify_Creation_And_Provisioning": [
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    },
                                    "Set_UpdateGroup_CreatePhase_Status_Success": {
                                        "runAfter": {
                                            "Update_Group_Verify_Creation_And_Provisioning": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "UpdateGroupScopeExecutionStatus",
                                            "value": "Succeeded"
                                        }
                                    },
                                    "Update_Group_Analyze_Create_Provisioning": {
                                        "runAfter": {
                                            "Update_Group_Verify_Creation_And_Provisioning": [
                                                "Succeeded",
                                                "Failed",
                                                "TimedOut"
                                            ],
                                            "Capture_Update_Group_CreatePhase_Failed": [
                                                "Succeeded",
                                                "Skipped"
                                            ],
                                            "Set_UpdateGroup_CreatePhase_Status_Success": [
                                                "Succeeded",
                                                "Skipped"
                                            ]
                                        },
                                        "type": "Compose",
                                        "inputs": {
                                            "provisioningLogsCount": "@length(coalesce(body('Update_Group_Verify_Create_Provisioning')?['value'], json('[]')))",
                                            "hasProvisioningLogs": "@greater(length(coalesce(body('Update_Group_Verify_Create_Provisioning')?['value'], json('[]'))), 0)",
                                            "provisioningStatus": "@if(greater(length(coalesce(body('Update_Group_Verify_Create_Provisioning')?['value'], json('[]'))), 0), coalesce(first(body('Update_Group_Verify_Create_Provisioning')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                            "provisioningResult": "@if(equals(variables('UpdateGroupScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('Update_Group_Verify_Create_Provisioning')?['value'], json('[]'))), 0), coalesce(first(body('Update_Group_Verify_Create_Provisioning')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('UpdateGroupFailedActionName')))",
                                            "provisioningErrorDetails": "@if(equals(variables('UpdateGroupScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Update_Group_Verify_Create_Provisioning')?['value'], json('[]'))), 0), equals(toLower(first(body('Update_Group_Verify_Create_Provisioning')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('Update_Group_Verify_Create_Provisioning')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('UpdateGroupFailedActionResponse'))",
                                            "overallResult": "@if(equals(variables('UpdateGroupScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Update_Group_Verify_Create_Provisioning')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('Update_Group_Verify_Create_Provisioning')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                        }
                                    },
                                    "Set_UpdateGroup_CreatePhase_Output_Variables": {
                                        "actions": {
                                            "Set_UpdateGroupTestOutputs_CreatePhase": {
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "UpdateGroupTestOutputs",
                                                    "value": {
                                                        "overallResult": "@outputs('Update_Group_Analyze_Create_Provisioning')?['overallResult']",
                                                        "result": "@outputs('Update_Group_Analyze_Create_Provisioning')?['provisioningResult']",
                                                        "errorDetails": "@outputs('Update_Group_Analyze_Create_Provisioning')?['provisioningErrorDetails']"
                                                    }
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Update_Group_Analyze_Create_Provisioning": [
                                                "Succeeded",
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    },
                                    "Update_Group_Check_Create_Phase_Status": {
                                        "actions": {
                                            "Update_Group_Verify_Update_And_Provisioning": {
                                                "actions": {
                                                    "Update_Group_Query_Group_By_Id": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', concat(outputs('Generate_Test_GroupNames')['createGroup'], '-Update'), '%22')",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "Update_Group_Update_Group_Attributes": {
                                                        "runAfter": {
                                                            "Update_Group_Query_Group_By_Id": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "https://graph.microsoft.com/beta/groups/@{body('Update_Group_Create_Group_Graph')?['id']}",
                                                            "method": "PATCH",
                                                            "headers": {
                                                                "Content-Type": "application/json"
                                                            },
                                                            "body": {
                                                                "displayName": "@{concat(outputs('Generate_Test_GroupNames')['createGroup'], '-Update-Modified')}",
                                                                "description": "Updated Test Group Description"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "Update_Group_DoUntil_Wait_For_Updates": {
                                                        "actions": {
                                                            "Update_Group_Query_Group_By_Id_After_Attributes_Update": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', concat(outputs('Generate_Test_GroupNames')['createGroup'], '-Update-Modified'), '%22')",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                        "Accept": "@{parameters('scimContentType')}"
                                                                    }
                                                                }
                                                            },
                                                            "Update_Group_Delay_Update_15s": {
                                                                "runAfter": {
                                                                    "Update_Group_Query_Group_By_Id_After_Attributes_Update": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Update_Group_Update_Group_Attributes": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "expression": "@and(greater(length(coalesce(body('Update_Group_Query_Group_By_Id_After_Attributes_Update')?['Resources'], json('[]'))), 0), contains(string(body('Update_Group_Query_Group_By_Id_After_Attributes_Update')), '-Modified'))",
                                                        "limit": {
                                                            "count": 150,
                                                            "timeout": "PT40M"
                                                        },
                                                        "type": "Until"
                                                    },
                                                    "Update_Group_DoUntil_Poll_Update_Provisioning": {
                                                        "actions": {
                                                            "Update_Group_Verify_Update_Provisioning": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Update_Group_Create_Group_Graph')?['id'], '%27%20and%20provisioningAction%20eq%20%27Update%27&$top=1&$orderby=activityDateTime%20desc')",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Accept": "application/json"
                                                                    },
                                                                    "authentication": {
                                                                        "type": "ManagedServiceIdentity",
                                                                        "audience": "https://graph.microsoft.com/"
                                                                    }
                                                                }
                                                            },
                                                            "Update_Group_Delay_Update_Provisioning_15s": {
                                                                "runAfter": {
                                                                    "Update_Group_Verify_Update_Provisioning": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Update_Group_DoUntil_Wait_For_Updates": [
                                                                "Succeeded",
                                                                "Failed",
                                                                "TimedOut"
                                                            ]
                                                        },
                                                        "expression": "@greater(length(coalesce(body('Update_Group_Verify_Update_Provisioning')?['value'], json('[]'))), 0)",
                                                        "limit": {
                                                            "count": 150,
                                                            "timeout": "PT15M"
                                                        },
                                                        "type": "Until"
                                                    }
                                                },
                                                "type": "Scope"
                                            },
                                            "Capture_Update_Group_UpdatePhase_Failed": {
                                                "actions": {
                                                    "Get_Failed_UpdatePhase_Group_Actions": {
                                                        "type": "Compose",
                                                        "inputs": "@result('Update_Group_Verify_Update_And_Provisioning')"
                                                    },
                                                    "Filter_Failed_UpdatePhase_Group_Actions": {
                                                        "runAfter": {
                                                            "Get_Failed_UpdatePhase_Group_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Query",
                                                        "inputs": {
                                                            "from": "@outputs('Get_Failed_UpdatePhase_Group_Actions')",
                                                            "where": "@equals(item()?['status'], 'Failed')"
                                                        }
                                                    },
                                                    "Set_UpdateGroup_UpdatePhase_Failed_Action_Name": {
                                                        "runAfter": {
                                                            "Filter_Failed_UpdatePhase_Group_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "UpdateGroupFailedActionName",
                                                            "value": "@{if(greater(length(body('Filter_Failed_UpdatePhase_Group_Actions')), 0), first(body('Filter_Failed_UpdatePhase_Group_Actions'))?['name'], 'Unknown_Action')}"
                                                        }
                                                    },
                                                    "Set_UpdateGroup_UpdatePhase_Failed_Action_Response": {
                                                        "runAfter": {
                                                            "Set_UpdateGroup_UpdatePhase_Failed_Action_Name": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "UpdateGroupFailedActionResponse",
                                                            "value": "@if(greater(length(body('Filter_Failed_UpdatePhase_Group_Actions')), 0), coalesce(first(body('Filter_Failed_UpdatePhase_Group_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                        }
                                                    },
                                                    "Set_UpdateGroup_UpdatePhase_Status_Failed": {
                                                        "runAfter": {
                                                            "Set_UpdateGroup_UpdatePhase_Failed_Action_Response": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "UpdateGroupScopeExecutionStatus",
                                                            "value": "Failed"
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Update_Group_Verify_Update_And_Provisioning": [
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            },
                                            "Set_UpdateGroup_UpdatePhase_Status_Success": {
                                                "runAfter": {
                                                    "Update_Group_Verify_Update_And_Provisioning": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "UpdateGroupScopeExecutionStatus",
                                                    "value": "Succeeded"
                                                }
                                            },
                                            "Update_Group_Analyze_Update_Provisioning": {
                                                "runAfter": {
                                                    "Update_Group_Verify_Update_And_Provisioning": [
                                                        "Succeeded",
                                                        "Failed",
                                                        "TimedOut"
                                                    ],
                                                    "Capture_Update_Group_UpdatePhase_Failed": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ],
                                                    "Set_UpdateGroup_UpdatePhase_Status_Success": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ]
                                                },
                                                "type": "Compose",
                                                "inputs": {
                                                    "provisioningLogsCount": "@length(coalesce(body('Update_Group_Verify_Update_Provisioning')?['value'], json('[]')))",
                                                    "hasProvisioningLogs": "@greater(length(coalesce(body('Update_Group_Verify_Update_Provisioning')?['value'], json('[]'))), 0)",
                                                    "provisioningStatus": "@if(greater(length(coalesce(body('Update_Group_Verify_Update_Provisioning')?['value'], json('[]'))), 0), coalesce(first(body('Update_Group_Verify_Update_Provisioning')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                                    "provisioningResult": "@if(equals(variables('UpdateGroupScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('Update_Group_Verify_Update_Provisioning')?['value'], json('[]'))), 0), coalesce(first(body('Update_Group_Verify_Update_Provisioning')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('UpdateGroupFailedActionName')))",
                                                    "provisioningErrorDetails": "@if(equals(variables('UpdateGroupScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Update_Group_Verify_Update_Provisioning')?['value'], json('[]'))), 0), equals(toLower(first(body('Update_Group_Verify_Update_Provisioning')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('Update_Group_Verify_Update_Provisioning')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('UpdateGroupFailedActionResponse'))",
                                                    "overallResult": "@if(equals(variables('UpdateGroupScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Update_Group_Verify_Update_Provisioning')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('Update_Group_Verify_Update_Provisioning')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                                }
                                            },
                                            "Set_UpdateGroup_UpdatePhase_Output_Variables": {
                                                "actions": {
                                                    "Set_UpdateGroupTestOutputs_UpdatePhase": {
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "UpdateGroupTestOutputs",
                                                            "value": {
                                                                "overallResult": "@outputs('Update_Group_Analyze_Update_Provisioning')?['overallResult']",
                                                                "result": "@outputs('Update_Group_Analyze_Update_Provisioning')?['provisioningResult']",
                                                                "errorDetails": "@outputs('Update_Group_Analyze_Update_Provisioning')?['provisioningErrorDetails']"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Update_Group_Analyze_Update_Provisioning": [
                                                        "Succeeded",
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            }
                                        },
                                        "runAfter": {
                                            "Set_UpdateGroup_CreatePhase_Output_Variables": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped"
                                            ]
                                        },
                                        "else": {
                                            "actions": {}
                                        },
                                        "expression": {
                                            "and": [
                                                {
                                                    "equals": [
                                                        "@toLower(variables('UpdateGroupTestOutputs')['overallResult'])",
                                                        "passed"
                                                    ]
                                                }
                                            ]
                                        },
                                        "type": "If"
                                    },
                                    "Update_Group_Cleanup_Delete": {
                                        "runAfter": {
                                            "Update_Group_Check_Create_Phase_Status": [
                                                "Succeeded",
                                                "Failed",
                                                "TimedOut",
                                                "Skipped"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "https://graph.microsoft.com/beta/groups/@{body('Update_Group_Create_Group_Graph')?['id']}",
                                            "method": "DELETE",
                                            "authentication": {
                                                "type": "ManagedServiceIdentity",
                                                "audience": "https://graph.microsoft.com/"
                                            }
                                        }
                                    }
                                },
                                "type": "Scope"
                            }
                        },
                        "else": {
                            "actions": {}
                        },
                        "expression": {
                            "or": [
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "All"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "GroupTests"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "Update_Group_Test"
                                    ]
                                }
                            ]
                        },
                        "type": "If"
                    },
                    "Delete_Group_Test": {
                        "actions": {
                            "Delete_Group_Test_Actions": {
                                "actions": {
                                    "Delete_Group_Verify_Creation_And_Provisioning": {
                                        "actions": {
                                            "Delete_DoUntil_Wait_For_Group_Creation": {
                                                "actions": {
                                                    "Delete_Step3_Fetch_Group_By_Filter": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', outputs('Generate_Test_GroupNames')['deleteGroup'], '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "Delete_Group_Delay_Creation_15s": {
                                                        "runAfter": {
                                                            "Delete_Step3_Fetch_Group_By_Filter": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Delete_Group_Assign_App_Role": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "expression": "@greater(length(coalesce(body('Delete_Step3_Fetch_Group_By_Filter')?['Resources'], json('[]'))), 0)",
                                                "limit": {
                                                    "count": 150,
                                                    "timeout": "PT40M"
                                                },
                                                "type": "Until"
                                            },
                                            "Delete_Group_DoUntil_Poll_Create_Provisioning_Logs": {
                                                "actions": {
                                                    "Delete_Group_Verify_Create_Provisioning_Logs": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Delete_Step2_Create_Group')?['id'], '%27%20and%20provisioningAction%20eq%20%27Create%27')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Accept": "application/json"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "Delete_Group_Delay_Create_Provisioning_Logs_15s": {
                                                        "runAfter": {
                                                            "Delete_Group_Verify_Create_Provisioning_Logs": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Delete_DoUntil_Wait_For_Group_Creation": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "expression": "@greater(length(coalesce(body('Delete_Group_Verify_Create_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                "limit": {
                                                    "count": 140,
                                                    "timeout": "PT15M"
                                                },
                                                "type": "Until"
                                            },
                                            "Delete_Step2_Create_Group": {
                                                "runAfter": {
                                                    "Delete_Step1_Check_Group_Exists": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/groups",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "displayName": "@{outputs('Generate_Test_GroupNames')['deleteGroup']}",
                                                        "description": "@{parameters('defaultGroupProperties')['description']}",
                                                        "mailEnabled": "@parameters('defaultGroupProperties')['mailEnabled']",
                                                        "mailNickname": "@{replace(outputs('Generate_Test_GroupNames')['deleteGroup'], '-', '')}",
                                                        "securityEnabled": "@parameters('defaultGroupProperties')['securityEnabled']",
                                                        "groupTypes": "@parameters('defaultGroupProperties')['groupTypes']",
                                                        "isAssignableToRole": "@parameters('defaultGroupProperties')['isAssignableToRole']",
                                                        "visibility": "@{parameters('defaultGroupProperties')['visibility']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Delete_Step1_Check_Group_Exists": {
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', outputs('Generate_Test_GroupNames')['deleteGroup'], '%22')}",
                                                    "method": "GET",
                                                    "headers": {
                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                        "Accept": "@{parameters('scimContentType')}"
                                                    }
                                                }
                                            },
                                            "Delete_Group_Assign_App_Role": {
                                                "runAfter": {
                                                    "Delete_Step2_Create_Group": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/groups/@{body('Delete_Step2_Create_Group')?['id']}/appRoleAssignments",
                                                    "method": "POST",
                                                    "body": {
                                                        "principalId": "@{body('Delete_Step2_Create_Group')?['id']}",
                                                        "resourceId": "@{parameters('servicePrincipalId')}",
                                                        "appRoleId": "@{first(body('Get_App_Roles')?['appRoles'])?['id']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            }
                                        },
                                        "type": "Scope"
                                    },
                                    "Capture_DeleteGroup_CreatePhase_Failed_Actions": {
                                        "actions": {
                                            "Get_Failed_DeleteGroup_CreatePhase_Actions": {
                                                "type": "Compose",
                                                "inputs": "@result('Delete_Group_Verify_Creation_And_Provisioning')"
                                            },
                                            "Filter_Failed_DeleteGroup_CreatePhase_Actions": {
                                                "runAfter": {
                                                    "Get_Failed_DeleteGroup_CreatePhase_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Query",
                                                "inputs": {
                                                    "from": "@outputs('Get_Failed_DeleteGroup_CreatePhase_Actions')",
                                                    "where": "@equals(item()?['status'], 'Failed')"
                                                }
                                            },
                                            "Set_DeleteGroup_CreatePhase_Failed_Action_Name": {
                                                "runAfter": {
                                                    "Filter_Failed_DeleteGroup_CreatePhase_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DeleteGroupFailedActionName",
                                                    "value": "@{if(greater(length(body('Filter_Failed_DeleteGroup_CreatePhase_Actions')), 0), first(body('Filter_Failed_DeleteGroup_CreatePhase_Actions'))?['name'], 'Unknown_Action')}"
                                                }
                                            },
                                            "Set_DeleteGroup_CreatePhase_Failed_Action_Response": {
                                                "runAfter": {
                                                    "Set_DeleteGroup_CreatePhase_Failed_Action_Name": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DeleteGroupFailedActionResponse",
                                                    "value": "@if(greater(length(body('Filter_Failed_DeleteGroup_CreatePhase_Actions')), 0), coalesce(first(body('Filter_Failed_DeleteGroup_CreatePhase_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                }
                                            },
                                            "Set_DeleteGroup_CreatePhase_Status_Failed": {
                                                "runAfter": {
                                                    "Set_DeleteGroup_CreatePhase_Failed_Action_Response": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DeleteGroupScopeExecutionStatus",
                                                    "value": "Failed"
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Delete_Group_Verify_Creation_And_Provisioning": [
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    },
                                    "Set_DeleteGroup_CreatePhase_Status_Success": {
                                        "runAfter": {
                                            "Delete_Group_Verify_Creation_And_Provisioning": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "DeleteGroupScopeExecutionStatus",
                                            "value": "Succeeded"
                                        }
                                    },
                                    "Delete_Group_Analyze_Create_Provisioning_Results": {
                                        "runAfter": {
                                            "Delete_Group_Verify_Creation_And_Provisioning": [
                                                "Succeeded",
                                                "Failed",
                                                "TimedOut"
                                            ],
                                            "Capture_DeleteGroup_CreatePhase_Failed_Actions": [
                                                "Succeeded",
                                                "Skipped"
                                            ],
                                            "Set_DeleteGroup_CreatePhase_Status_Success": [
                                                "Succeeded",
                                                "Skipped"
                                            ]
                                        },
                                        "type": "Compose",
                                        "inputs": {
                                            "provisioningLogsCount": "@length(coalesce(body('Delete_Group_Verify_Create_Provisioning_Logs')?['value'], json('[]')))",
                                            "hasProvisioningLogs": "@greater(length(coalesce(body('Delete_Group_Verify_Create_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                            "provisioningStatus": "@if(greater(length(coalesce(body('Delete_Group_Verify_Create_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Delete_Group_Verify_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                            "provisioningResult": "@if(equals(variables('DeleteGroupScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('Delete_Group_Verify_Create_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Delete_Group_Verify_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('DeleteGroupFailedActionName')))",
                                            "provisioningErrorDetails": "@if(equals(variables('DeleteGroupScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Delete_Group_Verify_Create_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Delete_Group_Verify_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('Delete_Group_Verify_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('DeleteGroupFailedActionResponse'))",
                                            "overallResult": "@if(equals(variables('DeleteGroupScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Delete_Group_Verify_Create_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('Delete_Group_Verify_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                        }
                                    },
                                    "Delete_Group_Check_Create_Phase_Status": {
                                        "actions": {
                                            "Delete_Group_Verify_Delete_And_Provisioning": {
                                                "actions": {
                                                    "Delete_Step4_Query_Group_By_Id": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', outputs('Generate_Test_GroupNames')['deleteGroup'], '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "Delete_Step5_Delete_Group_By_Id": {
                                                        "runAfter": {
                                                            "Delete_Step4_Query_Group_By_Id": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "https://graph.microsoft.com/beta/groups/@{body('Delete_Step2_Create_Group')?['id']}",
                                                            "method": "DELETE",
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "Delete_DoUntil_Wait_For_Group_Deletion": {
                                                        "actions": {
                                                            "Delete_Step6_Check_Group_Exists_Final": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', outputs('Generate_Test_GroupNames')['deleteGroup'], '%22')}",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                        "Accept": "@{parameters('scimContentType')}"
                                                                    }
                                                                }
                                                            },
                                                            "Delete_Group_Delay_Final_15s": {
                                                                "runAfter": {
                                                                    "Delete_Step6_Check_Group_Exists_Final": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Delete_Step5_Delete_Group_By_Id": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "expression": "@equals(length(coalesce(body('Delete_Step6_Check_Group_Exists_Final')?['Resources'], json('[]'))), 0)",
                                                        "limit": {
                                                            "count": 150,
                                                            "timeout": "PT40M"
                                                        },
                                                        "type": "Until"
                                                    },
                                                    "Delete_Group_DoUntil_Poll_Delete_Provisioning_Logs": {
                                                        "actions": {
                                                            "Delete_Group_Verify_Delete_Provisioning_Logs": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Delete_Step2_Create_Group')?['id'], '%27%20and%20provisioningAction%20eq%20%27Delete%27')}",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Accept": "application/json"
                                                                    },
                                                                    "authentication": {
                                                                        "type": "ManagedServiceIdentity",
                                                                        "audience": "https://graph.microsoft.com/"
                                                                    }
                                                                }
                                                            },
                                                            "Delete_Group_Delay_Delete_Provisioning_Logs_15s": {
                                                                "runAfter": {
                                                                    "Delete_Group_Verify_Delete_Provisioning_Logs": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Delete_DoUntil_Wait_For_Group_Deletion": [
                                                                "Succeeded",
                                                                "Failed",
                                                                "TimedOut"
                                                            ]
                                                        },
                                                        "expression": "@greater(length(coalesce(body('Delete_Group_Verify_Delete_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                        "limit": {
                                                            "count": 140,
                                                            "timeout": "PT15M"
                                                        },
                                                        "type": "Until"
                                                    }
                                                },
                                                "type": "Scope"
                                            },
                                            "Capture_DeleteGroup_DeletePhase_Failed_Actions": {
                                                "actions": {
                                                    "Get_Failed_DeleteGroup_DeletePhase_Actions": {
                                                        "type": "Compose",
                                                        "inputs": "@result('Delete_Group_Verify_Delete_And_Provisioning')"
                                                    },
                                                    "Filter_Failed_DeleteGroup_DeletePhase_Actions": {
                                                        "runAfter": {
                                                            "Get_Failed_DeleteGroup_DeletePhase_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Query",
                                                        "inputs": {
                                                            "from": "@outputs('Get_Failed_DeleteGroup_DeletePhase_Actions')",
                                                            "where": "@equals(item()?['status'], 'Failed')"
                                                        }
                                                    },
                                                    "Set_DeleteGroup_DeletePhase_Failed_Action_Name": {
                                                        "runAfter": {
                                                            "Filter_Failed_DeleteGroup_DeletePhase_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "DeleteGroupFailedActionName",
                                                            "value": "@{if(greater(length(body('Filter_Failed_DeleteGroup_DeletePhase_Actions')), 0), first(body('Filter_Failed_DeleteGroup_DeletePhase_Actions'))?['name'], 'Unknown_Action')}"
                                                        }
                                                    },
                                                    "Set_DeleteGroup_DeletePhase_Failed_Action_Response": {
                                                        "runAfter": {
                                                            "Set_DeleteGroup_DeletePhase_Failed_Action_Name": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "DeleteGroupFailedActionResponse",
                                                            "value": "@if(greater(length(body('Filter_Failed_DeleteGroup_DeletePhase_Actions')), 0), coalesce(first(body('Filter_Failed_DeleteGroup_DeletePhase_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                        }
                                                    },
                                                    "Set_DeleteGroup_DeletePhase_Status_Failed": {
                                                        "runAfter": {
                                                            "Set_DeleteGroup_DeletePhase_Failed_Action_Response": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "DeleteGroupScopeExecutionStatus",
                                                            "value": "Failed"
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Delete_Group_Verify_Delete_And_Provisioning": [
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            },
                                            "Set_DeleteGroup_DeletePhase_Status_Success": {
                                                "runAfter": {
                                                    "Delete_Group_Verify_Delete_And_Provisioning": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DeleteGroupScopeExecutionStatus",
                                                    "value": "Succeeded"
                                                }
                                            },
                                            "Delete_Group_Analyze_Delete_Provisioning_Results": {
                                                "runAfter": {
                                                    "Delete_Group_Verify_Delete_And_Provisioning": [
                                                        "Succeeded",
                                                        "Failed",
                                                        "TimedOut"
                                                    ],
                                                    "Capture_DeleteGroup_DeletePhase_Failed_Actions": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ],
                                                    "Set_DeleteGroup_DeletePhase_Status_Success": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ]
                                                },
                                                "type": "Compose",
                                                "inputs": {
                                                    "provisioningLogsCount": "@length(coalesce(body('Delete_Group_Verify_Delete_Provisioning_Logs')?['value'], json('[]')))",
                                                    "hasProvisioningLogs": "@greater(length(coalesce(body('Delete_Group_Verify_Delete_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                    "provisioningStatus": "@if(greater(length(coalesce(body('Delete_Group_Verify_Delete_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Delete_Group_Verify_Delete_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                                    "provisioningResult": "@if(equals(variables('DeleteGroupScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('Delete_Group_Verify_Delete_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Delete_Group_Verify_Delete_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('DeleteGroupFailedActionName')))",
                                                    "provisioningErrorDetails": "@if(equals(variables('DeleteGroupScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Delete_Group_Verify_Delete_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Delete_Group_Verify_Delete_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('Delete_Group_Verify_Delete_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('DeleteGroupFailedActionResponse'))",
                                                    "overallResult": "@if(equals(variables('DeleteGroupScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Delete_Group_Verify_Delete_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('Delete_Group_Verify_Delete_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                                }
                                            },
                                            "Set_DeleteGroup_Output_Variables": {
                                                "actions": {
                                                    "Set_DeleteGroupTestOutputs_DeletePhase": {
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "DeleteGroupTestOutputs",
                                                            "value": {
                                                                "overallResult": "@coalesce(outputs('Delete_Group_Analyze_Delete_Provisioning_Results')?['overallResult'], 'FAILED')",
                                                                "result": "@coalesce(outputs('Delete_Group_Analyze_Delete_Provisioning_Results')?['provisioningResult'], 'SKIPPED')",
                                                                "errorDetails": "@coalesce(outputs('Delete_Group_Analyze_Delete_Provisioning_Results')?['provisioningErrorDetails'], null)"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Delete_Group_Analyze_Delete_Provisioning_Results": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Scope"
                                            }
                                        },
                                        "runAfter": {
                                            "Set_DeleteGroup_CreatePhase_Output_Variables": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped"
                                            ]
                                        },
                                        "else": {
                                            "actions": {}
                                        },
                                        "expression": {
                                            "and": [
                                                {
                                                    "equals": [
                                                        "@toLower(variables('DeleteGroupTestOutputs')['overallResult'])",
                                                        "passed"
                                                    ]
                                                }
                                            ]
                                        },
                                        "type": "If"
                                    },
                                    "Set_DeleteGroup_CreatePhase_Output_Variables": {
                                        "actions": {
                                            "Set_DeleteGroupTestOutputs_CreatePhase": {
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "DeleteGroupTestOutputs",
                                                    "value": {
                                                        "overallResult": "@outputs('Delete_Group_Analyze_Create_Provisioning_Results')?['overallResult']",
                                                        "result": "@outputs('Delete_Group_Analyze_Create_Provisioning_Results')?['provisioningResult']",
                                                        "errorDetails": "@outputs('Delete_Group_Analyze_Create_Provisioning_Results')?['provisioningErrorDetails']"
                                                    }
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Delete_Group_Analyze_Create_Provisioning_Results": [
                                                "Succeeded",
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    }
                                },
                                "type": "Scope"
                            }
                        },
                        "else": {
                            "actions": {}
                        },
                        "expression": {
                            "or": [
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "All"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "GroupTests"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "Delete_Group_Test"
                                    ]
                                }
                            ]
                        },
                        "type": "If"
                    },
                    "Group_Update_Add_Member_Test": {
                        "actions": {
                            "Group_Update_Add_Member_Test_Actions": {
                                "actions": {
                                    "Add_Member_Verify_Creation_And_Provisioning": {
                                        "actions": {
                                            "Add_DoUntil_Wait_For_Initial_Sync": {
                                                "actions": {
                                                    "Add_Step4_Check_Group_And_User": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', outputs('Generate_Test_GroupNames')['memberGroup'], '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "Add_Step4_Check_User": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['memberUser1'], ''), '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "Add_Delay_Initial_15s": {
                                                        "runAfter": {
                                                            "Add_Step4_Check_Group_And_User": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ],
                                                            "Add_Step4_Check_User": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Add_Assign_Group_To_App": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "expression": "@and(greater(length(coalesce(body('Add_Step4_Check_Group_And_User')?['Resources'], json('[]'))), 0), greater(length(coalesce(body('Add_Step4_Check_User')?['Resources'], json('[]'))), 0))",
                                                "limit": {
                                                    "count": 150,
                                                    "timeout": "PT40M"
                                                },
                                                "type": "Until"
                                            },
                                            "Add_Member_DoUntil_Poll_Group_Create_Provisioning_Logs": {
                                                "actions": {
                                                    "Add_Member_Verify_Group_Create_Provisioning_Logs": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Add_Step2_Create_Group')?['id'], '%27%20and%20provisioningAction%20eq%20%27Create%27')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Accept": "application/json"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "Add_Member_Delay_Group_Create_Provisioning_Logs_15s": {
                                                        "runAfter": {
                                                            "Add_Member_Verify_Group_Create_Provisioning_Logs": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ],
                                                            "Add_Member_Verify_User_Create_Provisioning_Logs": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    },
                                                    "Add_Member_Verify_User_Create_Provisioning_Logs": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Add_Step3_Create_Member_User')?['id'], '%27%20and%20provisioningAction%20eq%20%27Create%27')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Accept": "application/json"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Add_DoUntil_Wait_For_Initial_Sync": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "expression": "@and(greater(length(coalesce(body('Add_Member_Verify_Group_Create_Provisioning_Logs')?['value'], json('[]'))), 0), greater(length(coalesce(body('Add_Member_Verify_User_Create_Provisioning_Logs')?['value'], json('[]'))), 0))",
                                                "limit": {
                                                    "count": 140,
                                                    "timeout": "PT15M"
                                                },
                                                "type": "Until"
                                            },
                                            "Add_Assign_Group_To_App": {
                                                "runAfter": {
                                                    "Add_Assign_User_To_App": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/servicePrincipals/@{parameters('servicePrincipalId')}/appRoleAssignedTo",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "principalId": "@{body('Add_Step2_Create_Group')?['id']}",
                                                        "resourceId": "@{parameters('servicePrincipalId')}",
                                                        "appRoleId": "@{first(body('Get_App_Roles')?['appRoles'])?['id']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Add_Assign_User_To_App": {
                                                "runAfter": {
                                                    "Add_Step3_Create_Member_User": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users/@{body('Add_Step3_Create_Member_User')?['id']}/appRoleAssignments",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "principalId": "@{body('Add_Step3_Create_Member_User')?['id']}",
                                                        "resourceId": "@{parameters('servicePrincipalId')}",
                                                        "appRoleId": "@{first(body('Get_App_Roles')?['appRoles'])?['id']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Add_Step3_Create_Member_User": {
                                                "runAfter": {
                                                    "Add_Step2_Create_Group": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "accountEnabled": true,
                                                        "displayName": "@{outputs('Generate_Test_UserNames')['memberUser1']}",
                                                        "mailNickname": "@{replace(first(split(outputs('Generate_Test_UserNames')['memberUser1'],'@')),'.','')}",
                                                        "userPrincipalName": "@{outputs('Generate_Test_UserNames')['memberUser1']}",
                                                        "givenName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName']), concat('Given', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName'])}",
                                                        "surname": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname']), concat('Sur', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname'])}",
                                                        "jobTitle": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle']), concat('Title', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle'])}",
                                                        "department": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department']), concat('Dept', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department'])}",
                                                        "companyName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName']), concat('Company', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName'])}",
                                                        "businessPhones": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['businessPhones'], json(concat('[\"+ 1-555-', substring(guid(),0,4), '\"]')))",
                                                        "mobilePhone": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone'])}",
                                                        "officeLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation']), concat('Office', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation'])}",
                                                        "preferredLanguage": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage']), 'en-US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage'])}",
                                                        "employeeId": "@{substring(guid(), 0, 8)}",
                                                        "employeeType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType']), 'Employee', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType'])}",
                                                        "streetAddress": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress']), concat('Street', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress'])}",
                                                        "city": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city']), concat('City', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city'])}",
                                                        "state": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state']), 'WA', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state'])}",
                                                        "country": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country'])}",
                                                        "postalCode": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode'])}",
                                                        "usageLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation'])}",
                                                        "otherMails": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['otherMails'], json(concat('[\"', substring(guid(),0,8), '@example.com\"]')))",
                                                        "mail": "@{outputs('Generate_Test_UserNames')['memberUser1']}",
                                                        "faxNumber": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber'])}",
                                                        "userType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType']), 'Member', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType'])}",
                                                        "employeeOrgData": "@if(or(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'])), json(concat('{\"division\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), concat('Div', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), '\",\"costCenter\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), '\"}')), json(concat('{\"division\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division'], '\",\"costCenter\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'], '\"}')))",
                                                        "passwordProfile": {
                                                            "forceChangePasswordNextSignIn": "@{coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['forceChangePasswordNextSignIn'], true)}",
                                                            "password": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['password']), concat('Tmp!', substring(guid(),0,8), '@', substring(guid(),24,8)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['password'])}"
                                                        }
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Add_Step2_Create_Group": {
                                                "runAfter": {
                                                    "Add_Step1_Check_Group_Exists": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/groups",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "displayName": "@{outputs('Generate_Test_GroupNames')['memberGroup']}",
                                                        "description": "@{parameters('defaultGroupProperties')['description']}",
                                                        "mailEnabled": "@parameters('defaultGroupProperties')['mailEnabled']",
                                                        "mailNickname": "@{replace(outputs('Generate_Test_GroupNames')['memberGroup'], '-', '')}",
                                                        "securityEnabled": "@parameters('defaultGroupProperties')['securityEnabled']",
                                                        "groupTypes": "@parameters('defaultGroupProperties')['groupTypes']",
                                                        "isAssignableToRole": "@parameters('defaultGroupProperties')['isAssignableToRole']",
                                                        "visibility": "@{parameters('defaultGroupProperties')['visibility']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Add_Step1_Check_Group_Exists": {
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', outputs('Generate_Test_GroupNames')['memberGroup'], '%22')}",
                                                    "method": "GET",
                                                    "headers": {
                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                        "Accept": "@{parameters('scimContentType')}"
                                                    }
                                                }
                                            }
                                        },
                                        "type": "Scope"
                                    },
                                    "Add_Member_Analyze_Group_Create_Provisioning_Results": {
                                        "runAfter": {
                                            "Add_Member_Verify_Creation_And_Provisioning": [
                                                "Succeeded",
                                                "Failed",
                                                "TimedOut"
                                            ],
                                            "Capture_AddMember_CreatePhase_Failed_Actions": [
                                                "Succeeded",
                                                "Skipped"
                                            ],
                                            "Set_AddMember_CreatePhase_Status_Success": [
                                                "Succeeded",
                                                "Skipped"
                                            ]
                                        },
                                        "type": "Compose",
                                        "inputs": {
                                            "provisioningStatus": "@concat('Group: ', if(greater(length(coalesce(body('Add_Member_Verify_Group_Create_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Add_Member_Verify_Group_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS'), ', User: ', if(greater(length(coalesce(body('Add_Member_Verify_User_Create_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Add_Member_Verify_User_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS'))",
                                            "provisioningResult": "@if(equals(variables('AddMemberScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Add_Member_Verify_Group_Create_Provisioning_Logs')?['value'], json('[]'))), 0), greater(length(coalesce(body('Add_Member_Verify_User_Create_Provisioning_Logs')?['value'], json('[]'))), 0)), concat('Group: ', coalesce(first(body('Add_Member_Verify_Group_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), ', User: ', coalesce(first(body('Add_Member_Verify_User_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN')), 'PROVISIONING_LOGS_MISSING'), concat('Failed Action: ', variables('AddMemberFailedActionName')))",
                                            "provisioningErrorDetails": "@if(equals(variables('AddMemberScopeExecutionStatus'), 'Succeeded'), if(or(and(greater(length(coalesce(body('Add_Member_Verify_Group_Create_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Add_Member_Verify_Group_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), and(greater(length(coalesce(body('Add_Member_Verify_User_Create_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Add_Member_Verify_User_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure'))), json(concat('{\"group\":', string(coalesce(first(body('Add_Member_Verify_Group_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null)), ',\"user\":', string(coalesce(first(body('Add_Member_Verify_User_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null)), '}')), null), variables('AddMemberFailedActionResponse'))",
                                            "overallResult": "@if(equals(variables('AddMemberScopeExecutionStatus'), 'Succeeded'), if(and(and(greater(length(coalesce(body('Add_Member_Verify_Group_Create_Provisioning_Logs')?['value'], json('[]'))), 0), greater(length(coalesce(body('Add_Member_Verify_User_Create_Provisioning_Logs')?['value'], json('[]'))), 0)), and(equals(toLower(coalesce(first(body('Add_Member_Verify_Group_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success'), equals(toLower(coalesce(first(body('Add_Member_Verify_User_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success'))), 'PASSED', 'FAILED'), 'FAILED')"
                                        }
                                    },
                                    "Add_Member_Check_Create_Phase_Status": {
                                        "actions": {
                                            "Add_Member_Verify_Update_And_Provisioning": {
                                                "actions": {
                                                    "Add_Step5_Add_User_To_Group": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "https://graph.microsoft.com/beta/groups/@{body('Add_Step2_Create_Group')?['id']}/members/$ref",
                                                            "method": "POST",
                                                            "headers": {
                                                                "Content-Type": "application/json"
                                                            },
                                                            "body": {
                                                                "@@odata.id": "https://graph.microsoft.com/beta/users/@{body('Add_Step3_Create_Member_User')?['id']}"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "Add_DoUntil_Wait_For_Member_Addition": {
                                                        "actions": {
                                                            "Add_Step6_Query_Group_With_Members": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', outputs('Generate_Test_GroupNames')['memberGroup'], '%22')}",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                        "Accept": "@{parameters('scimContentType')}"
                                                                    }
                                                                }
                                                            },
                                                            "Add_Delay_Member_15s": {
                                                                "runAfter": {
                                                                    "Add_Step6_Query_Group_With_Members": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Add_Step5_Add_User_To_Group": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "expression": "@and(greater(length(coalesce(body('Add_Step6_Query_Group_With_Members')?['Resources'], json('[]'))), 0), and(greater(length(coalesce(first(coalesce(body('Add_Step6_Query_Group_With_Members')?['Resources'], json('[]')))?['members'], json('[]'))), 0), contains(string(coalesce(first(coalesce(body('Add_Step6_Query_Group_With_Members')?['Resources'], json('[]')))?['members'], json('[]'))), coalesce(first(coalesce(body('Add_Step4_Check_User')?['Resources'], json('[]')))?['id'], ''))))",
                                                        "limit": {
                                                            "count": 150,
                                                            "timeout": "PT40M"
                                                        },
                                                        "type": "Until"
                                                    },
                                                    "Add_Step7_Query_Group_By_Id": {
                                                        "runAfter": {
                                                            "Add_DoUntil_Wait_For_Member_Addition": [
                                                                "Succeeded",
                                                                "TimedOut",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', outputs('Generate_Test_GroupNames')['memberGroup'], '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "Add_Member_DoUntil_Poll_Add_Member_Provisioning_Logs": {
                                                        "actions": {
                                                            "Add_Member_Verify_Add_Member_Provisioning_Logs": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Add_Step2_Create_Group')?['id'], '%27%20and%20provisioningAction%20eq%20%27Update%27%20and%20modifiedProperties/any(p:%20p/displayName%20eq%20%27members%27)&$orderby=activityDateTime%20desc&$top=1')}",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Accept": "application/json"
                                                                    },
                                                                    "authentication": {
                                                                        "type": "ManagedServiceIdentity",
                                                                        "audience": "https://graph.microsoft.com/"
                                                                    }
                                                                }
                                                            },
                                                            "Add_Member_Delay_Add_Member_Provisioning_Logs_15s": {
                                                                "runAfter": {
                                                                    "Add_Member_Verify_Add_Member_Provisioning_Logs": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Add_Step7_Query_Group_By_Id": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "expression": "@and(greater(length(coalesce(body('Add_Member_Verify_Add_Member_Provisioning_Logs')?['value'], json('[]'))), 0), and(empty(first(body('Add_Member_Verify_Add_Member_Provisioning_Logs')?['value'])?['modifiedProperties'][0]?['oldValue']), not(empty(first(body('Add_Member_Verify_Add_Member_Provisioning_Logs')?['value'])?['modifiedProperties'][0]?['newValue']))))",
                                                        "limit": {
                                                            "count": 140,
                                                            "timeout": "PT15M"
                                                        },
                                                        "type": "Until"
                                                    }
                                                },
                                                "type": "Scope"
                                            },
                                            "Capture_AddMember_AddMemberPhase_Failed_Actions": {
                                                "actions": {
                                                    "Get_Failed_AddMember_UpdatePhase_Actions": {
                                                        "type": "Compose",
                                                        "inputs": "@result('Add_Member_Verify_Update_And_Provisioning')"
                                                    },
                                                    "Filter_Failed_AddMember_UpdatePhase_Actions": {
                                                        "runAfter": {
                                                            "Get_Failed_AddMember_UpdatePhase_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Query",
                                                        "inputs": {
                                                            "from": "@outputs('Get_Failed_AddMember_UpdatePhase_Actions')",
                                                            "where": "@equals(item()?['status'], 'Failed')"
                                                        }
                                                    },
                                                    "Set_AddMember_UpdatePhase_Failed_Action_Name": {
                                                        "runAfter": {
                                                            "Filter_Failed_AddMember_UpdatePhase_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "AddMemberFailedActionName",
                                                            "value": "@{if(greater(length(body('Filter_Failed_AddMember_UpdatePhase_Actions')), 0), first(body('Filter_Failed_AddMember_UpdatePhase_Actions'))?['name'], 'Unknown_Action')}"
                                                        }
                                                    },
                                                    "Set_AddMember_UpdatePhase_Failed_Action_Response": {
                                                        "runAfter": {
                                                            "Set_AddMember_UpdatePhase_Failed_Action_Name": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "AddMemberFailedActionResponse",
                                                            "value": "@if(greater(length(body('Filter_Failed_AddMember_UpdatePhase_Actions')), 0), coalesce(first(body('Filter_Failed_AddMember_UpdatePhase_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                        }
                                                    },
                                                    "Set_AddMember_UpdatePhase_Status_Failed": {
                                                        "runAfter": {
                                                            "Set_AddMember_UpdatePhase_Failed_Action_Response": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "AddMemberScopeExecutionStatus",
                                                            "value": "Failed"
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Add_Member_Verify_Update_And_Provisioning": [
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            },
                                            "Set_AddMember_UpdatePhase_Status_Success": {
                                                "runAfter": {
                                                    "Add_Member_Verify_Update_And_Provisioning": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "AddMemberScopeExecutionStatus",
                                                    "value": "Succeeded"
                                                }
                                            },
                                            "Add_Member_Analyze_Add_Member_Provisioning_Results": {
                                                "runAfter": {
                                                    "Add_Member_Verify_Update_And_Provisioning": [
                                                        "Succeeded",
                                                        "Failed",
                                                        "TimedOut"
                                                    ],
                                                    "Capture_AddMember_AddMemberPhase_Failed_Actions": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ],
                                                    "Set_AddMember_UpdatePhase_Status_Success": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ]
                                                },
                                                "type": "Compose",
                                                "inputs": {
                                                    "provisioningLogsCount": "@length(coalesce(body('Add_Member_Verify_Add_Member_Provisioning_Logs')?['value'], json('[]')))",
                                                    "hasProvisioningLogs": "@greater(length(coalesce(body('Add_Member_Verify_Add_Member_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                    "provisioningStatus": "@if(greater(length(coalesce(body('Add_Member_Verify_Add_Member_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Add_Member_Verify_Add_Member_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND')",
                                                    "provisioningResult": "@if(equals(variables('AddMemberScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('Add_Member_Verify_Add_Member_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Add_Member_Verify_Add_Member_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('AddMemberFailedActionName')))",
                                                    "provisioningErrorDetails": "@if(equals(variables('AddMemberScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Add_Member_Verify_Add_Member_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Add_Member_Verify_Add_Member_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('Add_Member_Verify_Add_Member_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('AddMemberFailedActionResponse'))",
                                                    "overallResult": "@if(equals(variables('AddMemberScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Add_Member_Verify_Add_Member_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('Add_Member_Verify_Add_Member_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                                }
                                            },
                                            "Set_AddMember_UpdatePhase_Output_Variables": {
                                                "actions": {
                                                    "Set_AddMemberTestOutputs_UpdatePhase": {
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "AddMemberTestOutputs",
                                                            "value": {
                                                                "overallResult": "@outputs('Add_Member_Analyze_Add_Member_Provisioning_Results')?['overallResult']",
                                                                "result": "@outputs('Add_Member_Analyze_Add_Member_Provisioning_Results')?['provisioningResult']",
                                                                "errorDetails": "@outputs('Add_Member_Analyze_Add_Member_Provisioning_Results')?['provisioningErrorDetails']"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Add_Member_Analyze_Add_Member_Provisioning_Results": [
                                                        "Succeeded",
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            }
                                        },
                                        "runAfter": {
                                            "Set_AddMember_CreatePhase_Output_Variables": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped"
                                            ]
                                        },
                                        "else": {
                                            "actions": {}
                                        },
                                        "expression": {
                                            "and": [
                                                {
                                                    "equals": [
                                                        "@toLower(variables('AddMemberTestOutputs')['overallResult'])",
                                                        "passed"
                                                    ]
                                                }
                                            ]
                                        },
                                        "type": "If"
                                    },
                                    "Add_Cleanup_Delete_User": {
                                        "runAfter": {
                                            "Add_Member_Check_Create_Phase_Status": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped",
                                                "TimedOut"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "https://graph.microsoft.com/beta/users/@{body('Add_Step3_Create_Member_User')?['id']}",
                                            "method": "DELETE",
                                            "authentication": {
                                                "type": "ManagedServiceIdentity",
                                                "audience": "https://graph.microsoft.com/"
                                            }
                                        }
                                    },
                                    "Add_Cleanup_Delete_Group": {
                                        "runAfter": {
                                            "Add_Cleanup_Delete_User": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped",
                                                "TimedOut"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "https://graph.microsoft.com/beta/groups/@{body('Add_Step2_Create_Group')?['id']}",
                                            "method": "DELETE",
                                            "authentication": {
                                                "type": "ManagedServiceIdentity",
                                                "audience": "https://graph.microsoft.com/"
                                            }
                                        }
                                    },
                                    "Capture_AddMember_CreatePhase_Failed_Actions": {
                                        "actions": {
                                            "Get_Failed_AddMember_CreatePhase_Actions": {
                                                "type": "Compose",
                                                "inputs": "@result('Add_Member_Verify_Creation_And_Provisioning')"
                                            },
                                            "Filter_Failed_AddMember_CreatePhase_Actions": {
                                                "runAfter": {
                                                    "Get_Failed_AddMember_CreatePhase_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Query",
                                                "inputs": {
                                                    "from": "@outputs('Get_Failed_AddMember_CreatePhase_Actions')",
                                                    "where": "@equals(item()?['status'], 'Failed')"
                                                }
                                            },
                                            "Set_AddMember_CreatePhase_Failed_Action_Name": {
                                                "runAfter": {
                                                    "Filter_Failed_AddMember_CreatePhase_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "AddMemberFailedActionName",
                                                    "value": "@{if(greater(length(body('Filter_Failed_AddMember_CreatePhase_Actions')), 0), first(body('Filter_Failed_AddMember_CreatePhase_Actions'))?['name'], 'Unknown_Action')}"
                                                }
                                            },
                                            "Set_AddMember_CreatePhase_Failed_Action_Response": {
                                                "runAfter": {
                                                    "Set_AddMember_CreatePhase_Failed_Action_Name": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "AddMemberFailedActionResponse",
                                                    "value": "@if(greater(length(body('Filter_Failed_AddMember_CreatePhase_Actions')), 0), coalesce(first(body('Filter_Failed_AddMember_CreatePhase_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                }
                                            },
                                            "Set_AddMember_CreatePhase_Status_Failed": {
                                                "runAfter": {
                                                    "Set_AddMember_CreatePhase_Failed_Action_Response": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "AddMemberScopeExecutionStatus",
                                                    "value": "Failed"
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Add_Member_Verify_Creation_And_Provisioning": [
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    },
                                    "Set_AddMember_CreatePhase_Status_Success": {
                                        "runAfter": {
                                            "Add_Member_Verify_Creation_And_Provisioning": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "AddMemberScopeExecutionStatus",
                                            "value": "Succeeded"
                                        }
                                    },
                                    "Set_AddMember_CreatePhase_Output_Variables": {
                                        "actions": {
                                            "Set_AddMemberTestOutputs_CreatePhase": {
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "AddMemberTestOutputs",
                                                    "value": {
                                                        "overallResult": "@outputs('Add_Member_Analyze_Group_Create_Provisioning_Results')?['overallResult']",
                                                        "result": "@outputs('Add_Member_Analyze_Group_Create_Provisioning_Results')?['provisioningResult']",
                                                        "errorDetails": "@outputs('Add_Member_Analyze_Group_Create_Provisioning_Results')?['provisioningErrorDetails']"
                                                    }
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Add_Member_Analyze_Group_Create_Provisioning_Results": [
                                                "Succeeded",
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    }
                                },
                                "type": "Scope"
                            }
                        },
                        "else": {
                            "actions": {}
                        },
                        "expression": {
                            "or": [
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "All"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "GroupTests"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "Group_Update_Add_Member_Test"
                                    ]
                                }
                            ]
                        },
                        "type": "If"
                    },
                    "Group_Update_Remove_Member_Test": {
                        "actions": {
                            "Group_Update_Remove_Member_Test_-_Actions": {
                                "actions": {
                                    "Remove_Member_Test_-_Verify_Creation_And_Provisioning": {
                                        "actions": {
                                            "Remove_DoUntil_Wait_For_Initial_Member_Addition": {
                                                "actions": {
                                                    "Remove_Step4a_Check_Group_With_Member": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', outputs('Generate_Test_GroupNames')['memberGroup'], '-Remove%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "Remove_Step4b_Check_User": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Users?filter=userName%20eq%20%22', coalesce(outputs('Generate_Test_UserNames')?['memberUser2'], ''), '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "Remove_Delay_Initial_15s": {
                                                        "runAfter": {
                                                            "Remove_Step4a_Check_Group_With_Member": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ],
                                                            "Remove_Step4b_Check_User": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Remove_Step4_Add_User_To_Group": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "expression": "@and(and(greater(length(coalesce(body('Remove_Step4a_Check_Group_With_Member')?['Resources'], json('[]'))), 0), greater(length(coalesce(body('Remove_Step4b_Check_User')?['Resources'], json('[]'))), 0)), and(not(empty(first(coalesce(body('Remove_Step4b_Check_User')?['Resources'], json('[]'))))), contains(string(body('Remove_Step4a_Check_Group_With_Member')), coalesce(first(coalesce(body('Remove_Step4b_Check_User')?['Resources'], json('[]')))?['id'], ''))))",
                                                "limit": {
                                                    "count": 150,
                                                    "timeout": "PT40M"
                                                },
                                                "type": "Until"
                                            },
                                            "Remove_Member_DoUntil_Poll_Group_Create_Provisioning_Logs": {
                                                "actions": {
                                                    "Remove_Member_Verify_Group_Create_Provisioning_Logs": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Remove_Step2_Create_Group')?['id'], '%27%20and%20provisioningAction%20eq%20%27Update%27%20and%20modifiedProperties/any(p:%20p/displayName%20eq%20%27members%27)&$top=1&$orderby=activityDateTime%20desc')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Accept": "application/json"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "Remove_Member_Verify_User_Create_Provisioning_Logs": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$top=1&$orderby=activityDateTime%20desc&$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Remove_Step3_Create_Member_User')?['id'], '%27%20and%20provisioningAction%20eq%20%27Create%27')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Accept": "application/json"
                                                            },
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "Remove_Member_Delay_Group_Create_Provisioning_Logs_15s": {
                                                        "runAfter": {
                                                            "Remove_Member_Verify_Group_Create_Provisioning_Logs": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ],
                                                            "Remove_Member_Verify_User_Create_Provisioning_Logs": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Wait",
                                                        "inputs": {
                                                            "interval": {
                                                                "count": 15,
                                                                "unit": "Second"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Remove_DoUntil_Wait_For_Initial_Member_Addition": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "expression": "@and(greater(length(coalesce(body('Remove_Member_Verify_Group_Create_Provisioning_Logs')?['value'], json('[]'))), 0), greater(length(coalesce(body('Remove_Member_Verify_User_Create_Provisioning_Logs')?['value'], json('[]'))), 0), and(not(empty(first(body('Remove_Member_Verify_Group_Create_Provisioning_Logs')?['value'])?['modifiedProperties'][0]?['newValue'])), empty(first(body('Remove_Member_Verify_Group_Create_Provisioning_Logs')?['value'])?['modifiedProperties'][0]?['oldValue'])))",
                                                "limit": {
                                                    "count": 140,
                                                    "timeout": "PT15M"
                                                },
                                                "type": "Until"
                                            },
                                            "Remove_Step4_Add_User_To_Group": {
                                                "runAfter": {
                                                    "Remove_Assign_Group_To_App": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/groups/@{body('Remove_Step2_Create_Group')?['id']}/members/$ref",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "@@odata.id": "https://graph.microsoft.com/beta/users/@{body('Remove_Step3_Create_Member_User')?['id']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Remove_Assign_Group_To_App": {
                                                "runAfter": {
                                                    "Remove_Assign_User_To_App": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/servicePrincipals/@{parameters('servicePrincipalId')}/appRoleAssignedTo",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "principalId": "@{body('Remove_Step2_Create_Group')?['id']}",
                                                        "resourceId": "@{parameters('servicePrincipalId')}",
                                                        "appRoleId": "@{first(body('Get_App_Roles')?['appRoles'])?['id']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Remove_Assign_User_To_App": {
                                                "runAfter": {
                                                    "Remove_Step3_Create_Member_User": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users/@{body('Remove_Step3_Create_Member_User')?['id']}/appRoleAssignments",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "principalId": "@{body('Remove_Step3_Create_Member_User')?['id']}",
                                                        "resourceId": "@{parameters('servicePrincipalId')}",
                                                        "appRoleId": "@{first(body('Get_App_Roles')?['appRoles'])?['id']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Remove_Step3_Create_Member_User": {
                                                "runAfter": {
                                                    "Remove_Step2_Create_Group": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/users",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "accountEnabled": true,
                                                        "displayName": "@{outputs('Generate_Test_UserNames')['memberUser2']}",
                                                        "mailNickname": "@{replace(first(split(outputs('Generate_Test_UserNames')['memberUser2'],'@')),'.','')}",
                                                        "userPrincipalName": "@{outputs('Generate_Test_UserNames')['memberUser2']}",
                                                        "givenName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName']), concat('Given', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['givenName'])}",
                                                        "surname": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname']), concat('Sur', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['surname'])}",
                                                        "jobTitle": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle']), concat('Title', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['jobTitle'])}",
                                                        "department": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department']), concat('Dept', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['department'])}",
                                                        "companyName": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName']), concat('Company', substring(guid(),0,6)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['companyName'])}",
                                                        "businessPhones": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['businessPhones'], json(concat('[\"+ 1-555-', substring(guid(),0,4), '\"]')))",
                                                        "mobilePhone": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['mobilePhone'])}",
                                                        "officeLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation']), concat('Office', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['officeLocation'])}",
                                                        "preferredLanguage": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage']), 'en-US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['preferredLanguage'])}",
                                                        "employeeId": "@{substring(guid(), 0, 8)}",
                                                        "employeeType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType']), 'Employee', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeType'])}",
                                                        "streetAddress": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress']), concat('Street', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['streetAddress'])}",
                                                        "city": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city']), concat('City', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['city'])}",
                                                        "state": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state']), 'WA', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['state'])}",
                                                        "country": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['country'])}",
                                                        "postalCode": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['postalCode'])}",
                                                        "usageLocation": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation']), 'US', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['usageLocation'])}",
                                                        "otherMails": "@coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['otherMails'], json(concat('[\"', substring(guid(),0,8), '@example.com\"]')))",
                                                        "mail": "@{outputs('Generate_Test_UserNames')['memberUser2']}",
                                                        "faxNumber": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber']), concat('+1-555-', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['faxNumber'])}",
                                                        "userType": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType']), 'Member', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['userType'])}",
                                                        "employeeOrgData": "@if(or(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'])), json(concat('{\"division\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), concat('Div', substring(guid(),0,4)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division']), '\",\"costCenter\":\"', if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), substring(guid(),0,5), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter']), '\"}')), json(concat('{\"division\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['division'], '\",\"costCenter\":\"', parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['employeeOrgData']['costCenter'], '\"}')))",
                                                        "passwordProfile": {
                                                            "forceChangePasswordNextSignIn": "@{coalesce(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['forceChangePasswordNextSignIn'], true)}",
                                                            "password": "@{if(empty(parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['password']), concat('Tmp!', substring(guid(),0,8), '@', substring(guid(),24,8)), parameters('defaultUserProperties')[outputs('Generate_Test_UserNames')['index']]['passwordProfile']['password'])}"
                                                        }
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Remove_Step2_Create_Group": {
                                                "runAfter": {
                                                    "Remove_Step1_Check_Group_Exists": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "https://graph.microsoft.com/beta/groups",
                                                    "method": "POST",
                                                    "headers": {
                                                        "Content-Type": "application/json"
                                                    },
                                                    "body": {
                                                        "displayName": "@{concat(outputs('Generate_Test_GroupNames')['memberGroup'], '-Remove')}",
                                                        "description": "@{parameters('defaultGroupProperties')['description']}",
                                                        "mailEnabled": "@parameters('defaultGroupProperties')['mailEnabled']",
                                                        "mailNickname": "@{replace(concat(outputs('Generate_Test_GroupNames')['memberGroup'], 'Remove'), '-', '')}",
                                                        "securityEnabled": "@parameters('defaultGroupProperties')['securityEnabled']",
                                                        "groupTypes": "@parameters('defaultGroupProperties')['groupTypes']",
                                                        "isAssignableToRole": "@parameters('defaultGroupProperties')['isAssignableToRole']",
                                                        "visibility": "@{parameters('defaultGroupProperties')['visibility']}"
                                                    },
                                                    "authentication": {
                                                        "type": "ManagedServiceIdentity",
                                                        "audience": "https://graph.microsoft.com/"
                                                    }
                                                }
                                            },
                                            "Remove_Step1_Check_Group_Exists": {
                                                "type": "Http",
                                                "inputs": {
                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', outputs('Generate_Test_GroupNames')['memberGroup'], '-Remove%22')}",
                                                    "method": "GET",
                                                    "headers": {
                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                        "Accept": "@{parameters('scimContentType')}"
                                                    }
                                                }
                                            }
                                        },
                                        "type": "Scope"
                                    },
                                    "Remove_Member_Analyze_Group_Create_Provisioning_Results": {
                                        "runAfter": {
                                            "Remove_Member_Test_-_Verify_Creation_And_Provisioning": [
                                                "Succeeded",
                                                "Failed",
                                                "TimedOut"
                                            ],
                                            "Capture_RemoveMember_CreatePhase_Failed_Actions": [
                                                "Succeeded",
                                                "Skipped"
                                            ],
                                            "Set_RemoveMember_CreatePhase_Status_Success": [
                                                "Succeeded",
                                                "Skipped"
                                            ]
                                        },
                                        "type": "Compose",
                                        "inputs": {
                                            "provisioningStatus": "@concat('Group: ', if(greater(length(coalesce(body('Remove_Member_Verify_Group_Create_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Remove_Member_Verify_Group_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS'), ', User: ', if(greater(length(coalesce(body('Remove_Member_Verify_User_Create_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Remove_Member_Verify_User_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS'))",
                                            "provisioningResult": "@if(equals(variables('RemoveMemberScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Remove_Member_Verify_Group_Create_Provisioning_Logs')?['value'], json('[]'))), 0), greater(length(coalesce(body('Remove_Member_Verify_User_Create_Provisioning_Logs')?['value'], json('[]'))), 0)), concat('Group: ', coalesce(first(body('Remove_Member_Verify_Group_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), ', User: ', coalesce(first(body('Remove_Member_Verify_User_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN')), 'PROVISIONING_LOGS_MISSING'), concat('Failed Action: ', variables('RemoveMemberFailedActionName')))",
                                            "provisioningErrorDetails": "@if(equals(variables('RemoveMemberScopeExecutionStatus'), 'Succeeded'), if(or(and(greater(length(coalesce(body('Remove_Member_Verify_Group_Create_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Remove_Member_Verify_Group_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), and(greater(length(coalesce(body('Remove_Member_Verify_User_Create_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Remove_Member_Verify_User_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure'))), json(concat('{\"group\":', string(coalesce(first(body('Remove_Member_Verify_Group_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null)), ',\"user\":', string(coalesce(first(body('Remove_Member_Verify_User_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null)), '}')), null), variables('RemoveMemberFailedActionResponse'))",
                                            "overallResult": "@if(equals(variables('RemoveMemberScopeExecutionStatus'), 'Succeeded'), if(and(and(greater(length(coalesce(body('Remove_Member_Verify_Group_Create_Provisioning_Logs')?['value'], json('[]'))), 0), greater(length(coalesce(body('Remove_Member_Verify_User_Create_Provisioning_Logs')?['value'], json('[]'))), 0)), and(equals(toLower(coalesce(first(body('Remove_Member_Verify_Group_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success'), equals(toLower(coalesce(first(body('Remove_Member_Verify_User_Create_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success'))), 'PASSED', 'FAILED'), 'FAILED')"
                                        }
                                    },
                                    "Remove_Member_Check_Create_Phase_Status": {
                                        "actions": {
                                            "Remove_Member_Verify_Update_And_Provisioning": {
                                                "actions": {
                                                    "Remove_Step5_Remove_User_From_Group": {
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "https://graph.microsoft.com/beta/groups/@{body('Remove_Step2_Create_Group')?['id']}/members/@{body('Remove_Step3_Create_Member_User')?['id']}/$ref",
                                                            "method": "DELETE",
                                                            "authentication": {
                                                                "type": "ManagedServiceIdentity",
                                                                "audience": "https://graph.microsoft.com/"
                                                            }
                                                        }
                                                    },
                                                    "Remove_DoUntil_Wait_For_Member_Removal": {
                                                        "actions": {
                                                            "Remove_Step6_Query_Group_After_Remove": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', outputs('Generate_Test_GroupNames')['memberGroup'], '-Remove%22')}",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                        "Accept": "@{parameters('scimContentType')}"
                                                                    }
                                                                }
                                                            },
                                                            "Remove_Delay_Final_15s": {
                                                                "runAfter": {
                                                                    "Remove_Step6_Query_Group_After_Remove": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Remove_Step5_Remove_User_From_Group": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "expression": "@and(greater(length(coalesce(body('Remove_Step6_Query_Group_After_Remove')?['Resources'], json('[]'))), 0), and(not(empty(first(coalesce(body('Remove_Step4b_Check_User')?['Resources'], json('[]'))))), not(contains(string(body('Remove_Step6_Query_Group_After_Remove')), coalesce(first(coalesce(body('Remove_Step4b_Check_User')?['Resources'], json('[]')))?['id'], '')))))",
                                                        "limit": {
                                                            "count": 150,
                                                            "timeout": "PT40M"
                                                        },
                                                        "type": "Until"
                                                    },
                                                    "Remove_Step7_Query_Group_By_Id": {
                                                        "runAfter": {
                                                            "Remove_DoUntil_Wait_For_Member_Removal": [
                                                                "Succeeded",
                                                                "TimedOut",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "type": "Http",
                                                        "inputs": {
                                                            "uri": "@{concat(parameters('scimEndpoint'), '/Groups?filter=displayName%20eq%20%22', concat(outputs('Generate_Test_GroupNames')['memberGroup'], '-Remove'), '%22')}",
                                                            "method": "GET",
                                                            "headers": {
                                                                "Authorization": "@{concat('Bearer ', parameters('scimBearerToken'))}",
                                                                "Accept": "@{parameters('scimContentType')}"
                                                            }
                                                        }
                                                    },
                                                    "Remove_Member_DoUntil_Poll_Remove_Member_Provisioning_Logs": {
                                                        "actions": {
                                                            "Remove_Member_Verify_Remove_Member_Provisioning_Logs": {
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "uri": "@{concat('https://graph.microsoft.com/beta/auditLogs/provisioning?$filter=jobId%20eq%20%27', outputs('Compose_SyncJobId'), '%27%20and%20servicePrincipal/id%20eq%20%27', parameters('servicePrincipalId'), '%27%20and%20sourceIdentity/id%20eq%20%27', body('Remove_Step2_Create_Group')?['id'], '%27%20and%20provisioningAction%20eq%20%27Update%27%20and%20modifiedProperties/any(p:%20p/displayName%20eq%20%27members%27)&$orderby=activityDateTime%20desc&$top=1')}",
                                                                    "method": "GET",
                                                                    "headers": {
                                                                        "Accept": "application/json"
                                                                    },
                                                                    "authentication": {
                                                                        "type": "ManagedServiceIdentity",
                                                                        "audience": "https://graph.microsoft.com/"
                                                                    }
                                                                }
                                                            },
                                                            "Remove_Member_Delay_Remove_Member_Provisioning_Logs_15s": {
                                                                "runAfter": {
                                                                    "Remove_Member_Verify_Remove_Member_Provisioning_Logs": [
                                                                        "Succeeded",
                                                                        "Failed"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 15,
                                                                        "unit": "Second"
                                                                    }
                                                                }
                                                            }
                                                        },
                                                        "runAfter": {
                                                            "Remove_Step7_Query_Group_By_Id": [
                                                                "Succeeded",
                                                                "Failed"
                                                            ]
                                                        },
                                                        "expression": "@and(greater(length(coalesce(body('Remove_Member_Verify_Remove_Member_Provisioning_Logs')?['value'], json('[]'))), 0), and(not(empty(first(body('Remove_Member_Verify_Remove_Member_Provisioning_Logs')?['value'])?['modifiedProperties'][0]?['oldValue'])), empty(first(body('Remove_Member_Verify_Remove_Member_Provisioning_Logs')?['value'])?['modifiedProperties'][0]?['newValue'])))",
                                                        "limit": {
                                                            "count": 140,
                                                            "timeout": "PT15M"
                                                        },
                                                        "type": "Until"
                                                    }
                                                },
                                                "type": "Scope"
                                            },
                                            "Capture_RemoveMember_RemoveMemberPhase_Failed_Actions": {
                                                "actions": {
                                                    "Get_Failed_RemoveMember_RemoveMemberPhase_Actions": {
                                                        "type": "Compose",
                                                        "inputs": "@result('Remove_Member_Verify_Update_And_Provisioning')"
                                                    },
                                                    "Filter_Failed_RemoveMember_RemoveMemberPhase_Actions": {
                                                        "runAfter": {
                                                            "Get_Failed_RemoveMember_RemoveMemberPhase_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "Query",
                                                        "inputs": {
                                                            "from": "@outputs('Get_Failed_RemoveMember_RemoveMemberPhase_Actions')",
                                                            "where": "@or(equals(item()?['status'], 'Failed'), equals(item()?['status'], 'TimedOut'))"
                                                        }
                                                    },
                                                    "Set_RemoveMember_RemoveMemberPhase_Failed_Action_Name": {
                                                        "runAfter": {
                                                            "Filter_Failed_RemoveMember_RemoveMemberPhase_Actions": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "RemoveMemberFailedActionName",
                                                            "value": "@{coalesce(first(body('Filter_Failed_RemoveMember_RemoveMemberPhase_Actions'))?['name'], 'Unknown')}"
                                                        }
                                                    },
                                                    "Set_RemoveMember_RemoveMemberPhase_Failed_Action_Response": {
                                                        "runAfter": {
                                                            "Set_RemoveMember_RemoveMemberPhase_Failed_Action_Name": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "RemoveMemberFailedActionResponse",
                                                            "value": "@if(greater(length(body('Filter_Failed_RemoveMember_RemoveMemberPhase_Actions')), 0), coalesce(first(body('Filter_Failed_RemoveMember_RemoveMemberPhase_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                        }
                                                    },
                                                    "Set_RemoveMember_RemoveMemberPhase_Status_Failed": {
                                                        "runAfter": {
                                                            "Set_RemoveMember_RemoveMemberPhase_Failed_Action_Response": [
                                                                "Succeeded"
                                                            ]
                                                        },
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "RemoveMemberScopeExecutionStatus",
                                                            "value": "Failed"
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Remove_Member_Verify_Update_And_Provisioning": [
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            },
                                            "Set_RemoveMember_UpdatePhase_Status_Success": {
                                                "runAfter": {
                                                    "Remove_Member_Verify_Update_And_Provisioning": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "RemoveMemberScopeExecutionStatus",
                                                    "value": "Succeeded"
                                                }
                                            },
                                            "Remove_Member_Analyze_Remove_Member_Provisioning_Results": {
                                                "runAfter": {
                                                    "Remove_Member_Verify_Update_And_Provisioning": [
                                                        "Succeeded",
                                                        "Failed",
                                                        "TimedOut"
                                                    ],
                                                    "Capture_RemoveMember_RemoveMemberPhase_Failed_Actions": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ],
                                                    "Set_RemoveMember_UpdatePhase_Status_Success": [
                                                        "Succeeded",
                                                        "Skipped"
                                                    ]
                                                },
                                                "type": "Compose",
                                                "inputs": {
                                                    "provisioningLogsCount": "@length(coalesce(body('Remove_Member_Verify_Remove_Member_Provisioning_Logs')?['value'], json('[]')))",
                                                    "hasProvisioningLogs": "@greater(length(coalesce(body('Remove_Member_Verify_Remove_Member_Provisioning_Logs')?['value'], json('[]'))), 0)",
                                                    "provisioningStatus": "@if(equals(variables('RemoveMemberScopeExecutionStatus'), 'Failed'), 'FAILED', if(greater(length(coalesce(body('Remove_Member_Verify_Remove_Member_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Remove_Member_Verify_Remove_Member_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'))",
                                                    "provisioningResult": "@if(equals(variables('RemoveMemberScopeExecutionStatus'), 'Succeeded'), if(greater(length(coalesce(body('Remove_Member_Verify_Remove_Member_Provisioning_Logs')?['value'], json('[]'))), 0), coalesce(first(body('Remove_Member_Verify_Remove_Member_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], 'UNKNOWN'), 'NO_LOGS_FOUND'), concat('Failed Action: ', variables('RemoveMemberFailedActionName')))",
                                                    "provisioningErrorDetails": "@if(equals(variables('RemoveMemberScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Remove_Member_Verify_Remove_Member_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(first(body('Remove_Member_Verify_Remove_Member_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status']), 'failure')), first(body('Remove_Member_Verify_Remove_Member_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['errorInformation'], null), variables('RemoveMemberFailedActionResponse'))",
                                                    "overallResult": "@if(equals(variables('RemoveMemberScopeExecutionStatus'), 'Succeeded'), if(and(greater(length(coalesce(body('Remove_Member_Verify_Remove_Member_Provisioning_Logs')?['value'], json('[]'))), 0), equals(toLower(coalesce(first(body('Remove_Member_Verify_Remove_Member_Provisioning_Logs')?['value'])?['provisioningStatusInfo']?['status'], '')), 'success')), 'PASSED', 'FAILED'), 'FAILED')"
                                                }
                                            },
                                            "Set_RemoveMember_UpdatePhase_Output_Variables": {
                                                "actions": {
                                                    "Set_RemoveMemberTestOutputs_UpdatePhase": {
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "RemoveMemberTestOutputs",
                                                            "value": {
                                                                "overallResult": "@outputs('Remove_Member_Analyze_Remove_Member_Provisioning_Results')?['overallResult']",
                                                                "result": "@outputs('Remove_Member_Analyze_Remove_Member_Provisioning_Results')?['provisioningResult']",
                                                                "errorDetails": "@outputs('Remove_Member_Analyze_Remove_Member_Provisioning_Results')?['provisioningErrorDetails']"
                                                            }
                                                        }
                                                    }
                                                },
                                                "runAfter": {
                                                    "Remove_Member_Analyze_Remove_Member_Provisioning_Results": [
                                                        "Succeeded",
                                                        "Failed"
                                                    ]
                                                },
                                                "type": "Scope"
                                            }
                                        },
                                        "runAfter": {
                                            "Set_RemoveMemberCreatePhase_Output_Variables": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped"
                                            ]
                                        },
                                        "else": {
                                            "actions": {}
                                        },
                                        "expression": {
                                            "and": [
                                                {
                                                    "equals": [
                                                        "@variables('RemoveMemberTestOutputs')['overallResult']",
                                                        "PASSED"
                                                    ]
                                                }
                                            ]
                                        },
                                        "type": "If"
                                    },
                                    "Remove_Cleanup_Delete_User": {
                                        "runAfter": {
                                            "Remove_Member_Check_Create_Phase_Status": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped",
                                                "TimedOut"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "https://graph.microsoft.com/beta/users/@{body('Remove_Step3_Create_Member_User')?['id']}",
                                            "method": "DELETE",
                                            "authentication": {
                                                "type": "ManagedServiceIdentity",
                                                "audience": "https://graph.microsoft.com/"
                                            }
                                        }
                                    },
                                    "Remove_Cleanup_Delete_Group": {
                                        "runAfter": {
                                            "Remove_Cleanup_Delete_User": [
                                                "Succeeded",
                                                "Failed",
                                                "Skipped"
                                            ]
                                        },
                                        "type": "Http",
                                        "inputs": {
                                            "uri": "https://graph.microsoft.com/beta/groups/@{body('Remove_Step2_Create_Group')?['id']}",
                                            "method": "DELETE",
                                            "authentication": {
                                                "type": "ManagedServiceIdentity",
                                                "audience": "https://graph.microsoft.com/"
                                            }
                                        }
                                    },
                                    "Capture_RemoveMember_CreatePhase_Failed_Actions": {
                                        "actions": {
                                            "Get_Failed_RemoveMember_CreatePhase_Actions": {
                                                "type": "Compose",
                                                "inputs": "@result('Remove_Member_Test_-_Verify_Creation_And_Provisioning')"
                                            },
                                            "Filter_Failed_RemoveMember_CreatePhase_Actions": {
                                                "runAfter": {
                                                    "Get_Failed_RemoveMember_CreatePhase_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Query",
                                                "inputs": {
                                                    "from": "@outputs('Get_Failed_RemoveMember_CreatePhase_Actions')",
                                                    "where": "@or(equals(item()?['status'], 'Failed'), equals(item()?['status'], 'TimedOut'))"
                                                }
                                            },
                                            "Set_RemoveMember_CreatePhase_Failed_Action_Name": {
                                                "runAfter": {
                                                    "Filter_Failed_RemoveMember_CreatePhase_Actions": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "RemoveMemberFailedActionName",
                                                    "value": "@{coalesce(first(body('Filter_Failed_RemoveMember_CreatePhase_Actions'))?['name'], 'Unknown')}"
                                                }
                                            },
                                            "Set_RemoveMember_CreatePhase_Failed_Action_Response": {
                                                "runAfter": {
                                                    "Set_RemoveMember_CreatePhase_Failed_Action_Name": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "RemoveMemberFailedActionResponse",
                                                    "value": "@if(greater(length(body('Filter_Failed_RemoveMember_CreatePhase_Actions')), 0), coalesce(first(body('Filter_Failed_RemoveMember_CreatePhase_Actions'))?['outputs'], json('{}')), json('{}'))"
                                                }
                                            },
                                            "Set_RemoveMember_CreatePhase_Status_Failed": {
                                                "runAfter": {
                                                    "Set_RemoveMember_CreatePhase_Failed_Action_Response": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "RemoveMemberScopeExecutionStatus",
                                                    "value": "Failed"
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Remove_Member_Test_-_Verify_Creation_And_Provisioning": [
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    },
                                    "Set_RemoveMember_CreatePhase_Status_Success": {
                                        "runAfter": {
                                            "Remove_Member_Test_-_Verify_Creation_And_Provisioning": [
                                                "Succeeded"
                                            ]
                                        },
                                        "type": "SetVariable",
                                        "inputs": {
                                            "name": "RemoveMemberScopeExecutionStatus",
                                            "value": "Succeeded"
                                        }
                                    },
                                    "Set_RemoveMemberCreatePhase_Output_Variables": {
                                        "actions": {
                                            "Set_RemoveMemberTestOutputs_CreatePhase": {
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "RemoveMemberTestOutputs",
                                                    "value": {
                                                        "overallResult": "@outputs('Remove_Member_Analyze_Group_Create_Provisioning_Results')?['overallResult']",
                                                        "result": "@outputs('Remove_Member_Analyze_Group_Create_Provisioning_Results')?['provisioningResult']",
                                                        "errorDetails": "@outputs('Remove_Member_Analyze_Group_Create_Provisioning_Results')?['provisioningErrorDetails']"
                                                    }
                                                }
                                            }
                                        },
                                        "runAfter": {
                                            "Remove_Member_Analyze_Group_Create_Provisioning_Results": [
                                                "Succeeded",
                                                "Failed"
                                            ]
                                        },
                                        "type": "Scope"
                                    }
                                },
                                "type": "Scope"
                            }
                        },
                        "else": {
                            "actions": {}
                        },
                        "expression": {
                            "or": [
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "All"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "GroupTests"
                                    ]
                                },
                                {
                                    "equals": [
                                        "@parameters('EnabledTests')",
                                        "Group_Update_Remove_Member_Test"
                                    ]
                                }
                            ]
                        },
                        "type": "If"
                    }
                },
                "runAfter": {
                    "Initialize_All_Group_Test_Variables": [
                        "Succeeded"
                    ]
                },
                "type": "Scope"
            },
            "Initialize_All_User_Test_Variables": {
                "runAfter": {
                    "Process_Template_Mappings": [
                        "Succeeded"
                    ]
                },
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "CreateUserFailedActionName",
                            "type": "string",
                            "value": ""
                        },
                        {
                            "name": "CreateUserFailedActionResponse",
                            "type": "Object",
                            "value": {}
                        },
                        {
                            "name": "CreateUserScopeExecutionStatus",
                            "type": "string",
                            "value": "InProgress"
                        },
                        {
                            "name": "CreateUserTestOutputs",
                            "type": "Object",
                            "value": {
                                "overallResult": "",
                                "result": "",
                                "errorDetails": {}
                            }
                        },
                        {
                            "name": "UpdateUserFailedActionName",
                            "type": "string",
                            "value": ""
                        },
                        {
                            "name": "UpdateUserFailedActionResponse",
                            "type": "Object",
                            "value": {}
                        },
                        {
                            "name": "UpdateUserScopeExecutionStatus",
                            "type": "string",
                            "value": "InProgress"
                        },
                        {
                            "name": "UpdateUserTestOutputs",
                            "type": "Object",
                            "value": {
                                "overallResult": "",
                                "result": "",
                                "errorDetails": {}
                            }
                        },
                        {
                            "name": "DisableUserFailedActionName",
                            "type": "string",
                            "value": ""
                        },
                        {
                            "name": "DisableUserFailedActionResponse",
                            "type": "Object",
                            "value": {}
                        },
                        {
                            "name": "DisableUserScopeExecutionStatus",
                            "type": "string",
                            "value": "InProgress"
                        },
                        {
                            "name": "DisableUserTestOutputs",
                            "type": "Object",
                            "value": {
                                "overallResult": "",
                                "result": "",
                                "errorDetails": {}
                            }
                        },
                        {
                            "name": "DeleteUserFailedActionName",
                            "type": "string",
                            "value": ""
                        },
                        {
                            "name": "DeleteUserFailedActionResponse",
                            "type": "Object",
                            "value": {}
                        },
                        {
                            "name": "DeleteUserScopeExecutionStatus",
                            "type": "string",
                            "value": "InProgress"
                        },
                        {
                            "name": "DeleteUserTestOutputs",
                            "type": "Object",
                            "value": {
                                "overallResult": "",
                                "result": "",
                                "errorDetails": {}
                            }
                        },
                        {
                            "name": "ManagerTestFailedActionName",
                            "type": "string",
                            "value": ""
                        },
                        {
                            "name": "ManagerTestFailedActionResponse",
                            "type": "Object",
                            "value": {}
                        },
                        {
                            "name": "ManagerTestScopeExecutionStatus",
                            "type": "string",
                            "value": "InProgress"
                        },
                        {
                            "name": "ManagerTestOutputs",
                            "type": "Object",
                            "value": {
                                "overallResult": "",
                                "result": "",
                                "errorDetails": {}
                            }
                        }
                    ]
                }
            },
            "Initialize_All_Group_Test_Variables": {
                "runAfter": {
                    "Initialize_All_User_Test_Variables": [
                        "Succeeded"
                    ]
                },
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "CreateGroupFailedActionName",
                            "type": "string",
                            "value": ""
                        },
                        {
                            "name": "CreateGroupFailedActionResponse",
                            "type": "Object",
                            "value": {}
                        },
                        {
                            "name": "CreateGroupScopeExecutionStatus",
                            "type": "string",
                            "value": "InProgress"
                        },
                        {
                            "name": "UpdateGroupFailedActionName",
                            "type": "string",
                            "value": ""
                        },
                        {
                            "name": "UpdateGroupFailedActionResponse",
                            "type": "Object",
                            "value": {}
                        },
                        {
                            "name": "UpdateGroupScopeExecutionStatus",
                            "type": "string",
                            "value": "InProgress"
                        },
                        {
                            "name": "DeleteGroupFailedActionName",
                            "type": "string",
                            "value": ""
                        },
                        {
                            "name": "DeleteGroupFailedActionResponse",
                            "type": "Object",
                            "value": {}
                        },
                        {
                            "name": "DeleteGroupScopeExecutionStatus",
                            "type": "string",
                            "value": "InProgress"
                        },
                        {
                            "name": "AddMemberFailedActionName",
                            "type": "string",
                            "value": ""
                        },
                        {
                            "name": "AddMemberFailedActionResponse",
                            "type": "Object",
                            "value": {}
                        },
                        {
                            "name": "AddMemberScopeExecutionStatus",
                            "type": "string",
                            "value": "InProgress"
                        },
                        {
                            "name": "RemoveMemberFailedActionName",
                            "type": "string",
                            "value": ""
                        },
                        {
                            "name": "RemoveMemberFailedActionResponse",
                            "type": "Object",
                            "value": {}
                        },
                        {
                            "name": "RemoveMemberScopeExecutionStatus",
                            "type": "string",
                            "value": "InProgress"
                        },
                        {
                            "name": "RemoveMemberTestOutputs",
                            "type": "Object",
                            "value": {
                                "overallResult": "",
                                "result": "",
                                "errorDetails": {}
                            }
                        },
                        {
                            "name": "CreateGroupTestOutputs",
                            "type": "Object",
                            "value": {
                                "overallResult": "",
                                "result": "",
                                "errorDetails": {}
                            }
                        },
                        {
                            "name": "UpdateGroupTestOutputs",
                            "type": "Object",
                            "value": {
                                "overallResult": "",
                                "result": "",
                                "errorDetails": {}
                            }
                        },
                        {
                            "name": "DeleteGroupTestOutputs",
                            "type": "Object",
                            "value": {
                                "overallResult": "",
                                "result": "",
                                "errorDetails": {}
                            }
                        },
                        {
                            "name": "AddMemberTestOutputs",
                            "type": "Object",
                            "value": {
                                "overallResult": "",
                                "result": "",
                                "errorDetails": {}
                            }
                        }
                    ]
                }
            },
            "Parse_Templates": {
                "runAfter": {
                    "Check_Enabled_Tests": [
                        "Succeeded"
                    ]
                },
                "type": "ParseJson",
                "inputs": {
                    "content": "@body('Get_Templates')",
                    "schema": {
                        "type": "object",
                        "properties": {
                            "value": {
                                "type": "array",
                                "items": {
                                    "type": "object",
                                    "properties": {
                                        "id": {
                                            "type": "string"
                                        },
                                        "synchronizationRules": {
                                            "type": "array",
                                            "items": {
                                                "type": "object",
                                                "properties": {
                                                    "id": {
                                                        "type": "string"
                                                    },
                                                    "objectMappings": {
                                                        "type": "array",
                                                        "items": {
                                                            "type": "object",
                                                            "properties": {
                                                                "sourceDirectoryName": {
                                                                    "type": "string"
                                                                },
                                                                "targetDirectoryName": {
                                                                    "type": "string"
                                                                },
                                                                "sourceObjectName": {
                                                                    "type": "string"
                                                                },
                                                                "targetObjectName": {
                                                                    "type": "string"
                                                                },
                                                                "attributeMappings": {
                                                                    "type": "array",
                                                                    "items": {
                                                                        "type": "object",
                                                                        "properties": {
                                                                            "targetAttributeName": {
                                                                                "type": "string"
                                                                            },
                                                                            "source": {
                                                                                "type": "object",
                                                                                "properties": {
                                                                                    "name": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "expression": {
                                                                                        "type": "string"
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            },
            "Process_Template_Mappings": {
                "actions": {
                    "ForEach_Templates": {
                        "foreach": "@coalesce(body('Parse_Templates')?['value'], json('[]'))",
                        "actions": {
                            "Compose_Current_Template": {
                                "type": "Compose",
                                "inputs": "@item()"
                            },
                            "ForEach_Rules": {
                                "foreach": "@coalesce(item()?['schema']['synchronizationRules'], json('[]'))",
                                "actions": {
                                    "ForEach_ObjectMappings": {
                                        "foreach": "@coalesce(item()?['objectMappings'], json('[]'))",
                                        "actions": {
                                            "If_TargetObject_Is_Enterprise_User": {
                                                "actions": {
                                                    "ForEach_AttributeMappings": {
                                                        "foreach": "@coalesce(items('ForEach_ObjectMappings')?['attributeMappings'], json('[]'))",
                                                        "actions": {
                                                            "If_TargetAttribute_Present": {
                                                                "actions": {
                                                                    "Append_Mapping": {
                                                                        "type": "AppendToArrayVariable",
                                                                        "inputs": {
                                                                            "name": "mappedSources",
                                                                            "value": {
                                                                                "source": "@coalesce(items('ForEach_AttributeMappings')?['source']?['name'], items('ForEach_AttributeMappings')?['source']?['expression'])",
                                                                                "target": "@items('ForEach_AttributeMappings')?['targetAttributeName']",
                                                                                "sourceObject": "@coalesce(items('ForEach_ObjectMappings')?['sourceObjectName'], '')",
                                                                                "targetObject": "@coalesce(items('ForEach_ObjectMappings')?['targetObjectName'], '')",
                                                                                "sourceDirectoryName": "@coalesce(items('ForEach_ObjectMappings')?['sourceDirectoryName'], '')",
                                                                                "targetDirectoryName": "@coalesce(items('ForEach_ObjectMappings')?['targetDirectoryName'], '')",
                                                                                "mappingType": "@coalesce(items('ForEach_AttributeMappings')?['source']['type'], '')"
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "else": {
                                                                    "actions": {}
                                                                },
                                                                "expression": {
                                                                    "and": [
                                                                        {
                                                                            "not": {
                                                                                "equals": [
                                                                                    "@items('ForEach_AttributeMappings')?['targetAttributeName']",
                                                                                    null
                                                                                ]
                                                                            }
                                                                        },
                                                                        {
                                                                            "not": {
                                                                                "equals": [
                                                                                    "@items('ForEach_AttributeMappings')?['targetAttributeName']",
                                                                                    ""
                                                                                ]
                                                                            }
                                                                        }
                                                                    ]
                                                                },
                                                                "type": "If"
                                                            }
                                                        },
                                                        "type": "Foreach"
                                                    }
                                                },
                                                "else": {
                                                    "actions": {}
                                                },
                                                "expression": {
                                                    "and": [
                                                        {
                                                            "equals": [
                                                                "@items('ForEach_ObjectMappings')?['targetObjectName']",
                                                                "urn:ietf:params:scim:schemas:extension:enterprise:2.0:User"
                                                            ]
                                                        }
                                                    ]
                                                },
                                                "type": "If"
                                            }
                                        },
                                        "type": "Foreach"
                                    }
                                },
                                "runAfter": {
                                    "Compose_Current_Template": [
                                        "Succeeded"
                                    ]
                                },
                                "type": "Foreach"
                            }
                        },
                        "type": "Foreach"
                    },
                    "Compose_MappedSources_Result": {
                        "runAfter": {
                            "ForEach_Templates": [
                                "Succeeded"
                            ]
                        },
                        "type": "Compose",
                        "inputs": "@union(variables('mappedSources'), json('[]'))"
                    },
                    "Filter_Direct_Mappings": {
                        "runAfter": {
                            "Compose_MappedSources_Result": [
                                "Succeeded"
                            ]
                        },
                        "type": "Query",
                        "inputs": {
                            "from": "@outputs('Compose_MappedSources_Result')",
                            "where": "@not(equals(item()?['mappingType'], 'function'))"
                        }
                    },
                    "Select_Graph_Property_Names": {
                        "runAfter": {
                            "Filter_Direct_Mappings": [
                                "Succeeded"
                            ]
                        },
                        "type": "Select",
                        "inputs": {
                            "from": "@body('Filter_Direct_Mappings')",
                            "select": "@item()?['source']"
                        }
                    }
                },
                "runAfter": {
                    "Initialize_MappedSources": [
                        "Succeeded"
                    ]
                },
                "type": "Scope"
            },
            "Initialize_MappedSources": {
                "runAfter": {
                    "Parse_Templates": [
                        "Succeeded"
                    ]
                },
                "type": "InitializeVariable",
                "inputs": {
                    "variables": [
                        {
                            "name": "mappedSources",
                            "type": "Array",
                            "value": []
                        }
                    ]
                }
            }
        },
        "outputs": {},
        "parameters": {
            "servicePrincipalId": {
                "defaultValue": "{default}",
                "type": "String"
            },
            "scimEndpoint": {
                "defaultValue": "{default}",
                "type": "String"
            },
            "scimBearerToken": {
                "defaultValue": "12345",
                "type": "SecureString",
                "metadata": {
                    "description": "Bearer token for SCIM API authentication"
                }
            },
            "testUserDomain": {
                "defaultValue": "proviamtest05.onmicrosoft.com",
                "type": "String"
            },
            "templateId": {
                "defaultValue": "scim",
                "type": "String"
            },
            "EnabledTests": {
                "defaultValue": "All",
                "allowedValues": [
                    "All",
                    "UserTests",
                    "GroupTests",
                    "Create_User_Test",
                    "Update_User_Test",
                    "Disable_User_Test",
                    "User_Update_Manager_Test",
                    "Create_Group_Test",
                    "Update_Group_Test",
                    "Delete_Group_Test",
                    "Group_Update_Add_Member_Test",
                    "Group_Update_Remove_Member_Test"
                ],
                "type": "String"
            },
            "defaultUserProperties": {
                "defaultValue": [
                    {
                        "displayName": "Test User",
                        "mailNickname": "testuser",
                        "passwordProfile": {
                            "forceChangePasswordNextSignIn": true,
                            "password": "Pass@word123"
                        },
                        "givenName": "Test",
                        "surname": "User",
                        "jobTitle": "Software Engineer",
                        "department": "Consulting",
                        "companyName": "Test Company",
                        "businessPhones": [
                            "+1-555-0100"
                        ],
                        "mobilePhone": "+1-555-0101",
                        "faxNumber": "+1-555-0102",
                        "officeLocation": "Building A, Floor 3",
                        "preferredLanguage": "en-US",
                        "employeeType": "Employee",
                        "employeeId": "E12345",
                        "streetAddress": "123 Test Street",
                        "city": "Seattle",
                        "state": "WA",
                        "country": "IN",
                        "postalCode": "98101",
                        "usageLocation": "US",
                        "hireDate": "2023-01-01T00:00:00Z",
                        "employeeOrgData": {
                            "division": "Engineering",
                            "costCenter": "12345"
                        },
                        "userType": "Member",
                        "otherMails": []
                    },
                    {
                        "displayName": "Updated User",
                        "mailNickname": "testuser",
                        "passwordProfile": {
                            "forceChangePasswordNextSignIn": true,
                            "password": "Pass@word123"
                        },
                        "givenName": "Test",
                        "surname": "User",
                        "jobTitle": "Software Dev Engineer",
                        "department": "HR",
                        "companyName": "Test Company",
                        "businessPhones": [
                            "+1-555-2001"
                        ],
                        "mobilePhone": "+1-555-0120",
                        "faxNumber": "+1-555-0102",
                        "officeLocation": "Building A, Floor 3",
                        "preferredLanguage": "en-US",
                        "employeeType": "Employee",
                        "employeeId": "E12345",
                        "streetAddress": "240 East 24th Ave",
                        "city": "Sanjose",
                        "state": "CA",
                        "country": "US",
                        "postalCode": "98101",
                        "usageLocation": "US",
                        "hireDate": "2023-01-01T00:00:00Z",
                        "employeeOrgData": {
                            "division": "Legal",
                            "costCenter": "12345"
                        },
                        "userType": "Member",
                        "otherMails": []
                    },
                    {
                        "displayName": "Test USer",
                        "mailNickname": "testuser",
                        "passwordProfile": {
                            "forceChangePasswordNextSignIn": true,
                            "password": "Pass@word123"
                        },
                        "givenName": "Test Given",
                        "surname": "User",
                        "jobTitle": "Research Scientist",
                        "department": "Research",
                        "companyName": "Test Company",
                        "businessPhones": [
                            "+1-555-2001"
                        ],
                        "mobilePhone": "+1-555-0120",
                        "faxNumber": "+1-555-0102",
                        "officeLocation": "Building A, Floor 3",
                        "preferredLanguage": "en-US",
                        "employeeType": "Employee",
                        "employeeId": "E12345",
                        "streetAddress": "240 East 24th Ave",
                        "city": "Delhi",
                        "state": "DL",
                        "country": "IN",
                        "postalCode": "98101",
                        "usageLocation": "IN",
                        "hireDate": "2023-01-01T00:00:00Z",
                        "employeeOrgData": {
                            "division": "Engineeering",
                            "costCenter": "67463"
                        },
                        "userType": "Member",
                        "otherMails": []
                    }
                ],
                "type": "Array",
                "metadata": {
                    "description": "Combined default user properties for Microsoft Graph User creation"
                }
            },
            "defaultPassword": {
                "defaultValue": "Pa$$w0rd12345!",
                "type": "SecureString",
                "metadata": {
                    "description": "Default password for test users (must meet complexity requirements)"
                }
            },
            "forcePasswordChange": {
                "defaultValue": true,
                "type": "Bool",
                "metadata": {
                    "description": "Whether users must change password on first sign-in"
                }
            },
            "IsSoftDeleted": {
                "defaultValue": true,
                "type": "Bool",
                "metadata": {
                    "description": "If true, user will be disabled (soft delete). If false, user will be deleted (hard delete)."
                }
            },
            "scimContentType": {
                "defaultValue": "application/scim+json",
                "type": "String",
                "metadata": {
                    "description": "Content-Type header for SCIM API calls"
                }
            },
            "defaultGroupProperties": {
                "defaultValue": {
                    "description": "Default test group for provisioning validation",
                    "mailEnabled": false,
                    "securityEnabled": true,
                    "groupTypes": [],
                    "allowExternalSenders": false,
                    "autoSubscribeNewMembers": false,
                    "classification": "",
                    "hideFromAddressLists": false,
                    "hideFromOutlookClients": false,
                    "isAssignableToRole": false,
                    "isSubscribedByMail": false,
                    "preferredDataLocation": "US",
                    "preferredLanguage": "en-US",
                    "theme": "Blue",
                    "visibility": "Private"
                },
                "type": "Object",
                "metadata": {
                    "description": "Default group properties for Microsoft Graph Group creation"
                }
            },
            "$connections": {
                "type": "Object",
                "defaultValue": {}
            }
        }
    },
    "parameters": {
        "scimBearerToken": {},
        "defaultPassword": {},
        "$connections": {
            "type": "Object",
            "value": {}
        }
    }
}
